Add Deal:

@model BolDealsAdmin.Models.Deal
@{
    Layout = null;
}

<!doctype html>
<html>
<head>
    <meta charset="utf-8">

    <title>BOL Deals</title>
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <link rel="shortcut icon" href="~/Assets/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="~/Assets/images/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../assets/css/style.css">
    <script src="~/Assets/js/Helper.js"></script>
    <script src="~/Assets/js/knockout-3.1.0.debug.js"></script>
    <script src="~/Assets/js/knockout-3.1.0.js"></script>

</head>

<body>
    <style>
        .BorderRed {
            border-color: #c5171d !important;
            border: 1px solid #c5171d !important;
        }

        .NoBorder {
            border-color: #fff !important;
            border: 1px solid #fff !important;
        }

        .select2-container {
            width: 100% !important;
        }
    </style>
    <style>
        .text-red {
            color: #c5171d !important;
        }

        .imageThumb {
            /*max-height: 75px;*/
            /*border: 2px solid;*/
            padding: 1px;
            cursor: pointer;
            width: 92px;
            height: 92px;
        }

        .pip {
            display: inline-block;
            margin: 10px 10px 0 0;
        }

        .remove {
            display: block;
            background: #c5171d;
            /*border: 1px solid #c5171d;*/
            color: white;
            text-align: center;
            cursor: pointer;
        }

            .remove:hover {
                background: #edf0f0;
                color: #c5171d;
            }
        .file-upload ul li .loading {
            width: 83px;
            height: 7px;
            float: left;
            background: #edf0f0;
            position: relative;
            margin-top: 6px;
        }

          .file-upload ul li .loading span {
                width: 35%;
                height: 7px;
                float: none;
                position: absolute;
                top: 0px;
                left: 0px;
                background: #72d2a0;
            }

    </style>
    <!-- Header -->
    <noscript>
        <div id="jqcheck"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB60lEQVQ4T2NkwAHePzrxf3ebL1jWp/0oA5egGiM2pVgFQQq31uj/N/ANZvj+8T3D7aNHGDwbTxNvwKtbO/9f3dLHYJ+axfDn5w+GI/NnMRhFtTEISJtjGIIh8Pv39/87ak0ZzCLiGMRUNMCufnLxDMOlrZsY3JtOMrCwsKPowTDg3tGZ/59f2sVgFRvPkO+bAzZgwsZJDEcXzWNQtIlikDGIwG3Az+9v/+9qsGOwTc1h4JeQhhswcfMUhrcP7zEcXzyXwb3xMAMbuwDcEBTTzi7P/s/M8IFB3zccbDPMBSADQODs2sUMzFwyDIah/ZgGfHt/7/+BvmAGm+RsBl4RMawGfHr5jOHowlkMjiUbGDj55MCGwE060Of1X0RZi0Hb2Q4e3eguAElc2X2A4e2DmwwOhVsRBnx6cfH/yXm5DFZxyQxcAoJ4Dfj24T3DsUVzGcwSJjLwSxkygk3ZVmv4X805gkHZRBNXwkQRv3/+NsP1nUsYvFvOMzI+PLXo/73DSxgsouIYOHj5UBRi8wJIwY8vnxlOLV/CIGcewsC4vkDhv01yLoOIoiqG7bgMACn88Owxw8HpvQyMGwqV/vs19TMwQnxDEthYW8DAeGCC3/9XN46TpBGmWEzDkoHx06dP/z9//kyWAby8vAwAcza2SBMOSCMAAAAASUVORK5CYII=" alt="No Script" /> Javascript is disabled. Please enable it for better working experience.</div>
    </noscript>

    <div class="container-fluid AddDealVM">
        <div class="row">
            <div class="col-xs-2 ht lft-nav">
                <div class="row whitebg">
                    <div class="logo">
                        <figure>
                            <a href="../"><img src="../assets/images/logo.jpg" alt="Bol Deal" class="img-responsive"></a>
                        </figure>
                    </div>
                </div>

                <div class="row">
                    <ul>
                        <li><a href='@( Url.Action("ClientList", "Client"))'>Client</a></li>
                        <li><a class="active" href='@( Url.Action("DealList", "Deal"))'>Deal</a></li>  
                        <li><a style="text-decoration:none" href='@( Url.Action("MemberList", "Member"))'>Member</a></li>                    
                    </ul>
                </div>

            </div>

            <div class="col-xs-10 rht-nav">
                <div class="row">
                    @Html.Partial("_Header")
                    <div class="content">
                        <h3>Add Deal</h3>
                                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="field">
                                        <label>Thumbnail Image</label>  
                                        <form name="FormDealImage" id="FormDealImage" class="file-upload " enctype="multipart/form-data">
                                            <ul id="ulInsurance">
                                                <!--ko foreach:DealImage-->
                                                <li class="clearfix">
                                                    <span class="pip"><img class="imageThumb" width="92" height="92" data-bind="attr:{src:'@System.Configuration.ConfigurationManager.AppSettings[BolDealsAdmin.Common.Constants.BolDealsAdminVD]'+'/Images/Deals/'+Location  }" /></span>
                                                    
                                                </li>
                                                <!--/ko-->
                                                <li class="clearfix">
                                                    <!--ko foreach:TotalDealImages-->
                                                    <br />
                                                    <span data-bind="attr:{id:$index()}" class="loading">
                                                        <span></span>
                                                    </span>
                                                    <!--/ko-->
                                                </li>
                                                <li class="clearfix">
                                                    <input type="file" id="DealImage" class="parent" name="DealImageFile" title="" data-bind="event:{change:function(){UploadDealImage('#FormDealImage','DealImage')}}" style="margin-top: 5px; color: #edf0f0; width: 94px" />
                                                    <p style="color: #c5171d; display: none; font-size: 14px;" id="FormDealImageErr">Please Choose Image</p>
                                                </li>
                                            </ul>
                                        </form>
                                    </div>
                                    <div class="field">
                                        <label> Detail Images</label>                                       
                                        <form name="FormInsurance" class="file-upload " id="FormInsurance" enctype="multipart/form-data">
                                            <ul id="ulInsurance">
                                                <!--ko foreach:InsuranceImage-->

                                                <span class="pip">
                                                    <img class="imageThumb" width="92" height="92" data-bind="attr:{src:'@System.Configuration.ConfigurationManager.AppSettings[BolDealsAdmin.Common.Constants.BolDealsAdminVD]'+'/Images/Deals/'+Location  }" />
                                                    <br /><span class="remove" data-bind="click:$root.ConfirmationDeleteImagePopup">Remove image</span>
                                                </span>                                              

                                                <!--/ko-->
                                                <li class="clearfix">
                                                    <!--ko foreach:TotalImages-->
                                                    <br />
                                                    <span data-bind="attr:{id:$index()}" class="loading">
                                                        <span></span>
                                                    </span>
                                                    <!--/ko-->
                                                </li>
                                                <li class="clearfix">
                                                    <input type="file" multiple id="Insurance" class="parent" name="InsuranceFile" title="" data-bind="event{change:function(){UploadImage('#FormInsurance','Insurance')}}" style="margin-top: 5px; color: #edf0f0; width: 20%" />
                                                    <p style="color: #c5171d; display: none; font-size: 14px;" id="FormInsuranceErr">Please Choose Image</p>
                                                </li>
                                            </ul>
                                         </form>
                                    </div>
                                    <div class="field">
                                        <label>Deal Name</label>
                                        <input id="DealName" type="text" placeholder="Deal Name" class="fld" maxlength="50">  
                                        <p style="color: #c5171d; display: none;font-size:14px" id="DealNameErr">Deal Name Already Exist</p>                                     
                                    </div>
                                    <div class="field">
                                        <label>Client</label>                                       
                                        <select id="ddlClient" data-bind="options: ClientList, optionsText: 'ClientName', optionsValue: 'ClientID'," class="fld full form-control" data-placeholder="Select All" style="width:100% !important"></select>
                                    </div>
                                    <div class="col-md-6 field" style="padding-left: 0px !important; padding-right: 3px !important;">
                                        <label>Category</label>                                       
                                        <select id="ddlCategory" data-bind="options: CategoryList, optionsText: 'CategoryName', optionsValue: 'CategoryID'," class="fld form-control" data-placeholder="Select All" style="width:100% !important"></select>

                                    </div>
                                    <div class="col-md-6 field" style="padding-left: 3px !important; padding-right: 0px !important;">
                                        <label>Location</label>                                        
                                        <select id="ddlLocation" data-bind="options: LocationList, optionsText: 'CityName', optionsValue: 'CityID'," class="fld form-control" data-placeholder="Select All" style="width:100% !important"></select>
                                    </div>
                                    <div class="field">
                                        <label>Description</label>                                      
                                        <textarea id="Description" placeholder="Enter Description" class="fld" maxlength="200" rows="3" cols="2"> </textarea>
                                    </div>
                                    <div class="field text-center">
                                        <input type="submit" class="btn" data-bind="click:$root.AddDealDB">
                                    </div>
                                </div>
                            </div>

                    </div>

                </div>
            </div>
        </div>
    </div>


    <script type="text/javascript" src="../assets/js/jquery.js"></script>
    <script type="text/javascript" src="../assets/js/functions.js"></script>
    <script>

    var BolDealsAdminVD = '@System.Configuration.ConfigurationManager.AppSettings[BolDealsAdmin.Common.Constants.BolDealsAdminVD]';

    var AddDealVM = function () {
        var self = this;
        self.InsuranceImage = ko.observableArray();
        self.InsuranceImageLength = ko.observable(0);
        self.TotalImages = ko.observableArray();
        
        
        self.ClientList = ko.observableArray();
        self.ClientList.push({
            ClientName: 'Select Client',
            ClientID: '-1'
        });
        function ClientDO(data) {
            var self = this;
            self.ClientID = data.ClientID;
            self.ClientName = data.ClientName;
        };
        self.LoadClient= function () {

            Helper.AjaxCall.GetCallWithoutLoaderImage(BolDealsAdminVD + '/Deal/GetClients', {}, function (data) {
                var temp = self.ClientList();
                $.each(data.Table, function (i, v) {
                    var obj = new ClientDO(v, self);
                    temp.push(obj);
                });
                self.ClientList.valueHasMutated();
            });
        };
        self.LoadClient();
        
        self.CategoryList = ko.observableArray();
        self.CategoryList.push({
            CategoryName: 'Select Category',
            CategoryID: '-1'
        });
        function CategoryDO(data) {
            var self = this;
            self.CategoryID = data.CategoryID;
            self.CategoryName = data.CategoryName;
        };
        self.LoadCategory = function () {

            Helper.AjaxCall.GetCallWithoutLoaderImage(BolDealsAdminVD + '/Deal/GetCategories', {}, function (data) {
                var temp = self.CategoryList();
                $.each(data.Table, function (i, v) {
                    var obj = new CategoryDO(v, self);
                    temp.push(obj);
                });
                self.CategoryList.valueHasMutated();
            });
        };

        self.LoadCategory();
        self.LocationList = ko.observableArray();
        self.LocationList.push({
            CityName: 'Select Location',
            CityID: '-1'
        });
        function LocationDO(data) {
            var self = this;
            self.CityID = data.CityID;
            self.CityName = data.CityName;
        };
        self.LoadLocation = function () {
            Helper.AjaxCall.GetCallWithoutLoaderImage(BolDealsAdminVD + '/Deal/GetLocations', {}, function (data) {
                var temp = self.LocationList();
                $.each(data.Table, function (i, v) {
                    var obj = new LocationDO(v, self);
                    temp.push(obj);
                });
                self.LocationList.valueHasMutated();
            });
        };
        self.LoadLocation();



        self.MaxFilesizeValidation = function (UploadedFileSize) {
            var IsMaxSize = true;

            if (UploadedFileSize <= 3145728) {
                return true;
            }
            else {
                return false;
            }

        }
        self.MinFileSizeValidation = function (UploadedFileSize) {
            if (UploadedFileSize > 0) {
                return true;
            }
            else {
                return false;
            }
        }   
        self.FileFormatValidation = function (extension) {

            if (extension == 'JPG' || extension == 'PNG' || extension == 'JPEG') {
                return true;
            } else {
                return false;
            }          
        }         


        /*Upload image*/
        self.UploadImage = function (id, Path, MembershipStatus) {

            var totalFile = 0;
            var totalUploadedImage = 0;
            var isValidFormat = true;
            var ZeroFileSize = true;
            var IsFileFormatValid = true;  
            var UploadedFileSize = 0;
            var IsMaxFileNameLength = true;           
            var FileNameLength = 0;

            totalUploadedImage = $(id + " input:file")[0].files.length;
            if (id == '#FormInsurance') {
                // self.InsuranceIsAdded(true);
                self.InsuranceImageLength(parseInt(self.InsuranceImageLength()) + $(id + " input:file")[0].files.length);
            }

            for (var i = 0; i < totalUploadedImage; i++) {
                FileNameLength = $(id + " input:file")[0].files[i].name.split('.')[0].length;
                if (FileNameLength <= 150) {
                    IsMaxFileNameLength = true;
                }
                else {
                    IsMaxFileNameLength = false;
                }

                UploadedFileSize = $(id + " input:file")[0].files[i].size;              
                //ZeroFileSize = self.MinFileSizeValidation(UploadedFileSize);

                var ext =  $(id + " input:file")[0].files[i].name.split('\.').pop();              
                var extension = ext.toUpperCase();


                IsFileFormatValid =  self.FileFormatValidation(extension);
                isValidFormat = self.MaxFilesizeValidation(UploadedFileSize);                
                }
                if (IsMaxFileNameLength == true) {
                    if (IsFileFormatValid == true) {
                        if (isValidFormat == true) {
                            var data = '';
                            $(id).find('.loading span').width('0px').css('background', '#72d2a0');
                            //if (Path == 'ProfileImage') {
                            //   data = self.ProfileImage();
                            //}
                            // else {
                            data = new FormData($(id)[0]);
                            //   }
                            var url =  BolDealsAdminVD + '/Deal/ImageUploadService';
                            $.ajax({
                                url: url,
                                data: data,
                                cache: false,
                                contentType: false,
                                processData: false,
                                type: 'POST',
                                success: function (data) {
                                    var Data = JSON.parse(data);
                                   
                                    if (Data.List != '-1') {

                                        self.TotalImages(Data.List);
                                        setTimeout(function () {
                                            $(id).find('.loading span').animate({ width: '100%' });

                                            setTimeout(function () {
                                                $.each(Data.List, function (i, v) {
                                                    self.InsuranceImage.push({ "FileName": v[0], "Location": v[1], "Extension": v[2] });
                                                });
                                                self.TotalImages([]); 
                                                $('#FormInsuranceErr').hide();
                                            }, 1000);
                                        }, 1000);


                                    } else {
                                        $('.savingDiv').hide();
                                        $(id).find('.loading').hide();
                                       // $('.fail').text(Data.Message);
                                        // $('.onerror').trigger('click');
                                        alert(Data.Message);
                                    }
                                    //setTimeout(function () { scrollOnDoc() }, 2200);


                                    setTimeout(function () {
                                        if ($(".file-upload.widScrl ul").hasClass("mCustomScrollbar")) {
                                            $(".file-upload.widScrl ul").mCustomScrollbar('destroy');
                                            customscrollerY(".file-upload.widScrl ul");
                                        }
                                    }, 2200);

                                },
                                error: function () {
                                    $(id).find('.loading span').animate({ width: '80%', backgroundColor: 'red' }, 3000);

                                }

                            });
                        }
                        else {
                           if (id == '#FormInsurance') {

                                self.InsuranceImageLength(self.InsuranceImage().length);
                            }
                            $(id).find('.loading').hide();                            
                            alert("File size should be less than 3MB.");
                        }
                    } else {

                       if (id == '#FormInsurance') {

                            self.InsuranceImageLength(self.InsuranceImage().length);
                        }
                        $(id).find('.loading').hide();                       
                        alert("Uploaded file is not a valid image. Only JPG, PNG files are allowed");
                    }
                } else
                {
                    if (id == '#FormInsurance') {

                        self.InsuranceImageLength(self.InsuranceImage().length);
                    }
                    $(id).find('.loading').hide();
                    //$('.fail').text("Very long file name.");
                    //$('.onerror').trigger('click');
                    alert("Very long file name.");
                }

                //to Add Same File Again
                $('.parent').val('');


            };
            self.ConfirmationDeleteImagePopup = function (data) {
                self.InsuranceImage.remove(data);
                self.InsuranceImageLength(self.InsuranceImageLength() - 1);
            };

            self.ImageResolutionValidation = function( myfile ){
                var reader = new FileReader();
                reader.readAsDataURL(myfile);
                reader.onload = function (e) {
                    //Initiate the JavaScript Image object.
                    var image = new Image(); 
                    //Set the Base64 string return from FileReader as source.
                    image.src = e.target.result;                       
                    //Validate the File Height and Width.
                    image.onload = function () {
                        var height = this.height;
                        var width = this.width;
                        if (height > 100 || width > 100)
                            return false;
                        else
                            return true;
                    }; 
                }
            }
        
            self.DealImage = ko.observableArray();
            self.DealImageLength = ko.observable(0);           
            self.TotalDealImages = ko.observableArray();
          
            self.UploadDealImage = function (id, Path, MembershipStatus) {
                self.DealImage([]);
                var totalFile = 0;
                var totalUploadedImage = 0;
                var isValidFormat = true;
                var ZeroFileSize = true;
                var UploadedFileSize = 0;
                var IsFileFormatValid = true;  
                var IsMaxFileNameLength = true;               
                var FileNameLength = 0;
                var IsImageRelosutionValid = true;

                totalUploadedImage = $(id + " input:file")[0].files.length;
                if (id == '#FormDealImage') {
                    // self.InsuranceIsAdded(true);
                    self.DealImageLength(parseInt(self.DealImageLength()) + $(id + " input:file")[0].files.length);
                }

                for (var i = 0; i < totalUploadedImage; i++) {
                    FileNameLength = $(id + " input:file")[0].files[i].name.split('.')[0].length;
                    if (FileNameLength <= 150) {
                        IsMaxFileNameLength = true;
                    }
                    else {
                        IsMaxFileNameLength = false;
                    }
                   
                    UploadedFileSize = $(id + " input:file")[0].files[i].size;
                    var ext =  $(id + " input:file")[0].files[i].name.split('\.').pop();              
                    var extension = ext.toUpperCase();

                    IsFileFormatValid =  self.FileFormatValidation(extension);
                    ZeroFileSize = self.MinFileSizeValidation(UploadedFileSize);
                    isValidFormat = self.MaxFilesizeValidation(UploadedFileSize); 
                    IsImageRelosutionValid = self.ImageResolutionValidation($(id + " input:file")[0].files[i]);
                }
                if(IsImageRelosutionValid == true) {
                    if (IsMaxFileNameLength == true) {
                        if (IsFileFormatValid == true) {
                            if (isValidFormat == true) {
                                var data = '';
                                $(id).find('.loading span').width('0px').css('background', '#72d2a0');                       
                                data = new FormData($(id)[0]);                       
                                var url =  BolDealsAdminVD + '/Deal/ImageUploadService';
                                $.ajax({
                                    url: url,
                                    data: data,
                                    cache: false,
                                    contentType: false,
                                    processData: false,
                                    type: 'POST',
                                    success: function (data) {
                                        var Data = JSON.parse(data);                               
                                        if (Data.List != '-1') {

                                            self.TotalDealImages(Data.List);
                                            setTimeout(function () {
                                                $(id).find('.loading span').animate({ width: '100%' });

                                                setTimeout(function () {
                                                    $.each(Data.List, function (i, v) {
                                                        self.DealImage.push({ "FileName": v[0],"Location": v[1], "Extension": v[2] });
                                                    });
                                                    self.TotalDealImages([]);
                                                    $('#FormDealImageErr').hide();
                                                }, 1000);
                                            }, 1000);


                                        } else {
                                            $('.savingDiv').hide();
                                            $(id).find('.loading').hide();
                                            //$('.fail').text(Data.Message);
                                            // $('.onerror').trigger('click');
                                            alert(Data.Message);
                                        }
                                        //setTimeout(function () { scrollOnDoc() }, 2200);


                                        setTimeout(function () {
                                            if ($(".file-upload.widScrl ul").hasClass("mCustomScrollbar")) {
                                                $(".file-upload.widScrl ul").mCustomScrollbar('destroy');
                                                customscrollerY(".file-upload.widScrl ul");
                                            }
                                        }, 2200);

                                    },
                                    error: function () {
                                        $(id).find('.loading span').animate({ width: '80%', backgroundColor: 'red' }, 3000);

                                    }

                                });
                            }
                            else {

                                if (id == '#FormDealImage') {

                                    self.DealImageLength(self.DealImage().length);
                                }
                                $(id).find('.loading').hide();
                                alert("File size should be less than 3MB.");
                            }
                        } else {

                            if (id == '#FormDealImage') {

                                self.DealImageLength(self.DealImage().length);
                            }
                            $(id).find('.loading').hide();
                            alert("Uploaded file is not a valid image. Only JPG, PNG files are allowed");
                        }
                    } else
                    {
                        if (id == '#FormDealImage') {

                            self.DealImageLength(self.DealImage().length);
                        }
                        $(id).find('.loading').hide();
                        alert("Very long file name.");
                    }
                }else
                {
                    if (id == '#FormDealImage') {

                        self.DealImageLength(self.DealImage().length);
                    }
                    $(id).find('.loading').hide();
                    alert("Image Resolution must be 440 x 220");
                }




        //to Add Same File Again
            $('.parent').val('');

    }  
            self.AddDealDB = function () {
                var isValid = true;
                if($('#DealName').val().trim().length == 0)
                { 
                    isValid = false;
                    $('#DealName').addClass('BorderRed');
                }
                else{
                    $('#DealName').removeClass('BorderRed');
                }

                if($('#ddlClient').val() == -1)
                { 
                    isValid = false;
                    $('#ddlClient').addClass('BorderRed');
                }
                else{
                    $('#ddlClient').removeClass('BorderRed');
                }

                if($('#ddlCategory').val() == -1)
                { 
                    isValid = false;
                    $('#ddlCategory').addClass('BorderRed');
                }
                else{
                    $('#ddlCategory').removeClass('BorderRed');
                }

                if($('#ddlLocation').val() == -1)
                { 
                    isValid = false;
                    $('#ddlLocation').addClass('BorderRed');
                }
                else{
                    $('#ddlLocation').removeClass('BorderRed');
                }
                if($('#Description').val().trim().length == 0)
                { 
                    isValid = false;
                    $('#Description').addClass('BorderRed');
                }
                else{
                    $('#Description').removeClass('BorderRed');
                }
                //FormDealImageErr
                if(self.InsuranceImage().length == 0)
                { 
                    isValid = false;
                    $('#FormInsuranceErr').show();
                }
                else{
                    $('#FormInsuranceErr').hide();
                }

                if(self.DealImage().length == 0)
                { 
                    isValid = false;
                    $('#FormDealImageErr').show();
                }
                else{
                    $('#FormDealImageErr').hide();
                }


                if(isValid){                
                var myData = {
                   'DealName' : $('#DealName').val().trim(), 
                   'ClientID' : $('#ddlClient').val(),
                   'CategoryID': $('#ddlCategory').val(),
                   'LocationID' : $('#ddlLocation').val(),
                   'Description' : $('#Description').val().trim(),
                   'ImageDetailList': self.InsuranceImage(),
                    'FrontImageDetailList':self.DealImage()
                }

                Helper.AjaxCall.PostCallStringify(BolDealsAdminVD + '/Deal/AddDeal', myData, function (result) {                   
                    if (result == 'already exist') {  
                        $('#DealNameErr').show();
                    } else if (result > 0 ) {
                        window.location.href = '@Url.Action("DealList", "Deal")'; 
                    } 
                });

                }
            }


        }
        var AddDealVMObj = new AddDealVM();
        $(document).ready(function () {
            ko.applyBindings(AddDealVMObj, $('.AddDealVM')[0]);
        })




    </script>

</body>
</html>

Edit Deal:


@model BolDealsAdmin.Models.Deal
@{
    Layout = null;
}

<!doctype html>
<html>
<head>
    <meta charset="utf-8">

    <title>BOL Deals</title>
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <link rel="shortcut icon" href="~/Assets/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="~/Assets/images/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../assets/css/style.css">
    <script src="~/Assets/js/Helper.js"></script>
    <script src="~/Assets/js/knockout-3.1.0.debug.js"></script>
    <script src="~/Assets/js/knockout-3.1.0.js"></script>

</head>

<body>
    <style>
        .BorderRed {
            border-color: #c5171d !important;
            border: 1px solid #c5171d !important;
        }

        .NoBorder {
            border-color: #fff !important;
            border: 1px solid #fff !important;
        }

        .select2-container {
            width: 100% !important;
        }
    </style>
    <style>
        .text-red {
            color: #c5171d !important;
        }

        .imageThumb {
            /*max-height: 75px;*/
            /*border: 2px solid;*/
            padding: 1px;
            cursor: pointer;
            width: 92px;
            height: 92px;
        }

        .pip {
            display: inline-block;
            margin: 10px 10px 0 0;
        }

        .remove {
            display: block;
            background: #c5171d;
            /*border: 1px solid #c5171d;*/
            color: white;
            text-align: center;
            cursor: pointer;
        }

            .remove:hover {
                background: #edf0f0;
                color: #c5171d;
            }

        .file-upload ul li .loading {
            width: 83px;
            height: 7px;
            float: left;
            background: #edf0f0;
            position: relative;
            margin-top: 6px;
        }

            .file-upload ul li .loading span {
                width: 35%;
                height: 7px;
                float: none;
                position: absolute;
                top: 0px;
                left: 0px;
                background: #72d2a0;
            }
    </style>
    <!-- Header -->
    <noscript>
        <div id="jqcheck"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB60lEQVQ4T2NkwAHePzrxf3ebL1jWp/0oA5egGiM2pVgFQQq31uj/N/ANZvj+8T3D7aNHGDwbTxNvwKtbO/9f3dLHYJ+axfDn5w+GI/NnMRhFtTEISJtjGIIh8Pv39/87ak0ZzCLiGMRUNMCufnLxDMOlrZsY3JtOMrCwsKPowTDg3tGZ/59f2sVgFRvPkO+bAzZgwsZJDEcXzWNQtIlikDGIwG3Az+9v/+9qsGOwTc1h4JeQhhswcfMUhrcP7zEcXzyXwb3xMAMbuwDcEBTTzi7P/s/M8IFB3zccbDPMBSADQODs2sUMzFwyDIah/ZgGfHt/7/+BvmAGm+RsBl4RMawGfHr5jOHowlkMjiUbGDj55MCGwE060Of1X0RZi0Hb2Q4e3eguAElc2X2A4e2DmwwOhVsRBnx6cfH/yXm5DFZxyQxcAoJ4Dfj24T3DsUVzGcwSJjLwSxkygk3ZVmv4X805gkHZRBNXwkQRv3/+NsP1nUsYvFvOMzI+PLXo/73DSxgsouIYOHj5UBRi8wJIwY8vnxlOLV/CIGcewsC4vkDhv01yLoOIoiqG7bgMACn88Owxw8HpvQyMGwqV/vs19TMwQnxDEthYW8DAeGCC3/9XN46TpBGmWEzDkoHx06dP/z9//kyWAby8vAwAcza2SBMOSCMAAAAASUVORK5CYII=" alt="No Script" /> Javascript is disabled. Please enable it for better working experience.</div>
    </noscript>

    <div class="container-fluid AddDealVM">
        <div class="row">
            <div class="col-xs-2 ht lft-nav">
                <div class="row whitebg">
                    <div class="logo">
                        <figure>
                            <a href="../"><img src="../assets/images/logo.jpg" alt="Bol Deal" class="img-responsive"></a>
                        </figure>
                    </div>
                </div>

                <div class="row">
                    <ul>
                        <li><a href='@( Url.Action("ClientList", "Client"))'>Client</a></li>
                        <li><a class="active" href='@( Url.Action("DealList", "Deal"))'>Deal</a></li> 
                        <li><a style="text-decoration:none" href='@( Url.Action("MemberList", "Member"))'>Member</a></li>                         
                    </ul>
                </div>

            </div>

            <div class="col-xs-10 rht-nav">
                <div class="row">
                    @Html.Partial("_Header")
                    <div class="content">
                        <h3>Edit Deal</h3>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="field">
                                    <label>Thumbnail Image</label>  
                                    <form name="FormDealImage" id="FormDealImage" class="file-upload " enctype="multipart/form-data">
                                        <ul id="ulInsurance">
                                            <!--ko foreach:DealImage-->
                                            <li class="clearfix">
                                                <span class="pip"><img class="imageThumb" width="92" height="92" data-bind="attr:{src:'@System.Configuration.ConfigurationManager.AppSettings[BolDealsAdmin.Common.Constants.BolDealsAdminVD]'+'/Images/Deals/'+Location  }" /></span>
                                               
                                            </li>
                                            <!--/ko-->
                                            <li class="clearfix">
                                                <!--ko foreach:TotalDealImages-->
                                                <br />
                                                <span data-bind="attr:{id:$index()}" class="loading">
                                                    <span></span>
                                                </span>
                                                <!--/ko-->
                                            </li>
                                            <li class="clearfix">
                                                <input type="file" id="DealImage" class="parent" name="DealImageFile" title="" data-bind="event:{change:function(){UploadDealImage('#FormDealImage','DealImage')}}" style="margin-top: 5px; color: #edf0f0; width: 94px;" />
                                                <p style="color: #c5171d; display: none; font-size: 14px" id="FormDealImageErr">Please Choose Image</p>
                                            </li>
                                        </ul>
                                    </form>
                                </div>
                                <div class="field">
                                    <label> Detail Images</label>
                                    <form name="FormInsurance" class="file-upload " id="FormInsurance" enctype="multipart/form-data">
                                        <ul id="ulInsurance">
                                            <!--ko foreach:InsuranceImage-->
                                            <span class="pip">
                                                <img class="imageThumb" width="92" height="92" data-bind="attr:{src:'@System.Configuration.ConfigurationManager.AppSettings[BolDealsAdmin.Common.Constants.BolDealsAdminVD]'+'/Images/Deals/'+Location  }" />
                                                <br /><span class="remove" data-bind="click:$root.ConfirmationDeleteImagePopup">Remove image</span>
                                            </span>                                          

                                            <!--/ko-->
                                            <li class="clearfix">
                                                <!--ko foreach:TotalImages-->
                                                <br />
                                                <span data-bind="attr:{id:$index()}" class="loading">
                                                    <span></span>
                                                </span>
                                                <!--/ko-->
                                            </li>
                                            <li class="clearfix">
                                                <input type="file" multiple id="Insurance" class="parent" name="InsuranceFile" title="" data-bind="event{change:function(){UploadImage('#FormInsurance','Insurance')}}" style="margin-top: 5px; color: #edf0f0; width: 20%; " />
                                                <p style="color: #c5171d; display: none; font-size: 14px;" id="FormInsuranceErr">Please Choose Image</p>
                                            </li>
                                        </ul>
                                    </form>
                                </div>
                                <div class="field">
                                    <label>Deal Name</label>
                                    <input id="DealName" type="text" placeholder="Deal Name" class="fld" maxlength="50">
                                    <p style="color: #c5171d; display: none;font-size:14px" id="DealNameErr">Deal Name Already Exist</p>
                                </div>
                                <div class="field">
                                    <label>Client</label>
                                    <select id="ddlClient" data-bind="options: ClientList, optionsText: 'ClientName', optionsValue: 'ClientID'," class="fld full form-control" data-placeholder="Select All" style="width:100% !important"></select>
                                </div>
                                <div class="col-md-6 field" style="padding-left: 0px !important; padding-right: 3px !important;">
                                    <label>Category</label>
                                    <select id="ddlCategory" data-bind="options: CategoryList, optionsText: 'CategoryName', optionsValue: 'CategoryID'," class="fld form-control" data-placeholder="Select All" style="width:100% !important"></select>

                                </div>
                                <div class="col-md-6 field" style="padding-left: 3px !important; padding-right: 0px !important;">
                                    <label>Location</label>
                                    <select id="ddlLocation" data-bind="options: LocationList, optionsText: 'CityName', optionsValue: 'CityID'," class="fld form-control" data-placeholder="Select All" style="width:100% !important"></select>
                                </div>
                                <div class="field">
                                    <label>Description</label>
                                    <textarea id="Description" placeholder="Enter Description" class="fld" maxlength="200" rows="3" cols="2"> </textarea>
                                </div>
                                <div class="field text-center">
                                    <input type="submit" class="btn" data-bind="click:$root.UpdatedDealDB">
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>


    <script type="text/javascript" src="../assets/js/jquery.js"></script>
    <script type="text/javascript" src="../assets/js/functions.js"></script>
    <script>
        var BolDealsAdminVD = '@System.Configuration.ConfigurationManager.AppSettings[BolDealsAdmin.Common.Constants.BolDealsAdminVD]';

        var AddDealVM = function () {
            var self = this;
            self.InsuranceImage = ko.observableArray();
            self.InsuranceImageLength = ko.observable(0);
            self.TotalImages = ko.observableArray();


            self.ClientList = ko.observableArray();
            self.ClientList.push({
                ClientName: 'Select Client',
                ClientID: '-1'
            });
            function ClientDO(data) {
                var self = this;
                self.ClientID = data.ClientID;
                self.ClientName = data.ClientName;
            };
            self.LoadClient= function () {

                Helper.AjaxCall.GetCallWithoutLoaderImage(BolDealsAdminVD + '/Deal/GetClients', {}, function (data) {
                    var temp = self.ClientList();
                    $.each(data.Table, function (i, v) {
                        var obj = new ClientDO(v, self);
                        temp.push(obj);
                    });
                    self.ClientList.valueHasMutated();
                });
            };
            self.LoadClient();

            self.CategoryList = ko.observableArray();
            self.CategoryList.push({
                CategoryName: 'Select Category',
                CategoryID: '-1'
            });
            function CategoryDO(data) {
                var self = this;
                self.CategoryID = data.CategoryID;
                self.CategoryName = data.CategoryName;
            };
            self.LoadCategory = function () {

                Helper.AjaxCall.GetCallWithoutLoaderImage(BolDealsAdminVD + '/Deal/GetCategories', {}, function (data) {
                    var temp = self.CategoryList();
                    $.each(data.Table, function (i, v) {
                        var obj = new CategoryDO(v, self);
                        temp.push(obj);
                    });
                    self.CategoryList.valueHasMutated();
                });
            };

            self.LoadCategory();
            self.LocationList = ko.observableArray();
            self.LocationList.push({
                CityName: 'Select Location',
                CityID: '-1'
            });
            function LocationDO(data) {
                var self = this;
                self.CityID = data.CityID;
                self.CityName = data.CityName;
            };
            self.LoadLocation = function () {
                Helper.AjaxCall.GetCallWithoutLoaderImage(BolDealsAdminVD + '/Deal/GetLocations', {}, function (data) {
                    var temp = self.LocationList();
                    $.each(data.Table, function (i, v) {
                        var obj = new LocationDO(v, self);
                        temp.push(obj);
                    });
                    self.LocationList.valueHasMutated();
                });
            };
            self.LoadLocation();



            self.MaxFilesizeValidation = function (UploadedFileSize) {
                var IsMaxSize = true;

                if (UploadedFileSize <= 3145728) {
                    return true;
                }
                else {
                    return false;
                }

            }
            self.MinFileSizeValidation = function (UploadedFileSize) {
                if (UploadedFileSize > 0) {
                    return true;
                }
                else {
                    return false;
                }
            }
            self.FileFormatValidation = function (extension) {

                if (extension == 'JPG' || extension == 'PNG' || extension == 'JPEG') {
                    return true;
                } else {
                    return false;
                }          
            }   

            /*Upload image*/
            self.UploadImage = function (id, Path, MembershipStatus) {

                var totalFile = 0;
                var totalUploadedImage = 0;
                var isValidFormat = true;
                var ZeroFileSize = true;
                var UploadedFileSize = 0;
                var IsMaxFileNameLength = true;
                var IsFileFormatValid = true;  
                //self.IsAdded(false);
                //self.AgreementIsAdded(false);
                // self.OtherIsAdded(false);
                // self.InsuranceIsAdded(false);
                var FileNameLength = 0;

                totalUploadedImage = $(id + " input:file")[0].files.length;
                if (id == '#FormInsurance') {
                    // self.InsuranceIsAdded(true);
                    self.InsuranceImageLength(parseInt(self.InsuranceImageLength()) + $(id + " input:file")[0].files.length);
                }

                for (var i = 0; i < totalUploadedImage; i++) {
                    FileNameLength = $(id + " input:file")[0].files[i].name.split('.')[0].length;
                    if (FileNameLength <= 150) {
                        IsMaxFileNameLength = true;
                    }
                    else {
                        IsMaxFileNameLength = false;
                    }

                    UploadedFileSize = $(id + " input:file")[0].files[i].size;
                    var ext =  $(id + " input:file")[0].files[i].name.split('\.').pop();              
                    var extension = ext.toUpperCase();
                    IsFileFormatValid =  self.FileFormatValidation(extension);
                    ///  if (UploadedFileSize > 0) {
                    //ZeroFileSize = self.MinFileSizeValidation(UploadedFileSize);
                    isValidFormat = self.MaxFilesizeValidation(UploadedFileSize);
                    //}
                    @*else {
                            ZeroFileSize = false;
                    }
                    if (UploadedFileSize <= '@((int)Constants.MaxImageSize)' * 1024) {
                        isValidFormat = true;
                    }
                    else {
                        isValidFormat = false;
                    }*@
                }
                if (IsMaxFileNameLength == true) {
                    if (IsFileFormatValid == true) {
                        if (isValidFormat == true) {
                            var data = '';
                            $(id).find('.loading span').width('0px').css('background', '#72d2a0');
                            //if (Path == 'ProfileImage') {
                            //   data = self.ProfileImage();
                            //}
                            // else {
                            data = new FormData($(id)[0]);
                            //   }
                            var url =  BolDealsAdminVD + '/Deal/ImageUploadService';
                            $.ajax({
                                url: url,
                                data: data,
                                cache: false,
                                contentType: false,
                                processData: false,
                                type: 'POST',
                                success: function (data) {
                                    var Data = JSON.parse(data);
                                    debugger
                                    if (Data.List != '-1') {

                                        self.TotalImages(Data.List);
                                        setTimeout(function () {
                                            $(id).find('.loading span').animate({ width: '100%' });

                                            setTimeout(function () {
                                                $.each(Data.List, function (i, v) {
                                                    self.InsuranceImage.push({ "FileName": v[0], "Location": v[1], "Extension": v[2] });
                                                });
                                                self.TotalImages([]);
                                                $('#FormInsuranceErr').hide();
                                            }, 1000);
                                        }, 1000);


                                    } else {
                                        $('.savingDiv').hide();
                                        $(id).find('.loading').hide();
                                        //$('.fail').text(Data.Message);
                                        //$('.onerror').trigger('click');
                                        alert(Data.Message);
                                    }
                                    //setTimeout(function () { scrollOnDoc() }, 2200);


                                    setTimeout(function () {
                                        if ($(".file-upload.widScrl ul").hasClass("mCustomScrollbar")) {
                                            $(".file-upload.widScrl ul").mCustomScrollbar('destroy');
                                            customscrollerY(".file-upload.widScrl ul");
                                        }
                                    }, 2200);

                                },
                                error: function () {
                                    $(id).find('.loading span').animate({ width: '80%', backgroundColor: 'red' }, 3000);

                                }

                            });
                        }
                        else {
                            if (id == '#FormInsurance') {

                                self.InsuranceImageLength(self.InsuranceImage().length);
                            }
                            $(id).find('.loading').hide();
                            alert("File size should be less than 3MB.");
                        }
                    } else {

                        if (id == '#FormInsurance') {

                            self.InsuranceImageLength(self.InsuranceImage().length);
                        }
                        $(id).find('.loading').hide();
                        alert("Uploaded file is not a valid image. Only JPG, PNG files are allowed");
                    }
                } else
                {
                    if (id == '#FormInsurance') {

                        self.InsuranceImageLength(self.InsuranceImage().length);
                    }
                    $(id).find('.loading').hide();
                    alert("Very long file name.");
                }

                //to Add Same File Again
                $('.parent').val('');


            };
            self.ConfirmationDeleteImagePopup = function (data) {
                self.InsuranceImage.remove(data);
                self.InsuranceImageLength(self.InsuranceImageLength() - 1);
            };


            self.DealImage = ko.observableArray();
            self.DealImageLength = ko.observable(0);
            self.TotalDealImages = ko.observableArray();

            self.UploadDealImage = function (id, Path, MembershipStatus) {
                self.DealImage([]);
                var totalFile = 0;
                var totalUploadedImage = 0;
                var isValidFormat = true;
                var ZeroFileSize = true;
                var UploadedFileSize = 0;
                var IsFileFormatValid = true;  
                var IsMaxFileNameLength = true;
                var FileNameLength = 0;

                totalUploadedImage = $(id + " input:file")[0].files.length;
                if (id == '#FormDealImage') {
                    // self.InsuranceIsAdded(true);
                    self.DealImageLength(parseInt(self.DealImageLength()) + $(id + " input:file")[0].files.length);
                }

                for (var i = 0; i < totalUploadedImage; i++) {
                    FileNameLength = $(id + " input:file")[0].files[i].name.split('.')[0].length;
                    if (FileNameLength <= 150) {
                        IsMaxFileNameLength = true;
                    }
                    else {
                        IsMaxFileNameLength = false;
                    }

                    UploadedFileSize = $(id + " input:file")[0].files[i].size;
                    var ext =  $(id + " input:file")[0].files[i].name.split('\.').pop();              
                    var extension = ext.toUpperCase();
                    ///  if (UploadedFileSize > 0) {
                    // ZeroFileSize = self.MinFileSizeValidation(UploadedFileSize);
                    IsFileFormatValid =  self.FileFormatValidation(extension);
                    isValidFormat = self.MaxFilesizeValidation(UploadedFileSize);
                    //}
                    @*else {
                                ZeroFileSize = false;
                }
                if (UploadedFileSize <= '@((int)Constants.MaxImageSize)' * 1024) {
                    isValidFormat = true;
                }
                else {
                    isValidFormat = false;
                }*@
                }
                if (IsMaxFileNameLength == true) {
                    if (IsFileFormatValid == true) {
                        if (isValidFormat == true) {
                            var data = '';
                            $(id).find('.loading span').width('0px').css('background', '#72d2a0');
                            //if (Path == 'ProfileImage') {
                            //   data = self.ProfileImage();
                            //}
                            // else {
                            data = new FormData($(id)[0]);
                            //   }
                            var url =  BolDealsAdminVD + '/Deal/ImageUploadService';
                            $.ajax({
                                url: url,
                                data: data,
                                cache: false,
                                contentType: false,
                                processData: false,
                                type: 'POST',
                                success: function (data) {
                                    var Data = JSON.parse(data);
                                    debugger
                                    if (Data.List != '-1') {

                                        self.TotalDealImages(Data.List);
                                        setTimeout(function () {
                                            $(id).find('.loading span').animate({ width: '100%' });

                                            setTimeout(function () {
                                                $.each(Data.List, function (i, v) {
                                                    self.DealImage.push({ "FileName": v[0],"Location": v[1], "Extension": v[2] });
                                                });
                                                self.TotalDealImages([]);
                                                $('#FormDealImageErr').hide();
                                            }, 1000);
                                        }, 1000);


                                    } else {
                                        $('.savingDiv').hide();
                                        $(id).find('.loading').hide();
                                        alert(Data.Message);
                                    }
                                    //setTimeout(function () { scrollOnDoc() }, 2200);


                                    setTimeout(function () {
                                        if ($(".file-upload.widScrl ul").hasClass("mCustomScrollbar")) {
                                            $(".file-upload.widScrl ul").mCustomScrollbar('destroy');
                                            customscrollerY(".file-upload.widScrl ul");
                                        }
                                    }, 2200);

                                },
                                error: function () {
                                    $(id).find('.loading span').animate({ width: '80%', backgroundColor: 'red' }, 3000);

                                }

                            });
                        }
                        else {

                            if (id == '#FormDealImage') {

                                self.DealImageLength(self.DealImage().length);
                            }
                            $(id).find('.loading').hide();
                            alert("File size should be less than 3MB.");
                        }
                    } else {

                        if (id == '#FormDealImage') {

                            self.DealImageLength(self.DealImage().length);
                        }
                        $(id).find('.loading').hide();
                        alert("Uploaded file is not a valid image. Only JPG, PNG files are allowed");
                    }
                } else
                {
                    if (id == '#FormDealImage') {

                        self.DealImageLength(self.DealImage().length);
                    }
                    $(id).find('.loading').hide();
                    alert("Very long file name.");
                }

                //to Add Same File Again
                $('.parent').val('');

            }
            self.UpdatedDealDB = function () {
                var isValid = true;
                if($('#DealName').val().trim().length == 0)
                {
                    isValid = false;
                    $('#DealName').addClass('BorderRed');
                }
                else{
                    $('#DealName').removeClass('BorderRed');
                }

                if($('#ddlClient').val() == -1)
                {
                    isValid = false;
                    $('#ddlClient').addClass('BorderRed');
                }
                else{
                    $('#ddlClient').removeClass('BorderRed');
                }

                if($('#ddlCategory').val() == -1)
                {
                    isValid = false;
                    $('#ddlCategory').addClass('BorderRed');
                }
                else{
                    $('#ddlCategory').removeClass('BorderRed');
                }

                if($('#ddlLocation').val() == -1)
                {
                    isValid = false;
                    $('#ddlLocation').addClass('BorderRed');
                }
                else{
                    $('#ddlLocation').removeClass('BorderRed');
                }
                if($('#Description').val().trim().length == 0)
                {
                    isValid = false;
                    $('#Description').addClass('BorderRed');
                }
                else{
                    $('#Description').removeClass('BorderRed');
                }
                //FormDealImageErr
                if(self.InsuranceImage().length == 0)
                {
                    isValid = false;
                    $('#FormInsuranceErr').show();
                }
                else{
                    $('#FormInsuranceErr').hide();
                }

                if(self.DealImage().length == 0)
                {
                    isValid = false;
                    $('#FormDealImageErr').show();
                }
                else{
                    $('#FormDealImageErr').hide();
                }


                if(isValid){
                    var myData = {
                        'DealID':  self.DealID(),
                        'DealName' : $('#DealName').val().trim(),
                        'ClientID' : $('#ddlClient').val(),
                        'CategoryID': $('#ddlCategory').val(),
                        'LocationID' : $('#ddlLocation').val(),
                        'Description' : $('#Description').val().trim(),
                        'ImageDetailList': self.InsuranceImage(),
                        'FrontImageDetailList':self.DealImage()
                    }

                    Helper.AjaxCall.PostCallStringify(BolDealsAdminVD + '/Deal/UpdateDeal', myData, function (result) {
                        //$('.savingDiv').hide();
                        if (result == 'already exist') {
                            $('#DealNameErr').show();

                        } else if (result > 0 ) {
                            window.location.href = '@Url.Action("DealList", "Deal")';
                        }
                    });

                }
            }
            self.DealID = ko.observable();
            self.GetDealsData = function () { 
            
                Helper.AjaxCall.GetCall(BolDealsAdminVD+'/Deal/GetDealById', { 'did': getParameterByName('did')}, function (data) {                   
                    var DealData = data.Table;
                    var DealimageData = data.Table1;
                    self.DealID(DealData[0].DealId);

                    $('#DealName').val(DealData[0].DealName);
                   
                    setTimeout(function(){                    
                        $('#ddlClient').val(DealData[0].ClientID).trigger('change');
                        $('#ddlCategory').val(DealData[0].CategoryID).trigger('change');
                        $('#ddlLocation').val(DealData[0].CityID).trigger('change');                    
                    },400)
                    
                    $('#Description').val(DealData[0].Description);

                    self.DealImage.push({'Location': DealData[0].Image });

                    $.each(data.Table1, function (i, v) {                        
                        self.InsuranceImage.push({'Location': v.slideImage,'DealImageID': v.DealImageID });
                    })

                    })                 
            }

            self.GetDealsData();

            }
        
        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }
        var AddDealVMObj = new AddDealVM();
        $(document).ready(function () {
            ko.applyBindings(AddDealVMObj, $('.AddDealVM')[0]);
        })




    </script>

</body>
</html>



using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using BolDealsAdmin.Models;
using BolDealsAdmin.Common;
using System.Data;
using System.Data.SqlClient;
using System.IO;
using System.Threading.Tasks;
using System.Configuration;
using Newtonsoft.Json;
using BolDealsAdmin.Models;
using ImageResizer;
using System.ComponentModel.DataAnnotations;
using System.Drawing;
using System.Drawing.Imaging;

namespace BolDealsAdmin.Controllers
{
    public class DealController : BaseController
    {
        //
        // GET: /Deal/

        public ActionResult Index()
        {
            return View();
        }
        public ActionResult AddDeal()
        {            
            return View();           
        } 

        [HttpPost]
        public async Task<string> AddDeal(Deal deal)
        {
            try
            {
                int newDealId = 0;
                 SqlParameter[] parameters =
               {  
                  new SqlParameter("@DealId", SqlDbType.Int) { Value = null  },
                  new SqlParameter("@DealName", SqlDbType.VarChar) { Value = deal.DealName.Trim()  },
                  new SqlParameter("@ClientID", SqlDbType.Int) { Value = deal.ClientID  },
                  new SqlParameter("@CategoryID", SqlDbType.Int) { Value = deal.CategoryID  },
                  new SqlParameter("@LocationID", SqlDbType.Int) { Value = deal.LocationID  },                  
                  new SqlParameter("@Description", SqlDbType.VarChar) { Value = deal.Description.Trim()  },                  
                  new SqlParameter("@CreatedBy", SqlDbType.Int) { Value = Constants.GetUserID() },
                  new SqlParameter("@UserIP", SqlDbType.VarChar) { Value = Constants.GetUserIP() }                  
               };

                 DataSet ds = DataAccess.GetDataSet(AppConfigurations.ConnectionString, "BD_InsertUpdate_Deal", parameters);
                 if (ds.Tables[0].Rows.Count > 0)
                 {
                     if (ds.Tables[0].Rows[0]["Status"].ToString() == "already exist")
                     {
                         return JsonConvert.SerializeObject(ds.Tables[0].Rows[0]["Status"].ToString());
                     }
                     else
                     {
                          newDealId = Convert.ToInt32(ds.Tables[1].Rows[0]["NewDealID"].ToString());

                         if (newDealId != 0 && deal.ImageDetailList != null && deal.ImageDetailList.Count > 0) {

                             foreach (var Items in deal.ImageDetailList)
                             {
                                 InsertDealImage(newDealId, Items.Location, 0);                                
                             }
                         } 
                          
                         InsertDealImage(newDealId, deal.FrontImageDetailList[0].Location, 1);
                     }
                 }

                 return JsonConvert.SerializeObject(newDealId.ToString());
            }
            catch (Exception e)
            {
                return e.Message;
            }

        }
               
        public object ImageUploadService()
        {
            object uploadedImageConfirmation = new { Message = "Error in uploading the file", Path = Server.MapPath("~/Images/Deals") };
            string virtualPath = string.Empty;
            string physicalPath = string.Empty;
            string programName = string.Empty;
            string FileExtension = string.Empty;
            string CustomFileName = string.Empty;
            string FileName = string.Empty;
            bool FileSize = true;
            var multiDimensionalList = new List<List<string>>();
            try
            {
                physicalPath = Server.MapPath("~/Images/Deals");
                for (int i = 0; i < System.Web.HttpContext.Current.Request.Files.Count; i++)
                {
                    HttpPostedFile fileslist = System.Web.HttpContext.Current.Request.Files[i];

                        string[] FileTypes = { "JPG", "jpg", "PNG", "png", "BMP", "bmp", "JPEG", "jpeg" };
                        bool isValid = false;
                        string location = string.Empty;
                        if (!Directory.Exists(physicalPath))
                        {
                            Directory.CreateDirectory(physicalPath);
                        }
                        FileExtension = Path.GetExtension(fileslist.FileName);


                        for (int j = 0; j < FileTypes.Length; j++)
                        {
                            if (FileExtension != "." + FileTypes[j])
                            {

                                // uploadedImageConfirmation = new { Message = "Kindly upload valid file(s)", List="" };
                                isValid = false;
                            }
                            else
                            {
                                isValid = true;
                                break;
                            }
                        }
                        if (isValid == true)
                        {
                            int totalFileSize = Convert.ToInt32(fileslist.ContentLength);
                            for (int k = 0; k < System.Web.HttpContext.Current.Request.Files.Count; k++)
                            {
                                if (totalFileSize > 3145728)
                                {
                                    FileSize = false;
                                    break;
                                }
                            }

                            if (FileSize == true)
                            {

                                FileName = Path.GetFileNameWithoutExtension(fileslist.FileName);
                                CustomFileName = DateTime.Now.DayOfYear.ToString() + DateTime.Now.ToString("HHmmss_ffff") + Path.GetFileNameWithoutExtension(fileslist.FileName) + FileExtension;



                                location = physicalPath + '/' + CustomFileName;
                                FileInfo info1 = new FileInfo(location);
                                if (info1.Exists)
                                {
                                    return JsonConvert.SerializeObject(new { Message = "File Exists", List = multiDimensionalList });
                                }
                                fileslist.SaveAs(location);
                                multiDimensionalList.Add(new List<string> { FileName,CustomFileName, FileExtension });
                                uploadedImageConfirmation = new { Message = "File uploaded successfully", List = multiDimensionalList };
                            }
                            else
                            {
                                uploadedImageConfirmation = new { Message = "File size should be less than 3MB.", List = -1 };
                                break;
                            }
                        }
                        else
                            uploadedImageConfirmation = new { Message = "Kindly upload valid file (allowed formats are JPEG, PNG,JPG).", List = -1 };
                    

                }

                //uploadedImageConfirmation = new { Message = "File uploaded successfully", PhysicalPath = location,FileName = fileslist.FileName};
            }
            catch (Exception ex)
            { }

            return JsonConvert.SerializeObject(uploadedImageConfirmation);
        }


        [HttpPost]
        public async Task<string> UpdateDeal(Deal deal)
        {
            try
            {
                int newDealId = 0;
                SqlParameter[] parameters =
               {  
                  new SqlParameter("@DealId", SqlDbType.Int) { Value = deal.DealID  },
                  new SqlParameter("@DealName", SqlDbType.VarChar) { Value = deal.DealName.Trim()  },
                  new SqlParameter("@ClientID", SqlDbType.Int) { Value = deal.ClientID  },
                  new SqlParameter("@CategoryID", SqlDbType.Int) { Value = deal.CategoryID  },
                  new SqlParameter("@LocationID", SqlDbType.Int) { Value = deal.LocationID  },                  
                  new SqlParameter("@Description", SqlDbType.VarChar) { Value = deal.Description.Trim()  },                  
                  new SqlParameter("@CreatedBy", SqlDbType.Int) { Value = Constants.GetUserID() },
                  new SqlParameter("@UserIP", SqlDbType.VarChar) { Value = Constants.GetUserIP() }                  
               };

                DataSet ds = DataAccess.GetDataSet(AppConfigurations.ConnectionString, "BD_InsertUpdate_Deal", parameters);
                if (ds.Tables[0].Rows.Count > 0)
                {
                    if (ds.Tables[0].Rows[0]["Status"].ToString() == "already exist")
                    {
                        return JsonConvert.SerializeObject(ds.Tables[0].Rows[0]["Status"].ToString()); 
                    }
                    else
                    {
                        newDealId = Convert.ToInt32(deal.DealID);

                        if (newDealId != 0 && deal.ImageDetailList != null && deal.ImageDetailList.Count > 0)
                        {

                            foreach (var Items in deal.ImageDetailList)
                            {
                                InsertDealImage(newDealId, Items.Location, 0);
                            }
                        }

                        InsertDealImage(newDealId, deal.FrontImageDetailList[0].Location, 1);
                    }
                }

                return JsonConvert.SerializeObject(newDealId.ToString());
            }
            catch (Exception e)
            {
                return e.Message;
            }

        }
        
        [HttpGet]
        public async Task<string> GetDealById(string did)
        {
            try
            {
                int id = -1;
                if (did != null)
                {
                    SecureQueryString OBJ = new SecureQueryString();
                    id = Convert.ToInt32(OBJ.decrypt(Convert.ToString(did)));
                }

                Uri url = Request.UrlReferrer;
                DataSet ds = null;
                if (Constants.IsAjaxRequestAccept)
                {
                    SqlParameter[] parameters =
                         {  
                            new SqlParameter("@DealId",SqlDbType.Int){Value= id },
                         
                         };
                    ds = await DataAccess.ExecuteDatasetAsync(AppConfigurations.ConnectionString, CommandType.StoredProcedure, "BD_Select_DealsByDealId", parameters); 
                }
                return JsonConvert.SerializeObject(ds);
            }

            catch (Exception ex)
            {
                LogError(ex);
                return JsonConvert.SerializeObject("");
            }
        }     

        public void InsertDealImage(int DealId, string Image, int IsFront)
        {
            try
            {
                SqlParameter[] parameters =
               {  new SqlParameter("@DealId", SqlDbType.Int) { Value = DealId },                              
                  new SqlParameter("@Image", SqlDbType.VarChar) { Value = Image }, 
                  new SqlParameter("@IsFront", SqlDbType.Int) { Value = IsFront },                    
                  new SqlParameter("@CreatedBy",SqlDbType.Int){Value= Constants.GetUserID() },
                  new SqlParameter("@UserIP",SqlDbType.VarChar){Value= Constants.GetUserIP() }
               };
                DataAccess.ExecuteNonQuery(AppConfigurations.ConnectionString, "BD_Insert_DealImage", parameters);
            }
            catch (Exception ex)
            {
                LogError(ex);
            }
        }       
        public ActionResult EditDeal()
        {
            return View();
        }
        public ActionResult DealList()
        {
            return View();
        }

        [HttpGet]
        public List<SelectListItem> GetClientList()
        {
            try
            {
                List<SelectListItem> ClientList = new List<SelectListItem>();
                DataTable dt = new DataTable();
                DataSet ds = DataAccess.GetDataSet(AppConfigurations.ConnectionString, "BD_Select_Clients", null);
                if (ds != null && ds.Tables.Count > 0)
                {
                    dt = ds.Tables[0];
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        for (int i = 0; i < dt.Rows.Count; i++)
                        {
                            ClientList.Add(new SelectListItem() { Value = dt.Rows[i]["ClientID"].ToString(), Text = dt.Rows[i]["ClientName"].ToString() });
                        }
                    }
                }
                return ClientList;
            }
            catch (Exception ex)
            {
                LogError(ex);
                throw;
            }
        }
        [HttpGet]
        public List<SelectListItem> GetLocationList()
        {
            try
            {
                List<SelectListItem> LocationList = new List<SelectListItem>();
                DataTable dt = new DataTable();
                DataSet ds = DataAccess.GetDataSet(AppConfigurations.ConnectionString, "BD_Select_Cities", null);
                if (ds != null && ds.Tables.Count > 0)
                {
                    dt = ds.Tables[0];
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        for (int i = 0; i < dt.Rows.Count; i++)
                        {
                            LocationList.Add(new SelectListItem() { Value = dt.Rows[i]["CityID"].ToString(), Text = dt.Rows[i]["CityName"].ToString() });
                        }
                    }
                }
                return LocationList;
            }
            catch (Exception ex)
            {
                LogError(ex);
                throw;
            }
        }

        [HttpGet]
        public List<SelectListItem> GetCategoriesList()
        {
            try
            {
                List<SelectListItem> CategoryList = new List<SelectListItem>();
                DataTable dt = new DataTable();
                DataSet ds = DataAccess.GetDataSet(AppConfigurations.ConnectionString, "BD_Select_Categories", null);
                if (ds != null && ds.Tables.Count > 0)
                {
                    dt = ds.Tables[0];
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        for (int i = 0; i < dt.Rows.Count; i++)
                        {
                            CategoryList.Add(new SelectListItem() { Value = dt.Rows[i]["CategoryID"].ToString(), Text = dt.Rows[i]["CategoryName"].ToString() });
                        }
                    }
                }
                return CategoryList;
            }
            catch (Exception ex)
            {
                LogError(ex);
                throw;
            }
        }

        [ValidateInput(false)]
        [HttpGet]
        public async Task<string> GetDealsAsync(int pageNo, int pageSize,int? categoryCode,int? locationCode)
        {
            try
            {
                Uri url = Request.UrlReferrer;
                DataSet ds = null;
                if (Constants.IsAjaxRequestAccept)
                {
                    SqlParameter[] parameters =
                         {  new SqlParameter("@PageCount", SqlDbType.Int) { Value = pageNo  },
                            new SqlParameter("@PageSize", SqlDbType.Int) { Value = pageSize },
                            new SqlParameter("@DealId",SqlDbType.Int){Value= null },
                            new SqlParameter("@CatergoryId",SqlDbType.Int){Value= categoryCode },
                            new SqlParameter("@LocationId",SqlDbType.Int){Value= locationCode }                            
                         };
                    ds = await DataAccess.ExecuteDatasetAsync(AppConfigurations.ConnectionString, CommandType.StoredProcedure, "BD_Select_DealsList", parameters);

                    if (ds != null && ds.Tables.Count != 0 && ds.Tables[0].Rows.Count > 0)
                    {
                        SecureQueryString OBJ = new SecureQueryString();
                        DataTable dt = ds.Tables[0];
                        dt.Columns.Add("EncryptedDealCode", typeof(string));

                        for (int i = 0; i < dt.Rows.Count; i++)
                        {
                            dt.Rows[i]["EncryptedDealCode"] = OBJ.encrypt(Convert.ToString(dt.Rows[i]["DealId"]));

                        }

                    }

                }
                return JsonConvert.SerializeObject(ds);
            }

            catch (Exception ex)
            {
                LogError(ex);
                return JsonConvert.SerializeObject("");
            }
        }

        [HttpGet]
        public async Task<string> GetLocations()
        {
            DataSet ds = null;
            if (Constants.IsAjaxRequestAccept)
            {
                ds = await DataAccess.ExecuteDatasetAsync(AppConfigurations.ConnectionString, CommandType.StoredProcedure, "BD_Select_Cities", null);
            }
            return JsonConvert.SerializeObject(ds);
        }

        [HttpGet]
        public async Task<string> GetClients()
        {
            DataSet ds = null;
            if (Constants.IsAjaxRequestAccept)
            {
                ds = await DataAccess.ExecuteDatasetAsync(AppConfigurations.ConnectionString, CommandType.StoredProcedure, "BD_Select_Clients", null);
            }
            return JsonConvert.SerializeObject(ds);
        }

        [HttpGet]
        public async Task<string> GetCategories()
        {
            DataSet ds = null;
            if (Constants.IsAjaxRequestAccept)
            {
                ds = await DataAccess.ExecuteDatasetAsync(AppConfigurations.ConnectionString, CommandType.StoredProcedure, "BD_Select_Categories", null);
            }
            return JsonConvert.SerializeObject(ds);
        }
        [HttpPost]
        public int DeleteDeal(string did)
        {
            SecureQueryString OBJ = new SecureQueryString();
            try
            {
                int id = -1;
                if (did != null)
                {
                    id = Convert.ToInt32(OBJ.decrypt(Convert.ToString(did)));
                }
                if (ModelState.IsValid)
                {
                    SqlParameter[] parameters = {
                            new SqlParameter("@DealCode", SqlDbType.Int) { Value = id  },                           
                            new SqlParameter("@UpdatedBy", SqlDbType.Int) { Value = Constants.GetUserID() },
                            new SqlParameter("@UserIP", SqlDbType.VarChar) { Value = Constants.GetUserIP() }
                       };
                    if (DataAccess.ExecuteNonQuery(AppConfigurations.ConnectionString, "BD_Delete_Deal", parameters))
                    {
                        return 1;
                    }
                    else
                    {
                        return 0;
                    }
                }
                return 0;
            }
            catch (Exception ex)
            {
                LogError(ex);
                return 0;
            }
        }

        [HttpPost]
        public int MarkDeal(string did,bool isAvailable)
        {
            SecureQueryString OBJ = new SecureQueryString();
            try
            {
                int id = -1;
                if (did != null)
                {
                    id = Convert.ToInt32(OBJ.decrypt(Convert.ToString(did)));
                }
                if (ModelState.IsValid)
                {
                    SqlParameter[] parameters = {
                            new SqlParameter("@DealCode", SqlDbType.Int) { Value = id  },  
                            new SqlParameter("@IsAvailable", SqlDbType.Bit) { Value = isAvailable },
                            new SqlParameter("@UpdatedBy", SqlDbType.Int) { Value = Constants.GetUserID() },
                            new SqlParameter("@UserIP", SqlDbType.VarChar) { Value = Constants.GetUserIP() }
                       };
                    if (DataAccess.ExecuteNonQuery(AppConfigurations.ConnectionString, "BD_Mark_Deal", parameters))
                    {
                        return 1;
                    }
                    else
                    {
                        return 0;
                    }
                }
                return 0;
            }
            catch (Exception ex)
            {
                LogError(ex);
                return 0;
            }
        }
        [HttpPost]
        public int UpdateDealSequence(string sequence)
        {
            SecureQueryString OBJ = new SecureQueryString();
            try
            {  
                if (ModelState.IsValid)
                {
                    SqlParameter[] parameters = {
                            new SqlParameter("@DealSequence", SqlDbType.VarChar) { Value = sequence  },                           
                            new SqlParameter("@UpdatedBy", SqlDbType.Int) { Value = Constants.GetUserID() },
                            new SqlParameter("@UserIP", SqlDbType.VarChar) { Value = Constants.GetUserIP() }
                       };
                    if (DataAccess.ExecuteNonQuery(AppConfigurations.ConnectionString, "BD_UpdateDealSequence", parameters))
                    {
                        return 1;
                    }
                    else
                    {
                        return 0;
                    }
                }
                return 0;
            }
            catch (Exception ex)
            {
                LogError(ex);
                return 0;
            }
        }
        
       public void LogError(Exception ex)
        {
            try
            {
                SqlParameter[] parameters =
               {  new SqlParameter("@Message", SqlDbType.VarChar) { Value = ex.Message.ToString()  },
                  new SqlParameter("@Type", SqlDbType.VarChar) { Value =  ex.GetType().Name.ToString() },
                  new SqlParameter("@Description",SqlDbType.VarChar){Value= ex.StackTrace.ToString()},     
                  new SqlParameter("@UserID",SqlDbType.Int){Value= Constants.GetUserID() },
                  new SqlParameter("@UserIP",SqlDbType.VarChar){Value= Constants.GetUserIP() }
                 
               };

                DataAccess.ExecuteNonQuery(AppConfigurations.ConnectionString, "BD_Insert_Error", parameters);
            }
            catch (Exception)
            {

                throw;
            }
        }
    }

}


using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.ComponentModel.DataAnnotations;
using System.Web.Mvc;

namespace BolDealsAdmin.Models
{
    public class Deal
    {
         public int? DealID { get; set; }       
        public string DealName { get; set; }        
        public string Description { get; set; }      
        // public int Placement{get; set;}       
        public int ClientID { get; set; }       
        public int CategoryID { get; set; }
        [Required(ErrorMessage = "Please Select City")]
        public int LocationID { get; set; }        
        public string Image { get; set; }
        public List<DealImage> DetailImage { get; set; }       
        public List<ImageDetail> ImageDetailList { get; set; }
        public List<FrontImageDetail> FrontImageDetailList { get; set; }
    }
    public class DealImage {
        public int DealImageID { get; set; }
        public string slideImage { get; set; }
    }    
    public class ImageDetail  {
        public string FileName { get; set; }
        public string Location { get; set; }
         public string Extension { get; set; }
    }
    public class FrontImageDetail
    {
        public string FileName { get; set; }
        public string Location { get; set; }
        public string Extension { get; set; }
    }


}








-----------------------------------Bill

// Decompiled with JetBrains decompiler
// Type: X_Bill.frmMain
// Assembly: X-Bill, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: EF6D25A8-A6E4-450C-82C6-E3569CA45716
// Assembly location: C:\Users\ahmedadeel\Desktop\XBill Setup\X-Bill.exe

using org.apache.pdfbox.pdmodel;
using org.apache.pdfbox.util;
using Outlook;
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Configuration;
using System.Data;
using System.Data.OleDb;
using System.Drawing;
using System.Globalization;
using System.IO;
using System.Net;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading;
using System.Windows.Forms;
using X_Bill.Properties;
using X_Bill.Objects;
using System.Diagnostics;

namespace X_Bill
{
    public partial class frmMain : Form
    {
        public static bool Is_Stream_Closed = true;
        private IContainer components = (IContainer)null;
        private ArrayList files = new ArrayList();
        private ArrayList fileMerge = new ArrayList();
        private ArrayList ValidFiles = new ArrayList();
        private int countfilemerge = 0;
        private int count = 0;
        private bool flag = false;
        private string strFilePath = "";
        private string pdfString = "";
        private string AccountNo = "";
        private string PageNo = "";
        private string RegistrationNo = "";
        private string VehicleCardNo = "";
        private string DriverCardNumber = "";
        private string DriverName = "";
        private string Total = "";
        private string CurrentVolume = "";
        private string YTDVolume = "";
        private string CurrentAmount = "";
        private string YTDAmount = "";
        private string MaX_Rate_Petrol = "";
        private ListView listView1 = new ListView();
        private ArrayList fileMergeCount = new ArrayList();
        private Button btnMobile;
        private Label label1;
        private Label label2;
        private Button btnClub;
        private Button btnWater;
        private Button btnFuel;
        private DBAccess objDB;
        private string strSql;
        private PDDocument document;
        private PDFTextStripper pdfStripper;
        private string PathToRead;
        private string PathToCopy;
        private string DuplicateFilePath;
        private string MobileNumber;
        private string MemberNumber;
        private string FileName;
        private string Bill;
        private string EmployeeName;
        private string ExtNumber;
        private string SystemIP;
        private string BillDate;
        private string DateDirectory;
        private DirectoryInfo newDirectory;
        private string InboxSourceFolder;
        private string InboxDestinationFolder;
        private string BillExtension;
        private PictureBox pictureBox2;
        private Project Project;

        public frmMain()
        {
            this.InitializeComponent();
        }

        protected override void Dispose(bool disposing)
        {
            if (disposing && this.components != null)
                this.components.Dispose();
            base.Dispose(disposing);
        }

        private void InitializeComponent()
        {
            System.ComponentModel.ComponentResourceManager resources = new System.ComponentModel.ComponentResourceManager(typeof(frmMain));
            this.btnMobile = new System.Windows.Forms.Button();
            this.label1 = new System.Windows.Forms.Label();
            this.label2 = new System.Windows.Forms.Label();
            this.btnClub = new System.Windows.Forms.Button();
            this.btnWater = new System.Windows.Forms.Button();
            this.btnFuel = new System.Windows.Forms.Button();
            this.pictureBox2 = new System.Windows.Forms.PictureBox();
            ((System.ComponentModel.ISupportInitialize)(this.pictureBox2)).BeginInit();
            this.SuspendLayout();
            // 
            // btnMobile
            // 
            this.btnMobile.Font = new System.Drawing.Font("Verdana", 8F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.btnMobile.ForeColor = System.Drawing.SystemColors.AppWorkspace;
            this.btnMobile.Image = global::X_Bill.Properties.Resources.Mobile;
            this.btnMobile.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.btnMobile.Location = new System.Drawing.Point(12, 136);
            this.btnMobile.Name = "btnMobile";
            this.btnMobile.Size = new System.Drawing.Size(235, 34);
            this.btnMobile.TabIndex = 0;
            this.btnMobile.Text = "Upload Mobile Bills";
            this.btnMobile.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            this.btnMobile.UseVisualStyleBackColor = true;
            this.btnMobile.Click += new System.EventHandler(this.btnMobile_Click);
            // 
            // label1
            // 
            this.label1.AutoSize = true;
            this.label1.Font = new System.Drawing.Font("Arial Black", 15.75F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.label1.ForeColor = System.Drawing.SystemColors.AppWorkspace;
            this.label1.Location = new System.Drawing.Point(76, 44);
            this.label1.Name = "label1";
            this.label1.Size = new System.Drawing.Size(45, 30);
            this.label1.TabIndex = 2;
            this.label1.Text = "BR";
            // 
            // label2
            // 
            this.label2.AutoSize = true;
            this.label2.Font = new System.Drawing.Font("Trebuchet MS", 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.label2.ForeColor = System.Drawing.SystemColors.AppWorkspace;
            this.label2.Location = new System.Drawing.Point(23, 70);
            this.label2.Name = "label2";
            this.label2.Size = new System.Drawing.Size(117, 16);
            this.label2.TabIndex = 3;
            this.label2.Text = "Bill Reader Application";
            // 
            // btnClub
            // 
            this.btnClub.Font = new System.Drawing.Font("Verdana", 8F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.btnClub.ForeColor = System.Drawing.SystemColors.AppWorkspace;
            this.btnClub.Image = global::X_Bill.Properties.Resources.club;
            this.btnClub.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.btnClub.Location = new System.Drawing.Point(12, 228);
            this.btnClub.Name = "btnClub";
            this.btnClub.Size = new System.Drawing.Size(235, 34);
            this.btnClub.TabIndex = 2;
            this.btnClub.Text = "Upload Club Bills";
            this.btnClub.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            this.btnClub.UseVisualStyleBackColor = true;
            this.btnClub.Click += new System.EventHandler(this.btnClub_Click);
            // 
            // btnWater
            // 
            this.btnWater.Font = new System.Drawing.Font("Verdana", 8F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.btnWater.ForeColor = System.Drawing.SystemColors.AppWorkspace;
            this.btnWater.Image = global::X_Bill.Properties.Resources.Water;
            this.btnWater.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.btnWater.Location = new System.Drawing.Point(12, 183);
            this.btnWater.Name = "btnWater";
            this.btnWater.Size = new System.Drawing.Size(235, 34);
            this.btnWater.TabIndex = 1;
            this.btnWater.Text = "Upload MineralWater Bills";
            this.btnWater.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            this.btnWater.UseVisualStyleBackColor = true;
            this.btnWater.Click += new System.EventHandler(this.btnWater_Click);
            // 
            // btnFuel
            // 
            this.btnFuel.Font = new System.Drawing.Font("Verdana", 8F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
            this.btnFuel.ForeColor = System.Drawing.SystemColors.AppWorkspace;
            this.btnFuel.Image = global::X_Bill.Properties.Resources.Fuel;
            this.btnFuel.ImageAlign = System.Drawing.ContentAlignment.MiddleLeft;
            this.btnFuel.Location = new System.Drawing.Point(12, 273);
            this.btnFuel.Name = "btnFuel";
            this.btnFuel.Size = new System.Drawing.Size(235, 34);
            this.btnFuel.TabIndex = 3;
            this.btnFuel.Text = "Upload Fuel Bills";
            this.btnFuel.TextAlign = System.Drawing.ContentAlignment.MiddleRight;
            this.btnFuel.UseVisualStyleBackColor = true;
            this.btnFuel.Click += new System.EventHandler(this.btnFuel_Click);
            // 
            // pictureBox2
            // 
            this.pictureBox2.Image = global::X_Bill.Properties.Resources.Header;
            this.pictureBox2.Location = new System.Drawing.Point(12, 21);
            this.pictureBox2.Name = "pictureBox2";
            this.pictureBox2.Size = new System.Drawing.Size(70, 50);
            this.pictureBox2.TabIndex = 4;
            this.pictureBox2.TabStop = false;
            // 
            // frmMain
            // 
            this.BackColor = System.Drawing.Color.White;
            this.ClientSize = new System.Drawing.Size(258, 340);
            this.Controls.Add(this.btnFuel);
            this.Controls.Add(this.btnWater);
            this.Controls.Add(this.btnClub);
            this.Controls.Add(this.pictureBox2);
            this.Controls.Add(this.label2);
            this.Controls.Add(this.label1);
            this.Controls.Add(this.btnMobile);
            this.Icon = ((System.Drawing.Icon)(resources.GetObject("$this.Icon")));
            this.MaximizeBox = false;
            this.Name = "frmMain";
            this.StartPosition = System.Windows.Forms.FormStartPosition.CenterScreen;
            this.Text = "X-Bill";
            this.Load += new System.EventHandler(this.frmMain_Load);
            ((System.ComponentModel.ISupportInitialize)(this.pictureBox2)).EndInit();
            this.ResumeLayout(false);
            this.PerformLayout();

        }

        private void frmMain_Load(object sender, EventArgs e)
        {
            string str = ConfigurationSettings.AppSettings["BillExtension"].ToString();
            this.SystemIP = ConfigurationSettings.AppSettings["ServiceIP"].ToString();
            this.BillExtension = ConfigurationSettings.AppSettings["BillExtension"].ToString();
        }

        public void CheckFileMerger()
        {
            for (int index1 = 0; index1 < this.fileMerge.Count; ++index1)
            {
                try
                {
                    foreach (string str1 in this.fileMerge)
                    {
                        string str2 = str1.Substring(str1.LastIndexOf("-") + 1);
                        int num1 = int.Parse(str2.Remove(str2.LastIndexOf(".")));
                        int num2 = 1;
                        for (int index2 = index1 + 1; index2 < this.fileMerge.Count - index1; ++index2)
                        {
                            string str3 = this.fileMerge[index2].ToString();
                            string str4 = str3.Substring(str3.LastIndexOf("-") + 1);
                            int num3 = int.Parse(str4.Remove(str4.LastIndexOf(".")));
                            if (num1 + 1 == num3)
                            {
                                ++num2;
                                this.fileMerge.RemoveAt(index2);
                            }
                        }
                        this.fileMergeCount.Add((object)num2.ToString());
                    }
                }
                catch (System.Exception ex)
                {
                    break;
                }
            }
        }

        private void deletepdf_fuel()
        {
            try
            {
                foreach (FileInfo file in new DirectoryInfo(this.PathToRead).GetFiles())
                {
                    this.FileName = file.Name;
                    this.FileName = "\\" + this.PathToRead + "\\\\" + this.FileName;
                    if (file.Extension.ToLower() == this.BillExtension)
                        System.IO.File.Delete(this.FileName);
                }
            }
            catch (System.Exception ex)
            {
            }
        }

        private void splitpdf()
        {
            this.Project = new Project("PDF Splitter And Merger");
            ProjectPart projectPart = new ProjectPart();
            foreach (FileSystemInfo file in new DirectoryInfo(this.PathToRead).GetFiles())
                this.FileName = file.Name;
            projectPart.Load(this.PathToRead + "\\" + this.FileName);
            this.Project.Parts.Add((object)projectPart);
            int num = 0;
            foreach (int page in projectPart.Pages)
            {
                string str = Regex.Replace(Path.GetFileName(projectPart.path), ".pdf", " - " + (page + 1).ToString("00000") + ".pdf", RegexOptions.IgnoreCase);
                PdfSplitterMerger pdfSplitterMerger = new PdfSplitterMerger((Stream)System.IO.File.OpenWrite(this.PathToRead + "\\" + str));
                pdfSplitterMerger.Add((Stream)System.IO.File.OpenRead(projectPart.path), new int[1] { page });
                pdfSplitterMerger.Finish();
                ++num;
                this.ValidFiles.Add((object)(this.PathToRead + "\\" + str));
                if (!this.ChechkTotal(this.PathToRead + "\\" + str))
                {
                    this.fileMerge.Add((object)(this.PathToRead + "\\" + str));
                    ++this.count;
                }
            }
            this.pdf_merger();
            this.copy_pdf();
        }

        private void pdf_merger()
        {
            this.CheckFileMerger();
            int num1 = 0;
            foreach (string str1 in this.fileMerge)
            {
                string str2 = "";
                if (str1 != "")
                {
                    this.files.Add((object)str1);
                    ++num1;
                    int num2 = int.Parse(this.fileMergeCount[this.fileMerge.IndexOf((object)str1)].ToString());
                    for (int index = 0; index < num2; ++index)
                    {
                        string str3 = str1.Substring(str1.LastIndexOf("-") + 1);
                        int num3 = int.Parse(str3.Remove(str3.IndexOf("."))) + 1 + index;
                        this.files.Add((object)(str1.Substring(0, str1.LastIndexOf("-")) + "- " + num3.ToString("00000") + ".pdf"));
                    }
                    str2 = str1.Substring(0, str1.LastIndexOf("-"));
                    this.pdfMerger(this.PathToRead + "\\00000aaaaaa" + num1.ToString("0000") + ".pdf");
                    if (num1 == this.count)
                        break;
                }
            }
        }

        public void pdfMerger(string filepath)
        {
            PdfSplitterMerger pdfSplitterMerger = new PdfSplitterMerger((Stream)new FileStream(filepath, FileMode.Create, FileAccess.Write));
            foreach (string file in this.files)
            {
                ProjectPart projectPart = new ProjectPart();
                projectPart.Load(file);
                this.Project.Parts.Add((object)projectPart);
                this.listView1.Items.Add(projectPart.ListViewItem);
                pdfSplitterMerger.Add((Stream)System.IO.File.OpenRead(projectPart.path), projectPart.Pages);
            }
            pdfSplitterMerger.Finish();
            this.ValidFiles.Add((object)filepath);
            foreach (object file in this.files)
                this.ValidFiles.RemoveAt(this.ValidFiles.BinarySearch(file));
            this.files.Clear();
        }

        public bool ChechkTotal(string filepath)
        {
            try
            {
                this.pdfString = this.GetTextFromPDF(filepath);
                this.Total = this.pdfString.Substring(this.pdfString.LastIndexOf("Total") + 26, 52);
                this.Total = this.Total.Trim();
                this.CurrentVolume = this.Total.Substring(0, this.Total.IndexOf(' '));
                double result;
                return double.TryParse(this.CurrentVolume, out result);
            }
            catch (System.Exception ex)
            {
                this.Log_Error(ex.Message);
                return false;
            }
        }

        public string GetTextFromPDF(string PDFDoc)
        {
            return new PDFTextStripper().getText(PDDocument.load(PDFDoc));
        }

        private void copy_pdf()
        {
            foreach (string validFile in this.ValidFiles)
            {
                string destFileName = ConfigurationSettings.AppSettings["FilePathtoRead_Fuel_internal"].ToString() + validFile.Substring(validFile.LastIndexOf("\\"));
                System.IO.File.Copy(validFile, destFileName);
            }
        }

        public void getTotal()
        {
            try
            {
                this.MaX_Rate_Petrol = this.pdfString.Substring(this.pdfString.LastIndexOf("No Fleet") - 50, 50);
                this.MaX_Rate_Petrol = this.MaX_Rate_Petrol.Substring(0, this.MaX_Rate_Petrol.LastIndexOf(' '));
                this.MaX_Rate_Petrol = this.MaX_Rate_Petrol.Substring(0, this.MaX_Rate_Petrol.LastIndexOf(' '));
                this.MaX_Rate_Petrol = this.MaX_Rate_Petrol.Substring(this.MaX_Rate_Petrol.LastIndexOf(' '));
                this.MaX_Rate_Petrol = this.MaX_Rate_Petrol.Trim();
                this.Total = this.pdfString.Substring(this.pdfString.LastIndexOf("Total") + 26, 52);
                this.Total = this.Total.Trim();
                this.CurrentVolume = this.Total.Substring(0, this.Total.IndexOf(' '));
                this.YTDAmount = this.Total.Substring(this.Total.LastIndexOf(" ") + 1);
                if (this.Total.IndexOf(this.YTDAmount) != -1)
                    this.Total = this.Total.Remove(this.Total.IndexOf(this.YTDAmount));
                if (this.Total.Trim() == this.CurrentVolume.Trim())
                {
                    this.YTDVolume = this.CurrentVolume;
                    this.CurrentAmount = this.YTDAmount;
                }
                else
                {
                    this.Total = this.Total.Trim();
                    this.YTDVolume = this.Total.Substring(this.Total.LastIndexOf(' '));
                    this.Total = this.Total.Remove(this.Total.IndexOf(this.YTDVolume));
                    this.Total = this.Total.Trim();
                    this.CurrentAmount = this.Total.Substring(this.Total.LastIndexOf(' '));
                }
            }
            catch (System.Exception ex)
            {
                this.Log_Error(ex.Message);
            }
        }


        private void DownloadBills()
        {
            try
            {
                NameSpace nameSpace = ((_Application)new ApplicationClass()).GetNamespace("MAPI");
                foreach (MAPIFolder folder1 in (IEnumerable)nameSpace.Folders)
                {
                    for (int index1 = 1; index1 <= folder1.Folders.Count; ++index1)
                    {
                        if (folder1.Folders[(object)index1].Name == this.InboxSourceFolder)
                        {
                            IEnumerator enumerator = folder1.Folders[(object)index1].Items.GetEnumerator();
                            try
                            {
                                while (enumerator.MoveNext())
                                {
                                    MailItem current = (MailItem)enumerator.Current;
                                    if (current.Attachments.Count > 0)
                                    {
                                        for (int count = current.Attachments.Count; count > 0; --count)
                                        {
                                            Attachment attachment = current.Attachments[(object)count];
                                            string str = attachment.FileName.ToString();
                                            attachment.SaveAsFile(this.PathToRead + "\\" + str);
                                        }
                                    }
                                    foreach (MAPIFolder folder2 in (IEnumerable)nameSpace.Folders)
                                    {
                                        for (int index2 = 1; index2 <= folder2.Folders.Count; ++index2)
                                        {
                                            if (folder2.Folders[(object)index2].Name == this.InboxDestinationFolder)
                                            {
                                                current.Move(folder1.Folders[(object)index2]);
                                                break;
                                            }
                                        }
                                    }
                                }
                                break;
                            }
                            finally
                            {
                                IDisposable disposable = enumerator as IDisposable;
                                if (disposable != null)
                                    disposable.Dispose();
                            }
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
               // int num = (int)MessageBox.Show(ex.Message);
               DAL.ErrorLogging(ex, "DownloadBills");
            }
        }

        private string RemoveComma(string number)
        {
            return number.ToString().Trim().ToString().Replace(",", "");
        }

        private string RemoveSingleQuote(string txt)
        {
            return txt.ToString().Trim().ToString().Replace("'", "");
        }

        private void ParseData()
        {
            this.strFilePath = "C:\\Test.pdf";
            string textFromPdf = this.GetTextFromPDF(this.strFilePath);
            textFromPdf.Substring(textFromPdf.IndexOf("Account No."), textFromPdf.IndexOf('\r', textFromPdf.IndexOf("Account No.")) - textFromPdf.IndexOf("Account No.")).Replace("Account No.", "").Trim();
            textFromPdf.Substring(textFromPdf.IndexOf("Invoice date:"), textFromPdf.IndexOf("Amounts", textFromPdf.IndexOf("Invoice date:")) - textFromPdf.IndexOf("Invoice date:")).Replace("Invoice date:", "").Trim();
            foreach (string str1 in this.GetAllInfoByCardNo(textFromPdf))
            {
                str1.Substring(str1.IndexOf("Internal code:"), str1.IndexOf("Registration:", str1.IndexOf("Internal code:")) - str1.IndexOf("Internal code:")).Replace("Internal code:", "").Trim();
                str1.Substring(str1.IndexOf("Registration:"), str1.IndexOf('\r', str1.IndexOf("Registration:")) - str1.IndexOf("Registration:")).Replace("Registration:", "").Trim();
                str1.Substring(str1.IndexOf("Card No:"), str1.IndexOf('\r', str1.IndexOf("Card No:")) - str1.IndexOf("Card No:")).Replace("Card No:", "").Trim();
                str1.Substring(str1.IndexOf("Card total")).Replace("Card total", "").Split('\r')[3].Trim();
                string str2 = str1.Substring(str1.IndexOf("Card sub total"), str1.IndexOf("Card total", str1.IndexOf("Card sub total")) - str1.IndexOf("Card sub total")).Replace("Card sub total", "").Trim();
                double num1;
                string str3;
                System.Exception exception;
                switch (str2.Split('\r').Length)
                {
                    case 22:
                        num1 = Convert.ToDouble(str2.Split('\r')[3].Trim()) + Convert.ToDouble(str2.Split('\r')[10].Trim()) + Convert.ToDouble(str2.Split('\r')[17].Trim());
                        str3 = num1.ToString();
                        break;
                    case 16:
                        num1 = Convert.ToDouble(str2.Split('\r')[3].Trim()) + Convert.ToDouble(str2.Split('\r')[11].Trim());
                        str3 = num1.ToString();
                        break;
                    case 15:
                        try
                        {
                            num1 = Convert.ToDouble(str2.Split('\r')[3].Trim()) + Convert.ToDouble(str2.Split('\r')[10].Trim());
                            str3 = num1.ToString();
                            break;
                        }
                        catch (System.Exception ex)
                        {
                            exception = ex;
                            num1 = Convert.ToDouble(str2.Split('\r')[2].Trim()) + Convert.ToDouble(str2.Split('\r')[10].Trim());
                            str3 = num1.ToString();
                            break;
                        }
                    default:
                        try
                        {
                            num1 = Convert.ToDouble(str2.Split('\r')[3].Trim());
                            str3 = num1.ToString();
                        }
                        catch (System.Exception ex)
                        {
                            exception = ex;
                            str3 = Convert.ToDouble(str2.Split('\r')[2].Trim()).ToString();
                        }
                        break;
                }
                string str4 = string.Empty;
                if (str1.IndexOf("Page") > -1)
                {
                    string oldValue = str1.Substring(str1.IndexOf("Page"), str1.IndexOf("TaxInvoice", str1.IndexOf("Page")) - str1.IndexOf("Page"));
                    str4 = str1.Replace(oldValue, string.Empty).Replace("TaxInvoice", "");
                }
                string[] strArray1;
                if (str4 == string.Empty)
                    strArray1 = str1.Split('\r');
                else
                    strArray1 = str4.Split('\r');
                int length = (strArray1.Length - 4) / 4;
                int num2 = 20;
                int index1 = 0;
                string[] strArray2 = new string[length];
                int num3 = 1;
                int num4 = 3;
                int num5 = 1;
                string empty = string.Empty;
                for (int index2 = 4; index2 < strArray1.Length; ++index2)
                {
                    if (index2 <= num2)
                        strArray2[index1] = strArray2[index1] + strArray1[index2].Trim() + " ";
                    if (index2 == num2)
                    {
                        ++index1;
                        num2 += 17;
                        num4 += 17;
                        empty = string.Empty;
                        num5 = 1;
                    }
                    ++num3;
                }
            }
        }

        private bool RegexCompare(string mess)
        {
            string input = mess;
            Regex regex = new Regex("^\\d$");
            bool flag = false;
            if (regex.IsMatch(input))
                flag = true;
            return flag;
        }

        private string[] GetAllInfoByCardNo(string data)
        {
            Regex regex = new Regex("(?<FetchTitle>(Card No:[\\s|\\S]*?Card total.*[\\s|\\S]))");
            string[] strArray = new string[regex.Matches(data).Count];
            MatchCollection matchCollection = regex.Matches(data);
            int index = 0;
            string empty = string.Empty;
            foreach (Match match in matchCollection)
            {
                strArray[index] = match.Groups["FetchTitle"].Captures[0].Value;
                ++index;
            }
            return strArray;
        }

        private void ParseFuelData()
        {
            string str1 = DateTime.Now.Month.ToString();
            string str2 = DateTime.Now.Year.ToString();
            if (str1.Length == 1)
                str1 = "0" + str1;
            string path = this.PathToCopy + "\\" + str2 + str1;
            this.DateDirectory = "\\" + str2 + str1;
            if (!Directory.Exists(path))
                this.newDirectory = Directory.CreateDirectory(path);
            int num1 = 0;
            try
            {
                foreach (FileSystemInfo file in new DirectoryInfo("C:\\ff").GetFiles())
                {
                    this.FileName = file.Name;
                    this.PathToRead = "C:\\ff";
                    this.strFilePath = this.PathToRead + "\\" + this.FileName;
                    string data = System.IO.File.ReadAllText(this.strFilePath);
                    string AccountNo = data.Substring(data.IndexOf("Account No."), data.IndexOf('\r', data.IndexOf("Account No.")) - data.IndexOf("Account No.")).Replace("Account No.", "").Trim().Replace("AXACT", string.Empty).Trim();
                    string BillDate = data.Substring(data.IndexOf("Invoice date:"), data.IndexOf("Amounts", data.IndexOf("Invoice date:")) - data.IndexOf("Invoice date:")).Replace("Invoice date:", "").Trim();
                    foreach (string str3 in this.GetAllInfoByCardNo(data))
                    {
                        string DriverName = str3.Substring(str3.IndexOf("Internal code:"), str3.IndexOf("Registration:", str3.IndexOf("Internal code:")) - str3.IndexOf("Internal code:")).Replace("Internal code:", "").Trim();
                        if (num1 == 61)
                            ;
                        string RegistrationNo = str3.Substring(str3.IndexOf("Registration:"), str3.IndexOf('\r', str3.IndexOf("Registration:")) - str3.IndexOf("Registration:")).Replace("Registration:", "").Trim();
                        string VehicleCardNo = str3.Substring(str3.IndexOf("Card No:"), str3.IndexOf("Internal", str3.IndexOf("Card No:")) - str3.IndexOf("Card No:")).Replace("Card No:", "").Trim();
                        string CurrentAmount = str3.Substring(str3.IndexOf("Card total")).Replace("Card total", "").Trim().Replace('\t', ' ').Split(' ')[2].Trim();
                        string str4 = str3.Substring(str3.IndexOf("Card sub total"), str3.IndexOf("Card total", str3.IndexOf("Card sub total")) - str3.IndexOf("Card sub total")).Replace("Card sub total", "").Trim().Replace('\t', '\r');
                        int length = str4.Split('\r').Length;
                        string str5 = string.Empty;
                        string str6 = str4;
                        char[] chArray = new char[1] { '\r' };
                        foreach (string str7 in str6.Split(chArray))
                        {
                            if (str7.Trim() != string.Empty)
                                str5 = str5 + str7 + (object)'\r';
                        }
                        string CurrentVolume = str5;
                        if (CurrentVolume.Split('\r').Length == 22)
                            CurrentVolume = (Convert.ToDouble(CurrentVolume.Split('\r')[2].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[9].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[16].Trim())).ToString();
                        else if (CurrentVolume.Split('\r').Length == 15)
                            CurrentVolume = (Convert.ToDouble(CurrentVolume.Split('\r')[2].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[9].Trim())).ToString();
                        else if (CurrentVolume.Split('\r').Length == 36)
                            CurrentVolume = (Convert.ToDouble(CurrentVolume.Split('\r')[2].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[9].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[16].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[23].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[30].Trim())).ToString();
                        else if (CurrentVolume.Split('\r').Length == 29)
                            CurrentVolume = (Convert.ToDouble(CurrentVolume.Split('\r')[2].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[9].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[16].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[23].Trim())).ToString();
                        else if (CurrentVolume.Split('\r').Length == 8)
                            CurrentVolume = Convert.ToDouble(CurrentVolume.Split('\r')[2].Trim()).ToString();
                        else if (CurrentVolume.Split('\r').Length == 53)
                            CurrentVolume = Convert.ToDouble(CurrentVolume.Split('\r')[2].Trim()).ToString();
                        else if (CurrentVolume.Split('\r').Length == 60)
                        {
                            try
                            {
                                CurrentVolume = (Convert.ToDouble(CurrentVolume.Split('\r')[2].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[54].Trim())).ToString();
                            }
                            catch (System.Exception ex)
                            {
                                CurrentVolume = (Convert.ToDouble(CurrentVolume.Split('\r')[2].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[9].Trim())).ToString();
                            }
                        }
                        else if (CurrentVolume.Split('\r').Length == 67)
                            CurrentVolume = (Convert.ToDouble(CurrentVolume.Split('\r')[2].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[9].Trim()) + Convert.ToDouble(CurrentVolume.Split('\r')[61].Trim())).ToString();
                        if (!(CurrentVolume == "0"))
                            ;
                        string str8 = string.Empty;
                        if (str3.IndexOf("Page") > -1)
                        {
                            string oldValue = str3.Substring(str3.IndexOf("SHELL PAKISTAN LIMITED"), str3.IndexOf("Amount\tS.T", str3.IndexOf("SHELL PAKISTAN LIMITED")) - str3.IndexOf("SHELL PAKISTAN LIMITED"));
                            str8 = str3.Replace(oldValue, string.Empty).Replace("Amount\tS.T", "");
                        }
                        string[] strArray;
                        if (str8 == string.Empty)
                            strArray = str3.Split('\r');
                        else
                            strArray = str8.Split('\r');
                        string str9 = string.Empty;
                        foreach (string str7 in strArray)
                        {
                            if (str7.Trim() != string.Empty)
                                str9 = str9 + str7 + " ";
                        }
                        string FuelAllownceDetail = str9.Trim();
                        ++num1;
                        try
                        {
                            Convert.ToDouble(CurrentVolume);
                            Convert.ToDouble(CurrentAmount);
                        }
                        catch (System.Exception ex)
                        {
                        }
                        this.InsertFuelRecord(AccountNo, BillDate, RegistrationNo, VehicleCardNo, (string)null, DriverName, CurrentVolume, this.YTDVolume, this.YTDAmount, CurrentAmount, "0", "-1", FuelAllownceDetail);
                    }
                }
            }
            catch (System.Exception ex)
            {
                int num2 = (int)MessageBox.Show(ex.Message);
            }
        }

        private void ParseFuelDataOrignal()
        {
            string str1 = DateTime.Now.Month.ToString();
            string str2 = DateTime.Now.Year.ToString();
            if (str1.Length == 1)
                str1 = "0" + str1;
            string path = this.PathToCopy + "\\" + str2 + str1;
            this.DateDirectory = "\\" + str2 + str1;
            if (!Directory.Exists(path))
                this.newDirectory = Directory.CreateDirectory(path);
            try
            {
                foreach (FileInfo file in new DirectoryInfo("C:\\ff").GetFiles())
                {
                    this.FileName = file.Name;
                    if (file.Extension.ToLower() == this.BillExtension)
                    {
                        this.PathToRead = "C:\\ff";
                        this.strFilePath = this.PathToRead + "\\" + this.FileName;
                        string textFromPdf = this.GetTextFromPDF(this.strFilePath);
                        string AccountNo = textFromPdf.Substring(textFromPdf.IndexOf("Account No."), textFromPdf.IndexOf('\r', textFromPdf.IndexOf("Account No.")) - textFromPdf.IndexOf("Account No.")).Replace("Account No.", "").Trim().Replace("AXACT", string.Empty).Trim();
                        string BillDate = textFromPdf.Substring(textFromPdf.IndexOf("Invoice date:"), textFromPdf.IndexOf("Amounts", textFromPdf.IndexOf("Invoice date:")) - textFromPdf.IndexOf("Invoice date:")).Replace("Invoice date:", "").Trim();
                        foreach (string str3 in this.GetAllInfoByCardNo(textFromPdf))
                        {
                            string DriverName = str3.Substring(str3.IndexOf("Internal code:"), str3.IndexOf("Registration:", str3.IndexOf("Internal code:")) - str3.IndexOf("Internal code:")).Replace("Internal code:", "").Trim();
                            string RegistrationNo = str3.Substring(str3.IndexOf("Registration:"), str3.IndexOf('\r', str3.IndexOf("Registration:")) - str3.IndexOf("Registration:")).Replace("Registration:", "").Trim();
                            string VehicleCardNo = str3.Substring(str3.IndexOf("Card No:"), str3.IndexOf('\r', str3.IndexOf("Card No:")) - str3.IndexOf("Card No:")).Replace("Card No:", "").Trim();
                            string CurrentAmount = str3.Substring(str3.IndexOf("Card total")).Replace("Card total", "").Split('\t')[3].Trim();
                            string str4 = str3.Substring(str3.IndexOf("Card sub total"), str3.IndexOf("Card total", str3.IndexOf("Card sub total")) - str3.IndexOf("Card sub total")).Replace("Card sub total", "").Trim();
                            double num1;
                            string CurrentVolume;
                            System.Exception exception;
                            switch (str4.Split('\r').Length)
                            {
                                case 22:
                                    num1 = Convert.ToDouble(str4.Split('\r')[3].Trim()) + Convert.ToDouble(str4.Split('\r')[10].Trim()) + Convert.ToDouble(str4.Split('\r')[17].Trim());
                                    CurrentVolume = num1.ToString();
                                    break;
                                case 16:
                                    num1 = Convert.ToDouble(str4.Split('\r')[3].Trim()) + Convert.ToDouble(str4.Split('\r')[11].Trim());
                                    CurrentVolume = num1.ToString();
                                    break;
                                case 15:
                                    try
                                    {
                                        num1 = Convert.ToDouble(str4.Split('\r')[3].Trim()) + Convert.ToDouble(str4.Split('\r')[10].Trim());
                                        CurrentVolume = num1.ToString();
                                        break;
                                    }
                                    catch (System.Exception ex)
                                    {
                                        exception = ex;
                                        num1 = Convert.ToDouble(str4.Split('\r')[2].Trim()) + Convert.ToDouble(str4.Split('\r')[10].Trim());
                                        CurrentVolume = num1.ToString();
                                        break;
                                    }
                                default:
                                    try
                                    {
                                        num1 = Convert.ToDouble(str4.Split('\r')[3].Trim());
                                        CurrentVolume = num1.ToString();
                                    }
                                    catch (System.Exception ex)
                                    {
                                        exception = ex;
                                        CurrentVolume = Convert.ToDouble(str4.Split('\r')[2].Trim()).ToString();
                                    }
                                    break;
                            }
                            string str5 = string.Empty;
                            if (str3.IndexOf("Page") > -1)
                            {
                                string oldValue = str3.Substring(str3.IndexOf("Page"), str3.IndexOf("TaxInvoice", str3.IndexOf("Page")) - str3.IndexOf("Page"));
                                str5 = str3.Replace(oldValue, string.Empty).Replace("TaxInvoice", "");
                            }
                            string[] strArray1;
                            if (str5 == string.Empty)
                                strArray1 = str3.Split('\r');
                            else
                                strArray1 = str5.Split('\r');
                            int length = (strArray1.Length - 4) / 4;
                            int num2 = 20;
                            int index1 = 0;
                            string[] strArray2 = new string[length];
                            int num3 = 1;
                            int num4 = 3;
                            int num5 = 1;
                            string empty = string.Empty;
                            for (int index2 = 4; index2 < strArray1.Length; ++index2)
                            {
                                if (index2 <= num2)
                                    strArray2[index1] = strArray2[index1] + strArray1[index2].Trim() + " ";
                                if (index2 == num2)
                                {
                                    ++index1;
                                    num2 += 17;
                                    num4 += 17;
                                    empty = string.Empty;
                                    num5 = 1;
                                }
                                ++num3;
                            }
                            string FuelAllownceDetail = string.Empty;
                            for (int index2 = 0; index2 < strArray2.Length; ++index2)
                                FuelAllownceDetail = FuelAllownceDetail + strArray2[index2] + "\n";
                            this.InsertFuelRecord(AccountNo, BillDate, RegistrationNo, VehicleCardNo, (string)null, DriverName, CurrentVolume, this.YTDVolume, this.YTDAmount, CurrentAmount, "0", "-1", FuelAllownceDetail);
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
                int num = (int)MessageBox.Show(ex.Message);
            }
        }

        private void ParseMobileData()
        {
            string str1 = DateTime.Now.Month.ToString();
            string str2 = DateTime.Now.Year.ToString();
            if (str1.Length == 1)
                str1 = "0" + str1;
            string path = this.PathToCopy + "\\" + str2 + str1;
            this.DateDirectory = "\\" + str2 + str1;
            if (!Directory.Exists(path))
                this.newDirectory = Directory.CreateDirectory(path);
            try
            {
                foreach (FileInfo file in new DirectoryInfo(this.PathToRead).GetFiles())
                {
                    this.FileName = file.Name;
                    if (file.Extension.ToLower() == this.BillExtension)
                    {
                        try
                        {
                            this.document = PDDocument.load(this.PathToRead + "\\" + this.FileName);
                            this.pdfStripper = new PDFTextStripper();
                            string text = this.pdfStripper.getText(this.document);                           
                            string str7 = "Ufone #";
                            int num3 = text.IndexOf(str7);
                            this.MobileNumber = text.Substring(num3 + 9, 11).Trim();
                            this.Bill = "0";
                            this.BillDate = DateTime.Now.ToString("MM/dd/yyyy");
                            string sourceFileName = this.PathToRead + "\\" + this.FileName;
                            string str8 = path + "\\" + this.FileName;
                            string str9 = this.DuplicateFilePath + "\\" + this.FileName;
                            //commented by adeel.
                            if (!System.IO.File.Exists(str8))
                            {
                                this.FileName = "\\" + this.DateDirectory + "\\\\" + this.FileName;
                                this.InsertMobileRecord("0", this.MobileNumber, this.Bill, this.BillDate, this.FileName);
                                System.IO.File.Move(sourceFileName, str8);
                            }
                            else
                            {
                                if (System.IO.File.Exists(str9))
                                    System.IO.File.Delete(str9);
                                System.IO.File.Move(sourceFileName, str9);
                            }

                        }
                        catch (System.Exception ex)
                        {

                            int num = (int)MessageBox.Show(ex.Message);
                            DAL.ErrorLogging(ex, "ParseMobileDatainner");
                            //  LogError("Mobile", this.FileName, this.MobileNumber, ex.Message.ToString());

                        }


                    }
                }
            }
            catch (System.Exception ex)
            {
                int num = (int)MessageBox.Show(ex.Message);
                DAL.ErrorLogging(ex, "ParseMobileDataOuter");
            }
        }

        private void ParseClubData()
        {
            string str1 = DateTime.Now.Month.ToString();
            string str2 = DateTime.Now.Year.ToString();
            if (str1.Length == 1)
                str1 = "0" + str1;
            string path = this.PathToCopy + "\\" + str2 + str1;
            this.DateDirectory = "\\" + str2 + str1;
            if (!Directory.Exists(path))
                this.newDirectory = Directory.CreateDirectory(path);
            try
            {
                foreach (FileInfo file in new DirectoryInfo(this.PathToRead).GetFiles())
                {
                    this.FileName = file.Name;
                    if (file.Extension.ToLower() == this.BillExtension)
                    {
                        this.document = PDDocument.load(this.PathToRead + "\\" + this.FileName);
                        this.pdfStripper = new PDFTextStripper();
                        string text = this.pdfStripper.getText(this.document);
                        string str3 = "75500Member No:Name:";
                        int num1 = text.IndexOf(str3);
                        string str4 = text.Substring(num1 + 20, 10);
                        this.MemberNumber = str4.Substring(0, str4.IndexOf("M"));
                        string str5 = "REMITTANCE ---------------------- ";
                        int num2 = text.IndexOf(str5);
                        this.Bill = text.Substring(num2 + 34, 8);
                        string str6 = "Date:Total Due:";
                        int num3 = text.IndexOf(str6);
                        string str7 = text.Substring(num3 + 15, 25);
                        this.BillDate = str7.Substring(0, str7.IndexOf("-"));
                        string sourceFileName = this.PathToRead + "\\" + this.FileName;
                        string str8 = path + "\\" + this.FileName;
                        string str9 = this.DuplicateFilePath + "\\" + this.FileName;
                        if (!System.IO.File.Exists(str8))
                        {
                            this.FileName = "\\" + this.DateDirectory + "\\\\" + this.FileName;
                            this.InsertClubRecord(this.MemberNumber, this.Bill, this.BillDate, this.FileName);
                            System.IO.File.Move(sourceFileName, str8);
                        }
                        else
                        {
                            if (System.IO.File.Exists(str9))
                                System.IO.File.Delete(str9);
                            System.IO.File.Move(sourceFileName, str9);
                        }
                    }
                }
            }
            catch (System.Exception ex)
            {
                int num = (int)MessageBox.Show(ex.Message);
            }
        }

        private string GetConnectionString()
        {
            Dictionary<string, string> props = new Dictionary<string, string>();

            // XLSX - Excel 2007, 2010, 2012, 2013
            props["Provider"] = "Microsoft.ACE.OLEDB.12.0;";
            props["Extended Properties"] = "Excel 12.0 XML";
            //props["Data Source"] = "J:\\sample excel\\test.xlsx";
            props["Data Source"] = this.PathToRead + "\\" + this.FileName;
            // XLS - Excel 2003 and Older
            //props["Provider"] = "Microsoft.Jet.OLEDB.4.0";
            //props["Extended Properties"] = "Excel 8.0";
            //props["Data Source"] = "C:\\MyExcel.xls";

            StringBuilder sb = new StringBuilder();

            foreach (KeyValuePair<string, string> prop in props)
            {
                sb.Append(prop.Key);
                sb.Append('=');
                sb.Append(prop.Value);
                sb.Append(';');
            }

            return sb.ToString();
        }
        private DataSet ReadExcelFile()
        {
            OleDbConnection conn = null;
            DataSet ds = new DataSet();
            string connectionString = GetConnectionString();
            try
            {
                conn = new OleDbConnection(connectionString);
                conn.Open();
                OleDbCommand cmd = new OleDbCommand();
                cmd.Connection = conn;

                // Get all Sheets in Excel File
                DataTable dtSheet = conn.GetOleDbSchemaTable(OleDbSchemaGuid.Tables, null);

                // Loop through all Sheets to get data
                foreach (DataRow dr in dtSheet.Rows)
                {
                    string sheetName = dr["TABLE_NAME"].ToString();

                    if (!sheetName.EndsWith("$"))
                        continue;

                    // Get all rows from the Sheet
                    cmd.CommandText = "SELECT * FROM [" + sheetName + "]";

                    DataTable dt = new DataTable();
                    dt.TableName = sheetName;

                    OleDbDataAdapter da = new OleDbDataAdapter(cmd);
                    da.Fill(dt);
                    ds.Tables.Add(dt);

                    DAL.ErrorLogging("ReadExcelFile ","Rows count: "+ dt.Rows.Count);                   
                }

                cmd = null;
                conn.Close();                
                return ds;
            }
            catch (System.Exception ex)
            {               
                DAL.ErrorLogging(ex, "ReadExcelFile");
                return null;
            }
            finally
            {
                if (conn != null)
                    conn.Close();
            }
        }
        public string ParseMineralWaterData()
        {
            string Msg = "";
            string str1 = DateTime.Now.Month.ToString();
            string str2 = DateTime.Now.Year.ToString();
            if (str1.Length == 1)
                str1 = "0" + str1;
            string path = this.PathToCopy + "\\" + str2 + str1;
            this.DateDirectory = "\\" + str2 + str1;
            if (!Directory.Exists(path))
                this.newDirectory = Directory.CreateDirectory(path);
            try
            {
                foreach (FileInfo file in new DirectoryInfo(this.PathToRead).GetFiles())
                {
                    this.FileName = file.Name;
                    string sourceFileName = this.PathToRead + "\\" + this.FileName;
                    string str3 = path + "\\" + this.FileName;
                    string str4 = this.DuplicateFilePath + "\\" + this.FileName;                 
                    DataSet dsExcels = ReadExcelFile();
                    if (dsExcels != null && dsExcels.Tables.Count > 0)
                    {
                        foreach (DataTable dt in dsExcels.Tables)
                        {
                            if (dt.TableName == "MineralWater$")
                            {
                                try
                                {
                                    Msg = InsertMineralWaterRecord(dt);
                                }
                                catch (System.Exception ex)
                                {
                                    DAL.ErrorLogging(ex, "MineralWater");
                                }
                            }
                            else if (dt.TableName == "WEEKLY$")
                            {
                                try
                                {
                                    Msg = InsertMineralWaterDetail(dt);
                                }
                                catch (System.Exception ex)
                                {
                                    DAL.ErrorLogging(ex, "WEEKLY");
                                }
                            }
                            else
                            {
                                Msg = "Excel File is not in Required Format.";
                                break;
                            }
                        }
                    }
                    else
                    {
                        Msg = "No Work Sheet Found.";
                    }      
             
                    if (!System.IO.File.Exists(str3))
                    {
                        this.FileName = "\\" + this.DateDirectory + "\\\\" + this.FileName;
                        System.IO.File.Move(sourceFileName, str3);
                    }
                    else
                    {
                        if (System.IO.File.Exists(str4))
                            System.IO.File.Delete(str4);
                        System.IO.File.Move(sourceFileName, str4);
                    }
                }
                if (string.IsNullOrEmpty(this.FileName))
                {
                    Msg = "No File Exist.";
                }

            }
            catch (System.Exception ex)
            {
                DAL.ErrorLogging(ex, "ParseMineralWaterData");      
            }
            return Msg;
        }

        private void InsertMobileRecord(string ext, string mobile_no, string bill, string billdate, string file_name)
        {
            try
            {
                this.objDB = new DBAccess();
                this.strSql = "Insert_MobileBillInformation '" + ext + "','" + mobile_no + "'," + this.RemoveComma(bill) + ",'" + billdate + "','" + this.SystemIP + "','" + file_name + "','" + 1 + "'";
                this.objDB.ExecuteNonQuery(this.strSql);
            }
            catch (System.Exception ex)
            {
                int num = (int)MessageBox.Show(ex.ToString());
                DAL.ErrorLogging(ex, "InsertMobileRecord");      
            }
        }

        private void InsertClubRecord(string memeber_no, string bill, string billdate, string file_name)
        {
            try
            {
                this.objDB = new DBAccess();
                this.strSql = "Insert_ClubBillInformation '" + memeber_no + "'," + this.RemoveComma(bill) + ",'" + billdate + "','" + this.SystemIP + "','" + file_name + "'";
                this.objDB.ExecuteNonQuery(this.strSql);
            }
            catch (System.Exception ex)
            {
                int num = (int)MessageBox.Show(ex.ToString());
            }
        }

        //private void InsertMineralWaterRecord(string address, string bottleLimitPerMonth, string accountno, string dlvry_day, string dlvr_bottle, string amount)
        //{
        //  try
        //  {
        //    if (bottleLimitPerMonth == "No Limit")
        //      bottleLimitPerMonth = dlvr_bottle;
        //    this.objDB = new DBAccess();
        //    this.strSql = "Insert_MineralWaterBillInformation '" + this.RemoveSingleQuote(address) + "','" + this.RemoveSingleQuote(bottleLimitPerMonth) + "','" + this.RemoveSingleQuote(accountno) + "','" + this.RemoveSingleQuote(dlvry_day) + "','" + this.RemoveSingleQuote(dlvr_bottle) + "'," + this.RemoveSingleQuote(this.RemoveComma(amount));
        //    this.objDB.ExecuteNonQuery(this.strSql);
        //  }
        //  catch (System.Exception ex)
        //  {
        //    int num = (int) MessageBox.Show(ex.ToString());
        //  }
        //}



        private string InsertMineralWaterRecord(DataTable dt)
        {
            string Msg = "";
            try
            {
                //if (bottleLimitPerMonth == "No Limit")
                //    bottleLimitPerMonth = dlvr_bottle;
                //this.objDB = new DBAccess();
                MineralWaterBill objMWB;
                if (dt.Rows.Count > 0)
                {
                    foreach (DataRow row in dt.Rows)
                    {
                        if (!string.IsNullOrEmpty(row["ACC#"].ToString()) && !string.IsNullOrEmpty(row["QTY"].ToString()))
                        {
                            objMWB = new MineralWaterBill();
                            objMWB.AccountNo = "0000" + row["ACC#"].ToString();
                            int qty = 0;
                            if (int.TryParse(row["QTY"].ToString().Trim(), out qty))
                            {
                                objMWB.DeliveredBottles = qty;
                            }
                            else
                            {
                                objMWB.DeliveredBottles = 0;
                            }
                            double total = 0;
                            if (double.TryParse(row["TOTAL"].ToString().Trim(), out total))
                            {
                                objMWB.TotalAmount = total;
                            }
                            else
                            {
                                objMWB.TotalAmount = 0;
                            }

                            DAL.InsertMineralWaterRecord(objMWB);
                        }


                    }
                    Msg = "Mineral Water Bill Uploaded Successfully.";

                }
                else
                {
                    Msg = "No Records Found in Mineral Water Sheet.";
                }              
            }
            catch (System.Exception ex)
            {
                DAL.ErrorLogging(ex, "InsertMineralWaterRecord"); 
            }
            return Msg;
        }

        private string InsertMineralWaterDetail(DataTable dt)
        {
            string Msg = "";
            try
            {
                MineralWaterBill objMWB;
                if (dt.Rows.Count > 0)
                {
                    foreach (DataRow row in dt.Rows)
                    {
                        if (!string.IsNullOrEmpty(row["Customer Code"].ToString()))
                        {
                            objMWB = new MineralWaterBill();
                            objMWB.AccountNo = "0000" + row["Customer Code"].ToString();
                            objMWB.DeliBottleWeekly = row["5G"].ToString();
                            objMWB.DeliveryDate = row["DATE"].ToString();
                            DAL.InsertMineralWaterRecordDetails(objMWB);
                        }


                    }
                    Msg = "Mineral Water Bill Uploaded Successfully.";

                }
                else
                {
                    Msg = "No Records Found in Mineral Water Sheet.";
                }

                //this.strSql = "Insert_MineralWaterBillInformation '" + this.RemoveSingleQuote(address) + "','" + this.RemoveSingleQuote(bottleLimitPerMonth) + "','" + this.RemoveSingleQuote(accountno) + "','" + this.RemoveSingleQuote(dlvry_day) + "','" + this.RemoveSingleQuote(dlvr_bottle) + "'," + this.RemoveSingleQuote(this.RemoveComma(amount));
                // this.objDB.ExecuteNonQuery(this.strSql);
            }
            catch (System.Exception ex)
            {
                DAL.ErrorLogging(ex, "InsertMineralWaterDetail");              
            }
            return Msg;
        }
        private void InsertMineralWaterDetail(string accountno, string dlvry_date, string dlvry_qty, string nsale_id)
        {
            try
            {
                this.objDB = new DBAccess();
                this.strSql = "Insert_MineralWaterDetail '" + this.RemoveSingleQuote(accountno) + "','" + this.RemoveSingleQuote(dlvry_date) + "','" + this.RemoveSingleQuote(dlvry_qty) + "','" + this.RemoveSingleQuote(nsale_id) + "'";
                this.objDB.ExecuteNonQuery(this.strSql);
            }
            catch (System.Exception ex)
            {
                int num = (int)MessageBox.Show(ex.ToString());
            }
        }

        private void InsertFuelRecord(string AccountNo, string BillDate, string RegistrationNo, string VehicleCardNo, string DriverCardNumber, string DriverName, string CurrentVolume, string YTDVolume, string YTDAmount, string CurrentAmount, string unitprice, string filename, string FuelAllownceDetail)
        {
            try
            {
                Thread.CurrentThread.CurrentCulture = new CultureInfo("en-GB");
                DateTime dateTime = Convert.ToDateTime(BillDate);
                this.objDB = new DBAccess();
                this.strSql = "Insert_FuelBillInformation '" + AccountNo + "','" + dateTime.ToString("MM/d/yyy") + "','" + RegistrationNo + "','" + VehicleCardNo + "','" + DriverCardNumber + "','" + DriverName + "'," + this.RemoveComma(CurrentVolume) + ",'0','0'," + this.RemoveComma(CurrentAmount) + "," + this.RemoveComma(unitprice) + ",'" + filename + "','" + FuelAllownceDetail + "'";
                this.objDB.ExecuteNonQuery(this.strSql);
            }
            catch (System.Exception ex)
            {
                int num = (int)MessageBox.Show(ex.ToString());
            }
        }

        private void btnMobile_Click(object sender, EventArgs e)
        {
            try
            {
                this.PathToRead = ConfigurationSettings.AppSettings["FilePathtoRead_Mobile"].ToString();
                this.PathToCopy = ConfigurationSettings.AppSettings["FilePathtoCopy_Mobile"].ToString();
                this.DuplicateFilePath = ConfigurationSettings.AppSettings["DuplicateFilePath_Mobile"].ToString();
                this.InboxSourceFolder = ConfigurationSettings.AppSettings["InboxSourceFolder_Mobile"].ToString();
                this.InboxDestinationFolder = ConfigurationSettings.AppSettings["InboxDestinationFolder_Mobile"].ToString();
                if (!Directory.Exists(this.DuplicateFilePath))
                    Directory.CreateDirectory(this.DuplicateFilePath);
                this.DownloadBills();
                this.ParseMobileData();
                int num1 = (int)MessageBox.Show("Mobile Bills recorded.");
            }
            catch (System.Exception ex)
            {
                int num = (int)MessageBox.Show(ex.Message);
                DAL.ErrorLogging(ex, "btnMobile_Click");
            }
           
        }

        private void btnClub_Click(object sender, EventArgs e)
        {
            try
            {
                this.PathToRead = ConfigurationSettings.AppSettings["FilePathtoRead_Club"].ToString();
                this.PathToCopy = ConfigurationSettings.AppSettings["FilePathtoCopy_Club"].ToString();
                this.DuplicateFilePath = ConfigurationSettings.AppSettings["DuplicateFilePath_Club"].ToString();
                this.InboxSourceFolder = ConfigurationSettings.AppSettings["InboxSourceFolder_Club"].ToString();
                this.InboxDestinationFolder = ConfigurationSettings.AppSettings["InboxDestinationFolder_Club"].ToString();
                if (!Directory.Exists(this.DuplicateFilePath))
                    Directory.CreateDirectory(this.DuplicateFilePath);
            }
            catch (System.Exception ex)
            {
                int num = (int)MessageBox.Show(ex.Message);
            }
            this.DownloadBills();
            this.ParseClubData();
            int num1 = (int)MessageBox.Show("Club Bills recorded.");
        }

        private void btnWater_Click(object sender, EventArgs e)
        {
            try
            {
                this.PathToRead = ConfigurationSettings.AppSettings["FilePathtoRead_MineralWater"].ToString();
                this.PathToCopy = ConfigurationSettings.AppSettings["FilePathtoCopy_MineralWater"].ToString();
                this.DuplicateFilePath = ConfigurationSettings.AppSettings["DuplicateFilePath_MineralWater"].ToString();
                this.InboxSourceFolder = ConfigurationSettings.AppSettings["InboxSourceFolder_MineralWater"].ToString();
                this.InboxDestinationFolder = ConfigurationSettings.AppSettings["InboxDestinationFolder_MineralWater"].ToString();
                if (!Directory.Exists(this.DuplicateFilePath))
                    Directory.CreateDirectory(this.DuplicateFilePath);
                this.DownloadBills();
                int num = (int)MessageBox.Show(this.ParseMineralWaterData());
            }
            catch (System.Exception ex)
            {
                DAL.ErrorLogging(ex, "btnWater_Click");
            }          
        }

        private void btnFuel_Click(object sender, EventArgs e)
        {
            try
            {
                this.PathToRead = ConfigurationSettings.AppSettings["FilePathtoRead_Fuel"].ToString();
                this.PathToCopy = ConfigurationSettings.AppSettings["FilePathtoCopy_Fuel"].ToString();
                this.DuplicateFilePath = ConfigurationSettings.AppSettings["DuplicateFilePath_Fuel"].ToString();
                this.InboxSourceFolder = ConfigurationSettings.AppSettings["InboxSourceFolder_Fuel"].ToString();
                this.InboxDestinationFolder = ConfigurationSettings.AppSettings["InboxDestinationFolder_Fuel"].ToString();
                if (!Directory.Exists(this.DuplicateFilePath))
                    Directory.CreateDirectory(this.DuplicateFilePath);
            }
            catch (System.Exception ex)
            {
                int num = (int)MessageBox.Show(ex.Message);
            }
            this.PathToRead = ConfigurationSettings.AppSettings["FilePathtoRead_Fuel_internal"].ToString();
            this.ParseFuelData();
            int num1 = (int)MessageBox.Show("Fuel Bills recorded.");
        }

        public void Log_Error(string ee)
        {
            string hostName = Dns.GetHostName();
            try
            {
                this.objDB = new DBAccess();
                this.strSql = "XBill_Insert_Log '" + ee + "','" + this.DriverName + "','" + Dns.GetHostByName(hostName).AddressList[0].ToString() + "','" + this.BillDate + "'";
                this.objDB.ExecuteNonQuery(this.strSql);
            }
            catch (System.Exception ex)
            {
                int num = (int)MessageBox.Show(ex.ToString());
            }
        }

        private void LogError(string BillType, string Account, string EmployeeName, string ErrorMessage)
        //
        {
            StringBuilder message = new StringBuilder();
            message.Append("*************************" + BillType + "*******************************");
            message.Append("*************************" + DateTime.Now.ToString("dd/MON/2016 hh:mm:ss tt") + "*******************************");
            message.AppendLine();
            message.Append("-----------------------------------------------------------");
            message.Append("Account :" + Account);
            message.Append("Employee Name :" + EmployeeName);
            message.Append("Error Message :" + ErrorMessage);
            message.AppendLine();

            string path = @"C:\Program Files (x86)\Axact\errorLog.txt";

            if (!File.Exists(path))
            {
                // Create a file to write to.
                using (StreamWriter sw = File.CreateText(path))
                {
                    sw.WriteLine("******************************Xbills Error Log file******************************************");
                    sw.WriteLine(message);
                }
            }

            // This text is always added, making the file longer over time
            // if it is not deleted.
            using (StreamWriter sw = File.AppendText(path))
            {
                sw.WriteLine(message);
            }



        }

    }
}
------------------------weeklysheet.aspx
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="WeeklySheet.aspx.cs" Inherits="Attendance_WeeklySheet" %>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1" runat="server">
    <title>Members List</title>
    <link rel="stylesheet" type="text/css" href="../includes/css_ie4_ns.css" />
    <link title="win2k-cold-1" media="all" href="../Includes/calendar/calendar-win2k-cold-1.css"
        type="text/css" rel="stylesheet">
     <script src="/PayRoll_Variables/assets/includes/Calendar/calendar.js" type="text/javascript"></script>
    <script src="/PayRoll_Variables/assets/includes/Calendar/calendar-en.js" type="text/javascript"></script>
    <script src="/PayRoll_Variables/assets/includes/Calendar/calendar-setup.js" type="text/javascript"></script>
    <link title="win2k-cold-1" media="all" href="/PayRoll_Variables/assets/includes/Calendar/calendar-win2k-cold-1.css" type="text/css" rel="stylesheet" />

      <%--<script src="../includes/Calendar/calendar.js" type="text/javascript"></script>
    <script src="../includes/Calendar/calendar-en.js" type="text/javascript"></script>
    <script src="../includes/Calendar/calendar-setup.js" type="text/javascript"></script>
    <link title="win2k-cold-1" media="all" href="../includes/Calendar/calendar-win2k-cold-1.css" type="text/css" rel="stylesheet" />--%>
    <style>
        .bo {
            border: 1px solid #999999;
        }

        .bot {
            border-top: 1px solid #999999;
        }

        .bob {
            border-bottom: 1px solid #999999;
        }

        .bol {
            border-left: 1px solid #999999;
        }

        .bor {
            border-right: 1px solid #999999;
        }
    </style>
</head>
<body class="myBody">
    <form id="form1" runat="server">
        &nbsp;<table id="tblMain" border="0" cellpadding="0" cellspacing="0" width="98%"
            align="center">
            <tr>
                <td width="98%">
                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                        <tr align="center">
                            <td width="100%" height="30" colspan="4" class="GridHeader">MEMBER LIST
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td>
                    <table cellspacing="0" cellpadding="4" width="100%" align="center" border="0">
                        <tr>
                            <td id="Td1" runat="server" align="left" class="bol" style="width: 120px">Department
                            </td>
                            <td id="Td2" runat="server" align="left" width="40%">
                                <asp:DropDownList ID="ddlDepartments" runat="server" AutoPostBack="True" Width="350px"
                                    CssClass="combobox" DataTextField="deptname" DataValueField="deptID" OnSelectedIndexChanged="ddlDepartments_SelectedIndexChanged">
                                </asp:DropDownList>
                            </td>
                            <td id="Td3" runat="server" align="left" width="10%">User Status
                            </td>
                            <td id="Td4" runat="server" align="left" width="40%" class="bor">
                                <asp:DropDownList ID="ddlUserStatus" runat="server" CssClass="combobox" Width="200px"
                                    AutoPostBack="true" OnSelectedIndexChanged="ddlUserStatus_SelectedIndexChanged">
                                    <%--<asp:ListItem Selected="True" Text="Select All" Value="-1"></asp:ListItem>--%>
                                    <asp:ListItem Selected="True" Text="Active" Value="1"></asp:ListItem>
                                    <asp:ListItem Text="In-Active" Value="0"></asp:ListItem>
                                </asp:DropDownList>
                            </td>
                        </tr>
                        <tr>
                            <td id="Td10" height="25" align="left" runat="server" class="bol" style="width: 120px">User Name
                            </td>
                            <td id="Td11" height="25" align="left" runat="server">
                                <asp:TextBox ID="txtName" runat="server" CssClass="textbox" Width="350px"></asp:TextBox>
                            </td>
                            <td id="Td12" height="25" align="left" runat="server" width="10%">Users
                            </td>
                            <td id="Td13" height="25" align="left" runat="server" width="40%" class="bor">
                                <asp:DropDownList ID="ddlUsers" runat="server" AutoPostBack="false" CssClass="combobox"
                                    DataTextField="fullname" DataValueField="userid" Width="200px">
                                </asp:DropDownList>
                            </td>
                        </tr>
                        <tr>
                            <td id="Td5" height="25" align="left" runat="server" class="bol" style="width: 120px">Shift

                            </td>
                            <td id="Td6" height="25" align="left" runat="server" width="40%">
                                <asp:DropDownList ID="ddlShift" runat="server" CssClass="combobox" DataTextField="shift_name"
                                    DataValueField="shift_code" Width="350px">
                                </asp:DropDownList>
                            </td>
                            <td  height="25" align="left" runat="server"  style="width: 120px">
                                <asp:Button ID="btnSearch" runat="server" CssClass="button1" OnClick="btnSearch_Click" style="margin-top: 1px;width: 77px;"
                                Text="Search" />
                            </td>
                        </tr>
                        <tr>
                            <td height="25" align="left" class="bob bol" style="width: 120px" colspan="2">                              
                                <fieldset style="width: 460px; border-width: 1px;">
                                    <legend>Export Attendance To Excel</legend>
                                    From: 
                                    <asp:TextBox ID="txtFDate" runat="server" Width="90px">
                                    </asp:TextBox>
                                    <asp:Image ID="imgFDate" runat="server" ImageUrl="../assets/images/calendar.gif" />
                                    <script type="text/javascript">
                                        Calendar.setup({
                                            inputField: "txtFDate",      // id of the input field
                                            ifFormat: "M dd, y",       // format of the input field
                                            button: "imgFDate",   // trigger for the calendar (button ID)
                                            singleClick: true            // double-click mode
                                        });
                                    </script>
                                    To: 
                                    <asp:TextBox ID="txtTDate" runat="server" Width="90px">
                                    </asp:TextBox>
                                    <asp:Image ID="imgTDate" runat="server" ImageUrl="../assets/images/calendar.gif" />
                                    <script type="text/javascript">
                                        Calendar.setup({
                                            inputField: "txtTDate",      // id of the input field
                                            ifFormat: "M dd, y",       // format of the input field
                                            button: "imgTDate",   // trigger for the calendar (button ID)
                                            singleClick: true            // double-click mode
                                        });
                                    </script>

                                    <asp:Button ID="btnExcel" runat="server" CssClass="button1" Text="Export to Excel"
                                        OnClick="btnExcel_Click" OnClientClick="return Validate();" />
                                </fieldset>
                            </td>
                            <%--<td height="25" align="left" class="bob">&nbsp;
                            </td>--%>
                            <td height="25" align="left" class="bob">&nbsp;
                            </td>
                            <td height="25" align="left" class="bor bob">&nbsp;<%--<asp:Button ID="btnSearch" runat="server" CssClass="button1" OnClick="btnSearch_Click"
                                Text="Search" />--%>
                            </td>
                        </tr>

                        

                        <tr>
                            <td colspan="4" align="right" id="PageNoRow" style="height: 35px" runat="server">
                                <strong>
                                    <asp:Label ID="lblTotalRecords" Font-Names="Tahoma" Font-Size="8.5pt" runat="server"></asp:Label>&nbsp;</strong><asp:Button
                                        ID="cmdPrev" runat="server" Text=" << " OnClick="cmdPrev_Click" CssClass="button1"></asp:Button>&nbsp;&nbsp;<asp:Label ID="lblCurrentPage" runat="server" CssClass="bodytext"
                                            Visible="false"></asp:Label>
                                <font style="font-weight: 700; font-size: 8.5pt" face="Tahoma">Page</font>
                                <asp:DropDownList ID="ddlPageNumber" runat="server" AutoPostBack="true" OnSelectedIndexChanged="ddlPageNumber_SelectedIndexChanged"
                                    CssClass="combobox">
                                </asp:DropDownList>
                                <font style="font-weight: 700; font-size: 8.5pt" face="Tahoma">Of</font>
                                <asp:Label ID="lblTotalPage" runat="server" CssClass="bodytext"></asp:Label>&nbsp;&nbsp;
                            <asp:Button ID="cmdNext" runat="server" Text=" >> " OnClick="cmdNext_Click" CssClass="button1"></asp:Button>
                                &nbsp;
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                <div id="Div3" runat="server">
                                    <table width="100%" cellpadding="0" cellspacing="0" style="border-right: #9fabcd 1px solid; border-top: #9fabcd 1px solid; border-left: #9fabcd 1px solid; border-bottom: #9fabcd 1px solid">
                                        <tr>
                                            <td class="DG_LeaveHistory_Header" width="8%">S.No.
                                            </td>
                                            <td class="DG_LeaveHistory_Header" width="30%" id="tdReason" runat="server">&nbsp;&nbsp;Name
                                            </td>
                                            <td class="DG_LeaveHistory_Header" width="42%" id="tdmain" runat="server">&nbsp;&nbsp;Designation
                                            </td>
                                            <td class="DG_LeaveHistory_Header" width="20%" id="td9" runat="server">&nbsp;&nbsp;Shift
                                            </td>
                                        </tr>
                                        <asp:Repeater ID="LeaveRepeater" runat="server" OnItemDataBound="LeaveRepeater_ItemDataBound"
                                            OnItemCommand="LeaveRepeater_ItemCommand">
                                            <ItemTemplate>
                                                <tr>
                                                    <td id="tdchkItem" runat="server" height="20" align="center" valign="middle" style="border-right: 1px solid #DEDBDB; border-bottom: 1px solid #DEDBDB;">
                                                        <asp:Label ID="lblSNO" runat="server"></asp:Label>
                                                        <asp:Label ID="lblUserCode" runat="server" Visible="False"></asp:Label>
                                                        <asp:Label ID="lblDeptCode" runat="server" Visible="False"></asp:Label>
                                                        <asp:HiddenField ID="hdnUserStatus" runat="server" Value='<%#Eval("UserStatus") %>'></asp:HiddenField>
                                                    </td>
                                                    <td align="left" valign="middle" style="border-right: 1px solid #DEDBDB; border-bottom: 1px solid #DEDBDB;">&nbsp;&nbsp;
                                                    <asp:LinkButton ID="lbtnName" runat="server" CommandName="Name"></asp:LinkButton>
                                                    </td>
                                                    <td align="left" valign="middle" style="border-right: 1px solid #DEDBDB; border-bottom: 1px solid #DEDBDB;">&nbsp;&nbsp;
                                                    <asp:Label ID="lblDesignation" runat="server" Visible="True"></asp:Label>
                                                    </td>
                                                    <td align="left" valign="middle" class="ver11" style="border-right: 1px solid #DEDBDB; border-bottom: 1px solid #DEDBDB;">&nbsp;&nbsp;
                                                    <asp:Label ID="lblShift" runat="server" Visible="True" Text='<%#Eval("Shift_Name") %>'></asp:Label>
                                                    </td>
                                                </tr>
                                            </ItemTemplate>
                                            <AlternatingItemTemplate>
                                                <tr>
                                                    <td id="tdchkItem" runat="server" height="20" align="center" valign="middle" style="border-right: 1px solid #DEDBDB; border-bottom: 1px solid #DEDBDB;">
                                                        <asp:Label ID="lblSNO" runat="server"></asp:Label>
                                                        <asp:Label ID="lblUserCode" runat="server" Visible="False"></asp:Label>
                                                        <asp:Label ID="lblDeptCode" runat="server" Visible="False"></asp:Label>
                                                        <asp:HiddenField ID="hdnUserStatus" runat="server" Value='<%#Eval("UserStatus") %>'></asp:HiddenField>
                                                    </td>

                                                    <td align="left" valign="middle" style="border-right: 1px solid #DEDBDB; border-bottom: 1px solid #DEDBDB;">&nbsp;&nbsp;
                                                    <asp:LinkButton ID="lbtnName" runat="server" CommandName="Name"></asp:LinkButton>
                                                    </td>
                                                    <td align="left" valign="middle" style="border-right: 1px solid #DEDBDB; border-bottom: 1px solid #DEDBDB;">&nbsp;&nbsp;
                                                    <asp:Label ID="lblDesignation" runat="server" Visible="True"></asp:Label>
                                                    </td>
                                                    <td align="left" valign="middle" style="border-right: 1px solid #DEDBDB; border-bottom: 1px solid #DEDBDB;">&nbsp;&nbsp;
                                                    <asp:Label ID="lblShift" runat="server" Visible="True" Text='<%#Eval("Shift_Name") %>'></asp:Label>
                                                    </td>
                                                </tr>
                                            </AlternatingItemTemplate>
                                        </asp:Repeater>
                                    </table>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td height="40" colspan="4" align="center">&nbsp;<asp:Label ID="lblError" runat="server" ForeColor="Red"></asp:Label>
                            </td>
                        </tr>
                        <tr style="display: none">
                            <td align="center" colspan="4" height="40">
                                <asp:TextBox ID="TextBox1" runat="server" Height="1px" ReadOnly="True" Width="1px"></asp:TextBox>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </form>
</body>
</html>


using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using System.Data.SqlClient;

public partial class Attendance_WeeklySheet : PortalRights//System.Web.UI.Page
{
    DBAccess objDB = new DBAccess();
    DBAccess objDbAcessHrs = new DBAccess("ConnectionStringHrs");
    CustomBasePage objmyform = new CustomBasePage();
    protected int _iRecCount = 0, _iSrCnt = 0;

    #region Properties
    public int CurrentPage
    {
        get
        {
            // look for current page in ViewState
            object o = this.ViewState["_CurrentPage"];
            if (o == null)
                return 0; // default page index of 0
            else
                return (int)o;
        }

        set
        {
            this.ViewState["_CurrentPage"] = value;
        }
    }
    #endregion

    #region Methods

    private void FillDepartments()
    {

        try
        {
            CustomBasePage myform = new CustomBasePage();
            // objDB = new DBAccess();
            //
            string su = "";
            if (Request["su"] != null)
            {
                su = Request["su"];
            }

            string strSQL = "HR_GetDepartmentByUserID " + myform.Usercode + "," + su;
            DataSet ds = new DataSet();
            ds = (DataSet)objDB.ExecuteQuery(strSQL, ReturnType.DataSetType);
            if (ds.Tables[0].Rows.Count != 0)
            {
                ddlDepartments.DataSource = ds.Tables[0];
                ddlDepartments.DataBind();
            }
            ListItem li = new ListItem("Select All", "-1");
            ddlDepartments.Items.Insert(0, li);
        }
        catch (Exception ex)
        {
            lblError.Text = ex.Message;
        }
    }

    private void FillDeptUsers(string strDeptID, int UserStatus)
    {
        DataSet ds = new DataSet();
        try
        {
            string su = "";
            if (Request["su"] != null)
            {
                su = Request["su"];
            }

            string strSQL = "";
            CustomBasePage myform = new CustomBasePage();
            DBAccess objDB = new DBAccess();
            strSQL = "HR_GetDepartmentUserByUserIDNew @DeptID=" + strDeptID + ", @UserID=" + myform.Usercode +
                ", @IsSupportUser=" + su + ", @isactive=" + UserStatus + "";

            ds = (DataSet)objDB.ExecuteQuery(strSQL, ReturnType.DataSetType);
            ddlUsers.DataSource = ds;
            ddlUsers.DataBind();

            ListItem li = new ListItem("Select All", "-1");
            ddlUsers.Items.Insert(0, li);
        }
        catch (Exception ex)
        {
            lblError.Text = ex.Message;
        }

    }

    private void FillDepartmentShift()
    {
        DataSet ds = null;
        try
        {
            string su = "";
            if (Request["su"] != null)
            {
                su = Request["su"];
            }

            objDB = new DBAccess();
            string strSQL = "HR_Get_Shift_By_DeptIDNEW " + ddlDepartments.SelectedValue + "," + su;
            ds = (DataSet)objDB.ExecuteQuery(strSQL, ReturnType.DataSetType);
            ddlShift.DataSource = ds;
            ddlShift.DataBind();
            ddlShift.Items.Insert(0, (new ListItem("--Select--", "-1")));
        }
        catch (Exception ex)
        {
            lblError.Text = ex.Message;
        }
        finally
        {
            ds.Dispose();
        }
    }

    public void LoadData()
    {
        string su = "";
        if (Request["su"] != null)
        {
            su = Request["su"];
        }

        //Set the variables
        string spName = "";
        string UserCode = ddlUsers.SelectedValue;
        string DeptCode = ddlDepartments.SelectedValue;
        string UserName = SqlInjection.RemoveHarmfullCharacter(txtName.Text);
        string ShiftCode = ddlShift.Text;


        DataTable repeaterTable = new DataTable();
        DBAccess objDB = new DBAccess();
        CustomBasePage myform = new CustomBasePage();

        DataSet ds = new DataSet();

        spName = "GetUsers_ForWeeklySheet @DeptCode='" + DeptCode + "', @UserCode='" + UserCode +
            "', @UserName='" + UserName + "', @ShiftCode='" + ShiftCode + "', @RoleOwnerId='" + myform.Usercode +
            "', @SU=" + su + ", @IsActive=" + ddlUserStatus.SelectedValue + "";
        //Response.Write(spName);
        ds = (DataSet)objDB.ExecuteQuery(spName, ReturnType.DataSetType);

        int pagesize = Convert.ToInt32(System.Configuration.ConfigurationSettings.AppSettings["PageSize"].ToString());
        repeaterTable = ds.Tables[0];
        if (repeaterTable.Rows.Count != 0)
        {
            PagedDataSource objPds = new PagedDataSource();

            objPds.DataSource = repeaterTable.DefaultView;
            objPds.AllowPaging = true;

            if (CurrentPage == 0)
            {
                objPds.CurrentPageIndex = 0;
                _iSrCnt = 0;
            }
            else
            {
                objPds.CurrentPageIndex = CurrentPage;
                _iSrCnt = (CurrentPage * pagesize);
            }

            if (repeaterTable.Rows.Count >= pagesize)
                objPds.PageSize = pagesize;
            else
                objPds.PageSize = 0;//Items.Tables[0].Rows.Count;

            if (int.Parse(objPds.PageCount.ToString()) == (int)CurrentPage)
            {
                //CurrentPage  = int.Parse(Request["pg"].ToString()) - 2;
                CurrentPage = CurrentPage - 1;
                objPds.CurrentPageIndex = CurrentPage;
            }
            else
            {
                objPds.CurrentPageIndex = CurrentPage;
            }

            lblTotalRecords.Text = "Total Records (" + repeaterTable.Rows.Count + ")";
            lblCurrentPage.Text = "Page: " + (CurrentPage + 1).ToString() + " of "
                + objPds.PageCount.ToString();
            lblTotalPage.Text = objPds.PageCount.ToString();
            // Disable Prev or Next buttons if necessary
            cmdPrev.Enabled = !objPds.IsFirstPage;
            cmdNext.Enabled = !objPds.IsLastPage;
            LeaveRepeater.DataSource = objPds;
            LeaveRepeater.DataBind();

            //ddlPageNumber
            //if(!IsPostBack)
            //{
            ddlPageNumber.Items.Clear();
            for (int i = 1; i <= objPds.PageCount; i++)
            {
                ListItem li = new ListItem(i.ToString(), i.ToString());
                ddlPageNumber.Items.Add(li);
            }
            //}
            _iRecCount = objPds.Count;


            if (ddlPageNumber.Items.FindByValue(Convert.ToString(CurrentPage + 1)) != null)
            {
                ddlPageNumber.SelectedValue = Convert.ToString(CurrentPage + 1);
            }

            //Clears all the labels
            lblError.Text = "";
            PageNoRow.Visible = true;

        }
        else
        {
            lblError.Text = "Sorry No Record Found.....";
            LeaveRepeater.DataSource = null;
            LeaveRepeater.DataBind();
            PageNoRow.Visible = false;
        }
        //
    }

    #endregion

    #region Events

    protected void Page_Load(object sender, EventArgs e)
    {

        if (!IsPostBack)
        {
            try
            {
                txtFDate.Attributes.Add("readonly", "readonly");
                txtFDate.Text = DateTime.Today.AddDays(-1).ToString("MMMM dd, yyyy");

                txtTDate.Attributes.Add("readonly", "readonly");
                txtTDate.Text = DateTime.Today.AddDays(-1).ToString("MMMM dd, yyyy");

                FillDepartments();
                FillDeptUsers(ddlDepartments.SelectedValue, Convert.ToInt32(ddlUserStatus.SelectedValue));
                FillDepartmentShift();
                PageNoRow.Visible = false;
                LoadData();
            }
            catch (Exception ex)
            {
                lblError.Text = ex.Message;
            }
        }
    }

    protected void ddlDepartments_SelectedIndexChanged(object sender, EventArgs e)
    {
        FillDeptUsers(ddlDepartments.SelectedValue, Convert.ToInt32(ddlUserStatus.SelectedValue));
        FillDepartmentShift();
    }

    protected void cmdPrev_Click(object sender, EventArgs e)
    {
        CurrentPage -= 1;
        // Reload control
        LoadData();

    }

    protected void ddlPageNumber_SelectedIndexChanged(object sender, EventArgs e)
    {
        //Session["DSPg"] = "n";
        CurrentPage = Convert.ToInt32(ddlPageNumber.SelectedValue.ToString()) - 1;

        // Reload control
        LoadData();
    }

    protected void cmdNext_Click(object sender, EventArgs e)
    {
        CurrentPage += 1;
        LoadData();
    }

    protected void LeaveRepeater_ItemDataBound(object sender, System.Web.UI.WebControls.RepeaterItemEventArgs e)
    {
        if (e.Item.ItemType == ListItemType.Item || e.Item.ItemType == ListItemType.AlternatingItem)
        {
            Label lblUserCode = (Label)e.Item.FindControl("lblUserCode");
            Label lblDeptCode = (Label)e.Item.FindControl("lblDeptCode");
            Label lblSNo = (Label)e.Item.FindControl("lblSNo");
            Label lblDesignation = (Label)e.Item.FindControl("lblDesignation");
            LinkButton lbtnName = (LinkButton)e.Item.FindControl("lbtnName");

            _iSrCnt++;
            lblSNo.Text = _iSrCnt.ToString();
            lblUserCode.Text = Convert.ToString(DataBinder.Eval(e.Item.DataItem, "UserID"));
            lblDeptCode.Text = Convert.ToString(DataBinder.Eval(e.Item.DataItem, "Department_Code"));
            lblDesignation.Text = Convert.ToString(DataBinder.Eval(e.Item.DataItem, "JobTitle"));
            lbtnName.Text = Convert.ToString(DataBinder.Eval(e.Item.DataItem, "FullName"));


        }
    }

    protected void btnSearch_Click(object sender, EventArgs e)
    {
        try
        {
            CurrentPage = 0;
            LoadData();
        }
        catch (Exception ex)
        {
            lblError.Text = ex.Message;
        }
    }

    protected void btnExcel_Click(object sender, EventArgs e)
    {
        try
        {
        string su = "";
        if (Request["su"] != null)
        {
            su = Request["su"];
        }

        //Set the variables
        string spName = "";
        string UserCode = ddlUsers.SelectedValue;
        string DeptCode = ddlDepartments.SelectedValue;
        string UserName = SqlInjection.RemoveHarmfullCharacter(txtName.Text);
        string ShiftCode = ddlShift.Text;


        DataTable repeaterTable = new DataTable();
        DBAccess objDB = new DBAccess();
        CustomBasePage myform = new CustomBasePage();

        DataSet ds = new DataSet();

        //spName = "GetUsers_ForWeeklySheetExport @DeptCode='" + DeptCode + "', @UserCode='" + UserCode +
        //    "', @UserName='" + UserName + "', @ShiftCode='" + ShiftCode + "', @RoleOwnerId='" + myform.Usercode +
        //    "', @SU=" + su + ", @IsActive=" + ddlUserStatus.SelectedValue + ", @sdate='" + txtFDate.Text + "'" + ",@edate='" + txtTDate.Text + "'";       
        //ds = (DataSet)objDB.ExecuteQuery(spName, ReturnType.DataSetType);    
        try
        {

         using (SqlConnection conn = new SqlConnection(System.Configuration.ConfigurationSettings.AppSettings["ConnectionString"]))
                {
                    SqlCommand command = new SqlCommand("GetUsers_ForWeeklySheetExport", conn);
                    command.CommandType = CommandType.StoredProcedure;
                    command.Parameters.AddWithValue("@DeptCode", DeptCode);
                    command.Parameters.AddWithValue("@UserCode", UserCode);
                    command.Parameters.AddWithValue("@UserName", UserName);
                    command.Parameters.AddWithValue("@ShiftCode", ShiftCode);
                    command.Parameters.AddWithValue("@RoleOwnerId", myform.Usercode);
                    command.Parameters.AddWithValue("@SU", su);
                    command.Parameters.AddWithValue("@IsActive", ddlUserStatus.SelectedValue);
                    command.Parameters.AddWithValue("@sdate", txtFDate.Text);
                    command.Parameters.AddWithValue("@edate", txtTDate.Text);
                    conn.Open();
        
                  //  SqlCommand arithabortCommand = new SqlCommand("SET ARITHABORT ON", conn);
                    using (SqlDataAdapter a = new SqlDataAdapter(command))
                    {
                        a.Fill(ds);
                    }
                    conn.Close();
                } 
        }
        catch (Exception ex)
        {
            lblError.Text = ex.Message;

        }
        repeaterTable = ds.Tables[0];       
        if (repeaterTable.Rows.Count > 0)
        {
            string attachment = "attachment; filename=AttendanceReport.xls";
            Response.ClearContent();
            Response.AddHeader("content-disposition", attachment);
            Response.ContentType = "application/vnd.ms-excel";

            string html = string.Empty;

            html += "<font size='2' face='Calibri'>";
            html += "<table border='1px solid black'>";
            html += "  <tr>";
            html += "    <td rowspan='2' align='center' style='background-color: #d5e1f3;'><b>S#</b></td>";
            html += "    <td rowspan='2' align='center' style='background-color: #d5e1f3;'><b>UID</b></td>";
            html += "    <td rowspan='2' align='center' style='background-color: #d5e1f3;'><b>Name</b></td>";
            html += "    <td rowspan='2' align='center' style='background-color: #d5e1f3;'><b>Grade</b></td>";
            html += "    <td rowspan='2' align='center' style='background-color: #d5e1f3;'><b>RA / TC</b></td>";
            html += "    <td rowspan='2' align='center' style='background-color: #d5e1f3;'><b>Date</b></td>";
            html += "    <td rowspan='2' align='center' style='background-color: #d5e1f3;'><b>Off Day</b></td>";
            html += "    <td rowspan='2' align='center' style='background-color: #d5e1f3;'><b>Shift Start Time</b></td>";
            html += "    <td rowspan='2' align='center' style='background-color: #d5e1f3;'><b>Shift End Time</b></td>";
            html += "    <td colspan='3' align='center' style='background-color: #d5e1f3;'><b>Timings</b></td>";
            html += "    <td colspan='2' align='center' style='background-color: #d5e1f3;'><b>Total Breaks</b></td>";
            html += "    <td rowspan='2' align='center' style='background-color: #d5e1f3;'><b>Official Breaks</b></td>";
            html += "    <td rowspan='2' align='center' style='background-color: #d5e1f3;'><b>Shift Breaks</b></td>";
            html += "  </tr>";
            html += "  <tr>";
            html += "    <td align='center' style='background-color: #d5e1f3;'><b>Time-In</b></td>";
            html += "    <td align='center' style='background-color: #d5e1f3;'><b>Time-Out</b></td>";
            html += "    <td align='center' style='background-color: #d5e1f3;'><b>Total Hours</b></td>";
            html += "    <td align='center' style='background-color: #d5e1f3;'><b>Count</b></td>";
            html += "    <td align='center' style='background-color: #d5e1f3;'><b>Duration</b></td>";           
            html += "  </tr>";

            foreach (DataRow dr in repeaterTable.Rows)
            {
                html += "<tr>";
                html += "<td>" + dr["Sno"] + "</td>";
                html += "<td>" + dr["Userid"] + "</td>";
                html += "<td>" + dr["FullName"] + "</td>";
                html += "<td>" + dr["Grade"] + "</td>";
                html += "<td>" + dr["RA"] + "</td>";
                html += "<td>" + dr["Attendance_Day"] + "</td>";
                html += "<td>" + dr["OffDay"] + "</td>";
                html += "<td>" + dr["ShiftStartTime"] + "</td>";
                html += "<td>" + dr["ShiftEndTime"] + "</td>";
                html += "<td>" + dr["TimeIn"] + "</td>";
                html += "<td>" + dr["TimeOut"] + "</td>";
                html += "<td>" + dr["Total_Hours"] + "</td>";
                html += "<td>" + dr["Breaks"] + "</td>";
                html += "<td>" + dr["Break_Duration"] + "</td>";
                html += "<td>" + dr["OfficialBreak_Duration"] + "</td>";
                html += "<td>" + dr["ShiftBreak_Duration"] + "</td>";               
                html += "</tr>";
            }
           
            html += "</table>";
            html += "</font>";

            Response.Write(html);
            Response.Flush();
            Response.End();
    
        }
        else
        {
            lblError.Text = "No record(s) found";
        }
        }
        catch (Exception exp)
        {
            lblError.Text = exp.Message;
        }
        finally
        {
            //if (ds != null)
            //    ds.Dispose();
        }
    }
    protected void LeaveRepeater_ItemCommand(object sender, System.Web.UI.WebControls.RepeaterCommandEventArgs e)
    {
        if (e.CommandName == "Name")
        {
            string su = "";
            if (Request["su"] != null)
            {
                su = Request["su"];
            }
            Label lblUserCode = (Label)e.Item.FindControl("lblUserCode");
            Label lblDeptCode = (Label)e.Item.FindControl("lblDeptCode");
            HiddenField hdnUserStatus = (HiddenField)e.Item.FindControl("hdnUserStatus");
            Response.Redirect("ViewHRAttendance.aspx?uid=" + lblUserCode.Text + "&dept_code=" + lblDeptCode.Text + "&su="
                + su + "&ustatus=" + hdnUserStatus.Value + "");
        }
    }

    protected void ddlUserStatus_SelectedIndexChanged(object sender, EventArgs e)
    {
        try
        {
            FillDeptUsers(ddlDepartments.SelectedValue, Convert.ToInt32(ddlUserStatus.SelectedValue));
        }
        catch (Exception ex)
        {
            lblError.Text = ex.Message;
        }
    }

    #endregion

    //private void FillShifts()
    //{
    //    SqlDataReader dr = null;
    //    try
    //    {
    //        objDB = new DBAccess();
    //        string strSQL = "HR_GetAllShift";
    //        dr = (SqlDataReader)objDB.ExecuteQuery(strSQL, ReturnType.DataReaderType);
    //        ddlShift.DataSource = dr;
    //        ddlShift.DataBind();
    //        ddlShift.Items.Insert(0, (new ListItem("--Select--", "-1")));
    //    }
    //    catch (Exception ex)
    //    {
    //        lblError.Text = ex.Message;
    //    }
    //    finally
    //    {
    //        if (dr != null)
    //            dr.Close();
    //    }
    //}
}

--------------------- Manual training
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="ManualTraining.aspx.cs" Inherits="ManualTraining" ValidateRequest="true" %>

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title>Manual Training</title>

  <%--  <link rel="stylesheet" type="text/css" href="Assets/css/style.css" />--%>

    <link href="../assets/calendar/calendar-win2k-cold-1.css" rel="stylesheet" />
  <script src="../assets/calendar/calendar.js" type="text/javascript"></script>
    <script src="../assets/calendar/calendar-en.js" type="text/javascript"></script>
    <script src="../assets/calendar/calendar-setup.js" type="text/javascript"></script>
    <script src="../assets/js/jquery-1.10.2.js" type="text/javascript"></script>    
    <script src="../assets/js/popup.js" type="text/javascript"></script>
    <link href="../assets/css/popupstyle.css" rel="stylesheet" />
    <script>
        //function openModal() {
        //    $('#popUp').show(); 
        //}

        function CopyLink(txt) {
            var $temp = $("<input>");
            $("body").append($temp);
            $temp.val(txt).select();


            //document.execCommand("copy");          

            try {
                var successful = document.execCommand('copy');
                var msg = successful ? 'successful' : 'unsuccessful';
                alert('Link Copied successfully');
                $temp.remove();
            } catch (err) {
                alert('Oops, unable to copy');
                $temp.remove();
            }
        }
    </script>

    <style type="text/css">
        table{border-spacing:0px}
        label {
            margin: 0px 5px 5px 5px;
            display: inline-block !important;
            width: 50px !important;
            padding-left: 10px !important;
        }

        .calendar {
            z-index: 9999;
        }

        .highslide-html {
            background-color: white;
        }

        .highslide-html-blur {
        }

        .highslide-html-content {
            position: absolute;
            display: none;
        }

        .highslide-loading {
            display: block;
            color: black;
            font-size: 8pt;
            font-family: sans-serif;
            font-weight: bold;
            text-decoration: none;
            padding: 2px;
            border: 1px solid black;
            background-color: white;
            padding-left: 22px;
            background-image: url(Assets/highslide/graphics/loader.white.gif);
            background-repeat: no-repeat;
            background-position: 3px 1px;
        }

        a.highslide-credits, a.highslide-credits i {
            padding: 2px;
            color: silver;
            text-decoration: none;
            font-size: 10px;
        }

            a.highslide-credits:hover, a.highslide-credits:hover i {
                color: white;
                background-color: gray;
            }


        /* Styles for the popup */
        .highslide-wrapper {
            background-color: white;
        }

            .highslide-wrapper .highslide-html-content {
                width: 900px;
                padding: 5px;
                height: 550px;
            }

            .highslide-wrapper .highslide-header div {
            }

            .highslide-wrapper .highslide-header ul {
                margin: 0;
                padding: 0;
                text-align: right;
            }

                .highslide-wrapper .highslide-header ul li {
                    display: inline;
                    padding-left: 1em;
                }

                    .highslide-wrapper .highslide-header ul li.highslide-previous, .highslide-wrapper .highslide-header ul li.highslide-next {
                        display: none;
                    }

            .highslide-wrapper .highslide-header a {
                font-weight: bold;
                color: gray;
                text-transform: uppercase;
                text-decoration: none;
            }

                .highslide-wrapper .highslide-header a:hover {
                    color: black;
                }

            .highslide-wrapper .highslide-header .highslide-move a {
                cursor: move;
            }

            .highslide-wrapper .highslide-footer {
                height: 11px;
            }

                .highslide-wrapper .highslide-footer .highslide-resize {
                    float: right;
                    height: 11px;
                    width: 11px;
                    background: url(Assets/highslide/graphics/resize.gif);
                }

            .highslide-wrapper .highslide-body {
            }

        .highslide-move {
            cursor: move;
        }

        .highslide-resize {
            cursor: nw-resize;
        }

        /* These must be the last of the Highslide rules */
        .highslide-display-block {
            display: block;
        }

        .highslide-display-none {
            display: none;
        }

        .highslide {
            cursor: url(Assets/highslide/graphics/zoomin.cur), pointer;
            outline: none;
        }

            .highslide img {
                border: 2px solid gray;
            }

            .highslide:hover img {
                border: 2px solid silver;
            }

        .highslide-image {
            border-bottom: 1px solid white;
        }

        .highslide-image-blur {
        }

        a.highslide-credits:hover, a.highslide-credits:hover i {
            color: white;
            background-color: gray;
        }
    </style>
</head>
<body>
    <form id="form1" runat="server" submitdisabledcontrols="True">
        <asp:ScriptManager ID="ScriptManager1" runat="server"></asp:ScriptManager>
        <div>
            <div class="WelcomNote">
                <div class="container" style="text-align: center">
                    <h3>
                        <span>
                            <asp:Label ID="lblHeader" runat="server" Text="Manual Training"></asp:Label>
                        </span>
                    </h3>
                </div>

                <center>
                <asp:Panel ID="pnlAxactian" runat="server" BorderWidth="1" Width="60%">
                <br />
                
                    <table style="width: 50%">
                    <tr>
                        <td style="font-weight: bold; font-size: 11px; font-family: Verdana; text-align: left"><br />
                            Training Name
                        </td>                       
                        <td style="font-weight: bold; font-size: 11px; font-family: Verdana; text-align: left"><br />
                             <asp:TextBox ID="txttrainingName" runat="server" Width="254px"></asp:TextBox>
                           <%-- <asp:DropDownList ID="ddltraining" CssClass="field" runat="server" Width="250"  OnSelectedIndexChanged="ddlEvent_SelectedIndexChanged" AutoPostBack="True">
                            </asp:DropDownList>--%>
                        </td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; font-size: 11px; font-family: Verdana; text-align: left"><br />
                            From Date
                        </td>
                         <td style="font-family: Candara; font-size: medium; width: 153px;" align="left">
                            <asp:TextBox ID="txtWdate" runat="server" class="texbox" Width="123" ReadOnly="true"></asp:TextBox>&nbsp;<img
                                src="../assets/calendar/calendar.gif" width="18" height="18" id="Wdate" style="cursor: pointer"
                                title="Date selector" alt="" align="absmiddle" />
                            <script type="text/javascript">
                                Calendar.setup({
                                    inputField: "txtWdate",      // id of the input field
                                    ifFormat: "M dd, y",       // format of the input field
                                    //ifFormat       :    "y-M-dd",       // format of the input field
                                    //ifFormat       :    "M-dd-y",       // format of the input field
                                    button: "Wdate",   // trigger for the calendar (button ID)
                                    singleClick: true            // double-click mode
                                });

                            </script>
                        </td>
                    </tr>   
                        <tr>
                        <td style="font-weight: bold; font-size: 11px; font-family: Verdana; text-align: left"><br />
                            To Date
                        </td>
                         <td align="left" style="font-size: medium; font-family: Candara" valign="middle" width="49%">
                            <asp:TextBox ID="txtTdate" runat="server" class="texbox" Width="123" ReadOnly="true"></asp:TextBox>&nbsp;<img
                                src="../assets/calendar/calendar.gif" width="18" height="18" id="cal1" style="cursor: pointer"
                                title="Date selector" alt="" align="absmiddle" />
                            <script type="text/javascript">
                                Calendar.setup({
                                    inputField: "txtTdate",      // id of the input field
                                    ifFormat: "M dd, y",       // format of the input field
                                    //ifFormat       :    "y-M-dd",       // format of the input field
                                    //ifFormat       :    "M-dd-y",       // format of the input field
                                    button: "cal1",   // trigger for the calendar (button ID)
                                    singleClick: true            // double-click mode
                                });
                            </script>
                        </td>
                    </tr> 
                        <%--<tr>
                            <td style="font-weight: bold; font-size: 11px; font-family: Verdana; text-align: left"><br />
                                Quota Added
                            </td>
                            
                            <td style="font-weight: bold; font-size: 11px; font-family: Verdana; text-align: left"><br />
                                <asp:DropDownList runat="server" ID="rbIsQuota" Width="250px">
                                    <asp:ListItem Value="-1">--Select All--</asp:ListItem>
                                    <asp:ListItem Value="1">Yes</asp:ListItem>
                                    <asp:ListItem Value="0">No</asp:ListItem>
                              </asp:DropDownList>
                            </td>
                        </tr>--%>                       
                           
                        <tr>
                            <td><br /></td>
                        </tr>
                </table>
                </asp:Panel>

                <br />
                <asp:Button ID="btnSearch" runat="server" Text="Search" CssClass="button" OnClick="btnSearch_Click" CausesValidation="false" />
                <asp:Button ID="btnClear" runat="server" Text="Clear" CssClass="button" OnClick="btnClear_Click" CausesValidation="false" />
                <asp:Button ID="btnAddPopup" runat="server" Text="Add Training" CssClass="button" OnClick="openPopup_Click" CausesValidation="false" />


                    <br /><br />
                <asp:Label ID="lblMessage" ForeColor="Red" runat="server" Font-Size="12px" Font-Names="Verdana"></asp:Label><br />
                <asp:Label ID="lblMessage2" ForeColor="Red" runat="server" Font-Size="12px" Font-Names="Verdana"></asp:Label><br />

                    <asp:Repeater ID="rptData" runat="server" OnItemDataBound="rptData_ItemDataBound">
                        <HeaderTemplate>
                            <table style="width: 80%; text-align: center" cellpadding="6">
                                <thead>
                                    <tr>
                                        <td rowspan="2" style="width: 10%;font-weight: bold; font-size: 11px; font-family: Verdana; text-align: center"
                                     class="bdb bdt bdl bdr tblheader"> S#</td>
                                        
                                        <td rowspan="2"style="width: 30%;font-weight: bold; font-size: 11px; font-family: Verdana; text-align: center""
                                     class="bdb bdt bdl bdr tblheader"> Name </td>
                                   
                                        <td rowspan="2"style="width: 20%;font-weight: bold; font-size: 11px; font-family: Verdana; text-align: center""
                                     class="bdb bdt bdl bdr tblheader"> Date </td>                                                                       

                                        <td rowspan="2"style="width: 10%;font-weight: bold; font-size: 11px; font-family: Verdana; text-align: center""
                                     class="bdb bdt bdl bdr tblheader"> Venue </td>

                                        <td rowspan="2"style="width: 10%;font-weight: bold; font-size: 11px; font-family: Verdana; text-align: center""
                                     class="bdb bdt bdl bdr tblheader"> Capacity </td>

                                        <td rowspan="2"style="width: 10%;font-weight: bold; font-size: 11px; font-family: Verdana; text-align: center""
                                     class="bdb bdt bdl bdr tblheader"> ConductedBy </td>
                                        
                                        <td rowspan="2"style="width: 10%;font-weight: bold; font-size: 11px; font-family: Verdana; text-align: center""
                                     class="bdb bdt bdl bdr tblheader"> Link </td>

                                        <td rowspan="2"style="width: 10%;font-weight: bold; font-size: 11px; font-family: Verdana; text-align: center""
                                     class="bdb bdt bdl bdr tblheader"> Action </td>
                                    </tr>
                                </thead>
                            </table>
                        </HeaderTemplate>

                        <ItemTemplate>
                            <table style="width: 80%; text-align: center" cellpadding="6">
                                    <tr>
                                        <td rowspan="2" style="width: 10%; font-size: 11px; font-family: Verdana; text-align: center"
                                    class="bdb bdt bdl bdr"> <%# Eval("SNo")%></td>
                                        
                                        <td rowspan="2"style="width: 30%; font-size: 11px; font-family: Verdana; text-align: center""
                                    class="bdb bdt bdl bdr"> <%# Eval("TrainingName")%> </td>
                                   
                                        <td rowspan="2"style="width: 20%; font-size: 11px; font-family: Verdana; text-align: center""
                                    class="bdb bdt bdl bdr"> <%# Eval("TrainingDate")%> </td>                                   
                                      
                                        <td rowspan="2"style="width: 10%; font-size: 11px; font-family: Verdana; text-align: center"" 
                                    class="bdb bdt bdl bdr"> <%# Eval("Venue_Type_Name")%> </td>

                                         <td rowspan="2"style="width: 10%; font-size: 11px; font-family: Verdana; text-align: center""
                                    class="bdb bdt bdl bdr"> <%# Eval("Capacity")%> </td>

                                        <td rowspan="2"style="width: 10%; font-size: 11px; font-family: Verdana; text-align: center""
                                    class="bdb bdt bdl bdr"> <%# Eval("Name") %> </td>
                                        
                                        <%--<td rowspan="2"style="width: 10%; font-size: 11px; font-family: Verdana; text-align: center""
                                    class="bdb bdt bdl bdr">
                                            <a href="RegistrationSummary.aspx?eventId=<%# Eval("EventId")%>&eventDateCode=<%#Eval("EventDate")%>&isEditable=1" target="_blank" style="color: #4169E1; font-weight: bold"><%# Convert.ToBoolean(Eval("Quota")) == true ? "Yes": "No" %></a>
                                        </td>--%>
                                        <td rowspan="2"style="width: 10%; font-size: 11px; font-family: Verdana; text-align: center" class="bdb bdt bdl bdr">
                                           <%-- <asp:label Text="Link" id="linkTraining" runat="server" style="color: green; font-weight: bold"  CausesValidation="false" />--%>                                           
                                            <asp:HyperLink ID="hypTrainingLink" runat="server" Text="Click to Copy"></asp:HyperLink> 
                                        </td>
                                        
                                        <td rowspan="2"style="width: 10%; font-size: 11px; font-family: Verdana; text-align: center" class="bdb bdt bdl bdr">
                                            <asp:LinkButton Text="Edit" id="btnEdit" runat="server" style="color: #4169E1; font-weight: bold" OnClick="editTraining_Click" CommandArgument='<%#Eval("TrainingCode")%>' CausesValidation="false" /> &nbsp
                                             <asp:LinkButton Text="Delete" id="btnDelete" runat="server" style="color: #da5252; font-weight: bold" OnClientClick="return confirm('Are you sure you want to delete this Training?');" OnClick="deleteTraining_Click" CommandArgument='<%#Eval("TrainingCode")%>' CausesValidation="false" />
                                        </td>
                                    </tr>
                            </table>
                        </ItemTemplate>

                    </asp:Repeater>
          </center>
            </div>
        </div>

        <!-- Add/Update Popup Start -->
        <div class="popup addEvent active" id="popUp">
            <div class="inner">
                <h3><span id="addTraining" runat="server">Add Training</span> <span id="editTraining" runat="server">Edit Training</span><a href="#" class="close rfl">
                    <img src="../Assets/Images/close.png" alt="Close" width="13" height="12" /></a>
                </h3>
                <div runat="server">
                    <center>
                <asp:Label ID="Label1" ForeColor="Red" runat="server" Font-Size="12px" Font-Names="Verdana"></asp:Label><br />

                    </center>

                    <table style="margin-left: 30px">
                        <tbody>
                            <tr>
                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 30%; text-align: left;vertical-align: top;padding-top: 8px;">                                  
                                    Training Name
                                </td>

                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 70%; text-align: left">                                 
                                    <asp:TextBox ID="txtPopupTrainingName" CssClass="field" runat="server" Width="250px">
                                    </asp:TextBox><br />
                                    <asp:RequiredFieldValidator runat="server"  ControlToValidate="txtPopupTrainingName" Text="Please Enter Name" ForeColor="Red"></asp:RequiredFieldValidator>
                                </td>
                            </tr>

                            <tr>
                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 25%; text-align: left;vertical-align: top;padding-top: 8px;">
                                    
                                    Training Date
                                </td>
                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 75%; text-align: left">                                   
                                    <asp:TextBox ID="PopupTrainingDate" runat="server" Width="254px" autocomplete="off" disabled="disabled"></asp:TextBox>
                                    <img id="cal12" src="../assets/calendar/calendar.gif" style="cursor: pointer" title="Date selector" /><br />
                                    <asp:RequiredFieldValidator runat="server" ID="valEventDate" ControlToValidate="PopupTrainingDate" Text="Please Select Date" ForeColor="Red"></asp:RequiredFieldValidator><br>
                                    <asp:Label ID="dateLabel" ForeColor="Red" runat="server" Font-Size="12px" Font-Names="Verdana"></asp:Label>

                                    <script type="text/javascript">
                                        Calendar.setup({
                                            inputField: "PopupTrainingDate",      // id of the input field
                                            ifFormat: "M dd, y",       // format of the input field
                                            button: "cal12",   // trigger for the calendar (button ID)
                                            singleClick: true         // double-click mode
                                            //disableFunc: function () {
                                            //    return false;
                                            //}
                                        });
                                    </script>                              

                                </td> 
                            </tr>


                            <tr>
                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 25%; text-align: left;vertical-align: top;padding-top: 8px;">
                                  
                                    Training Time
                                    </td>
                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 75%; text-align: left">
                                  
                                    <asp:DropDownList ID="ddlPopupTimeHour" runat="server" Font-Size="12px" Font-Names="Verdana" Width="60px" CssClass="ddlCheckInTimeHour">
                                    </asp:DropDownList> :
                                     <asp:DropDownList ID="ddlPopupTimeMinutes" runat="server" Font-Size="12px" Font-Names="Verdana"  Width="60px" CssClass="ddlCheckInTimeMinutes">
                                     </asp:DropDownList>   
                                     <br />
                                    <br />
                                    <asp:CustomValidator id="TimeValidator" runat="server"  ErrorMessage="Please Select Time" Display="Dynamic"  ForeColor="Red"
                                         OnServerValidate="TimeValidator_ServerValidate"
                                         ClientValidationFunction="TimeValidator_ClientValidate" />
                                </td>
                            </tr>                 

                            <tr>
                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 25%; text-align: left;vertical-align: top;padding-top: 8px;">                                    
                                    Capacity
                                 </td>
                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 75%; text-align: left">                                   
                                    <asp:TextBox runat="server" ID="txtPopupcapacity" Width="250px"  MaxLength="3"></asp:TextBox>  <br />                                  
                                    <asp:RequiredFieldValidator runat="server" ControlToValidate="txtPopupcapacity" Text="Please Select Capacity" ForeColor="Red"></asp:RequiredFieldValidator>
                                </td>
                            </tr>                           

                            <tr>
                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 30%; text-align: left;vertical-align: top;padding-top: 8px;">
                                  
                                    Venue
                                </td>

                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 70%; text-align: left">
                                  
                                    <asp:DropDownList ID="ddlPopupVenue" CssClass="field" runat="server" Width="270px">
                                    </asp:DropDownList><br />
                                    <asp:RequiredFieldValidator runat="server" InitialValue="-1" ControlToValidate="ddlPopupVenue" Text="Please Select Venue" ForeColor="Red"></asp:RequiredFieldValidator>
                                </td>
                            </tr>
                             <tr>
                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 30%; text-align: left;vertical-align: top;padding-top: 8px;">
                                    
                                    Trainer
                                </td>

                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 70%; text-align: left">
                                    
                                    <asp:DropDownList ID="ddlPopupTrainer" CssClass="field" runat="server" Width="270px">
                                    </asp:DropDownList><br />
                                    <asp:RequiredFieldValidator runat="server" InitialValue="-1" ControlToValidate="ddlPopupTrainer" Text="Please Select Trainer" ForeColor="Red"></asp:RequiredFieldValidator>
                                </td>
                            </tr> 
                            <tr>
                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 25%; text-align: left;vertical-align: top;padding-top: 8px;">                                  
                                    Description                                      
                                <td style="font-weight: bold; font-size: 11px; font-family: Verdana; width: 75%; text-align: left">                                    
                                    <asp:TextBox runat="server" ID="txtPopupDesc" Width="250px"  MaxLength="200" TextMode="MultiLine"></asp:TextBox>  <br />                                  
                                  <%--  <asp:RequiredFieldValidator runat="server" ControlToValidate="txtPopupDesc" Text="Please Select Capacity" ForeColor="Red"></asp:RequiredFieldValidator>--%>
                                </td>
                            </tr>    

                            <tr>
                                <td>
                                    <asp:HiddenField runat="server" ID="PopupTrainingCode" /> 
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <br />

                    <center>
                        
                <asp:Button ID="btnAdd" runat="server" Text="Save" CssClass="button" OnClick="addTraining_Click" />
                <asp:Button ID="btnUpdate" runat="server" Text="Update" CssClass="button" OnClick="addTraining_Click"  />
                        <br /><br />

                    </center>
                </div>
            </div>
        </div>
        <!-- Add/Update Popup End -->

    </form>
</body>
</html>

<script> 
    $('#txtPopupTrainingName').on('keypress', function (event) {
        var regex = new RegExp("^[a-zA-Z0-9\-\ \,]+$");
        var key = String.fromCharCode(!event.charCode ? event.which : event.charCode);
        if (!regex.test(key)) {
            event.preventDefault();
            return false;
        }
    });

    $('#txtPopupcapacity').on('keypress', function (event) {
        var regex = new RegExp("^[0-9]+$");
        var key = String.fromCharCode(!event.charCode ? event.which : event.charCode);
        if (!regex.test(key)) {
            event.preventDefault();
            return false;
        }
    });

    function TimeValidator_ClientValidate(source, args) {
        if (document.getElementById("<%= ddlPopupTimeHour.ClientID %>").value == "-1" ||
        document.getElementById("<%= ddlPopupTimeMinutes.ClientID %>").value == "-1") {
           args.IsValid = false;
        }
        else {
            args.IsValid = true;
        }
    }

</script>



using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Data;
using System.IO;
using System.Web.UI.HtmlControls;
using System.Text.RegularExpressions;
using XTrainingLibrary;
using Microsoft.Practices.EnterpriseLibrary.Data;
using System.Data.Common;
public partial class ManualTraining : System.Web.UI.Page
{
    SecureQueryString objSQS = new SecureQueryString();
    protected string ArrayStore = "";
    DataTable dtHours;
    DataTable dtMinutes;
    protected void Page_Load(object sender, EventArgs e)
    {
        //if (HttpContext.Current.Request.Cookies["userid"] == null)
        //{
        //    Response.Redirect("http://myaxactweb:200/recruitment/XTrainingRedirector.aspx?url=http://xent2:200/xtraining/Admin/ManualTraining.aspx", false);
        //}
        if (!IsPostBack)
        {
            DateTime currentDate = DateTime.Now;
            var frst = new DateTime(currentDate.Year, currentDate.Month, 1);
            var lst = frst.AddMonths(1).AddDays(-1);

            txtWdate.Text = frst.ToString("MMM, dd yyyy");
            txtTdate.Text = lst.ToString("MMM, dd yyyy");
  
           // txtWdate.Text = System.DateTime.Now.AddMonths(-6).ToString("MMM, dd yyyy");
          //  txtTdate.Text = System.DateTime.Now.ToString("MMM, dd yyyy");        
             BindPopupDropdowns();            
            GetData();       
        }
    }  
  
    private void BindPopupDropdowns()
    {
        try
        {
            DataSet Venue = GetVenue();
            if (Venue != null && Venue.Tables.Count > 0 && Venue.Tables[0].Rows.Count > 0)
            {
                DataTable dt = Venue.Tables[0];
                ddlPopupVenue.DataSource = dt;
                ddlPopupVenue.DataTextField = "VenueName";
                ddlPopupVenue.DataValueField = "VenueCode";
                ddlPopupVenue.DataBind();
                ddlPopupVenue.Items.Insert(0, new ListItem("--All--", "-1"));

            }

            DataSet Trainerds = GetTrainer();
            if (Trainerds != null && Trainerds.Tables.Count > 0 && Trainerds.Tables[0].Rows.Count > 0)
            {
                DataTable dt = Trainerds.Tables[0];
                ddlPopupTrainer.DataSource = dt;
                ddlPopupTrainer.DataTextField = "TrainerName";
                ddlPopupTrainer.DataValueField = "TrainerCode";
                ddlPopupTrainer.DataBind();
                ddlPopupTrainer.Items.Insert(0, new ListItem("--All--", "-1"));
            }

            DataRow drow;
            dtHours = new DataTable();
            dtMinutes = new DataTable();

            dtHours.Columns.Add("Hours");
            dtMinutes.Columns.Add("Minutes");

            for (int count = 0; count < 24; count++)
            {
                drow = dtHours.NewRow();
                drow["Hours"] = count.ToString("00");
                dtHours.Rows.Add(drow);
            }

            for (int count = 0; count < 60; count++)
            {
                drow = dtMinutes.NewRow();
                drow["Minutes"] = count.ToString("00");
                dtMinutes.Rows.Add(drow);
            }

            ddlPopupTimeHour.DataSource = dtHours;
            ddlPopupTimeHour.DataTextField = "Hours";
            ddlPopupTimeHour.DataValueField = "Hours";
            ddlPopupTimeHour.DataBind();
            ddlPopupTimeHour.Items.Insert(0, new ListItem("HH", "-1"));

            ddlPopupTimeMinutes.DataSource = dtMinutes;
            ddlPopupTimeMinutes.DataTextField = "Minutes";
            ddlPopupTimeMinutes.DataValueField = "Minutes";
            ddlPopupTimeMinutes.DataBind();
            ddlPopupTimeMinutes.Items.Insert(0, new ListItem("MM", "-1"));            
        }
        catch (Exception ex)
        {
        }
    }

    private void GetData()
    {
        DataSet ds = new DataSet();
        DateTime? EventDate;

        ds = GetTrainingData(txttrainingName.Text, null, txtWdate.Text, txtTdate.Text);
        if (ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
        {
            rptData.Visible = true;
            lblMessage.Visible = false;
            rptData.DataSource = ds.Tables[0];
            rptData.DataBind();
        }
        else
        {
            rptData.Visible = false;
            lblMessage.Visible = true;
            lblMessage.Text = "No record found";
        }
    }

    protected void btnSearch_Click(object sender, EventArgs e)
    {
        try
        {
            GetData();
            lblMessage2.Visible = false;
        }
        catch (Exception ex)
        {
            lblMessage.Text = ex.Message.ToString();
        }
    }

    protected void btnClear_Click(object sender, EventArgs e)
    {
        txttrainingName.Text = "";
       // ddlEventDate.SelectedValue = "-1";
        DateTime currentDate = DateTime.Now;
        var frst = new DateTime(currentDate.Year, currentDate.Month, 1);
        var lst = frst.AddMonths(1).AddDays(-1);

        txtWdate.Text = frst.ToString("MMM, dd yyyy");
        txtTdate.Text = lst.ToString("MMM, dd yyyy");   
  

        lblMessage.Visible = false;
        lblMessage2.Visible = false;
        GetData();
    }

    protected void rptData_ItemDataBound(object sender, RepeaterItemEventArgs e)
    {
        if (e.Item.ItemType == ListItemType.Item || e.Item.ItemType == ListItemType.AlternatingItem)
        {
           // DropDownList ddlOrientationConductedBy = (DropDownList)e.Item.FindControl("ddlOrientationConductedBy");
           // BindTrainers(ddlOrientationConductedBy, Convert.ToString(DataBinder.Eval(e.Item.DataItem, "OrientationConductedBy")));
            HyperLink hyp = (HyperLink)e.Item.FindControl("hypTrainingLink");
            hyp.NavigateUrl = "javascript:CopyLink('http://localhost/XTrainingWeb2/UserRegistration.aspx?data=" 
                              + objSQS.encrypt(Convert.ToString(DataBinder.Eval(e.Item.DataItem, "TrainingCode"))) + "')";             
        }

    }


    protected void addTraining_Click(object sender, EventArgs e)
    {
        string TrainingDate = string.Empty;

        TrainingDate = PopupTrainingDate.Text + " " + ddlPopupTimeHour.SelectedValue
                       + ":" + ddlPopupTimeMinutes.SelectedValue;

        DataSet ds;
        int? TrainingCode;      

        if (PopupTrainingCode.Value != "")
        {
            TrainingCode = Convert.ToInt32(PopupTrainingCode.Value);
        }
        else
        {
            TrainingCode = null;
        }      
 
        string TrainingName = txtPopupTrainingName.Text.Trim();
        int capacity = Convert.ToInt16(txtPopupcapacity.Text);
        int venuecode = Convert.ToInt16(ddlPopupVenue.SelectedValue);
        int Trainercode = Convert.ToInt32(ddlPopupTrainer.SelectedValue); 
        string desc = txtPopupDesc.Text.Trim();

        DateTime TrainDate = Convert.ToDateTime(((TextBox)PopupTrainingDate.FindControl("PopupTrainingDate")).Text.Trim());

        if (TrainingCode ==  null && TrainDate < DateTime.Today)
        {
            ScriptManager.RegisterStartupScript((Page)this, GetType(), "ScriptManager1", "openModal();", true);
            dateLabel.Visible = true;
            dateLabel.Text = "Training date should not be previous date";
            Label1.Visible = false;
        }
        else
        {
            ds = InsertUpdateTraining(TrainingCode, TrainingName, desc, venuecode, capacity, TrainingDate, Trainercode);

            if (ds.Tables[0].Rows[0]["status"].ToString() == "inserted")
            {
                lblMessage2.Visible = true;
                lblMessage2.Text = "Training inserted successfully";
                //  BindEventDate(-1);
            }
            else if (ds.Tables[0].Rows[0]["status"].ToString() == "updated")
            {
                lblMessage2.Visible = true;
                lblMessage2.Text = "Training updated successfully";
            }
            else
            {
                ScriptManager.RegisterStartupScript((Page)this, GetType(), "ScriptManager1", "openModal();", true);
                Label1.Visible = true;
                Label1.Text = "Training already exist";
                dateLabel.Visible = false;
            }
            GetData();
            lblMessage2.Visible = true;
        }
    }

    protected void editTraining_Click(object sender, EventArgs e)
    {
        LinkButton btn = (LinkButton)(sender);
        int TrainingCode = Convert.ToInt16(btn.CommandArgument);

        DataSet ds = new DataSet();
        ds = GetTrainingData(string.Empty, TrainingCode, txtWdate.Text, txtTdate.Text);

        PopupTrainingCode.Value = Convert.ToString(TrainingCode);    

        txtPopupTrainingName.Text = ds.Tables[0].Rows[0]["TrainingName"].ToString();
        PopupTrainingDate.Text = Convert.ToDateTime(ds.Tables[0].Rows[0]["Training_Date"]).ToString("MMM dd, yyyy");

        ddlPopupTimeHour.SelectedValue = Convert.ToDateTime(ds.Tables[0].Rows[0]["Training_Date"]).Hour.ToString("00");
        ddlPopupTimeMinutes.SelectedValue = Convert.ToDateTime(ds.Tables[0].Rows[0]["Training_Date"]).Minute.ToString("00");
       
        txtPopupcapacity.Text = ds.Tables[0].Rows[0]["Capacity"].ToString();
        ddlPopupVenue.Text = ds.Tables[0].Rows[0]["Venue_Code"].ToString();
        ddlPopupTrainer.SelectedValue = ds.Tables[0].Rows[0]["ConductedBy"].ToString();
        txtPopupDesc.Text = ds.Tables[0].Rows[0]["TrainingDescription"].ToString();
        
        ScriptManager.RegisterStartupScript((Page)this, GetType(), "ScriptManager1", "openModal();", true);

        btnUpdate.Visible = true;
        btnAdd.Visible = false;

        editTraining.Visible = true;
        addTraining.Visible = false;
        dateLabel.Visible = false;
        lblMessage2.Visible = false;
        Label1.Visible = false;
    }
    protected void deleteTraining_Click(object sender, EventArgs e)
    {
        LinkButton btn = (LinkButton)(sender);
        int TrainingCode = Convert.ToInt16(btn.CommandArgument);
        DeleteTraining(TrainingCode);
        GetData();
    }

    
    protected void openPopup_Click(object sender, EventArgs e)
    {
        txtPopupTrainingName.Text = "";
        ddlPopupTrainer.SelectedValue = "-1";
        ddlPopupVenue.SelectedValue = "-1";
        PopupTrainingDate.Text = "";
        ddlPopupTimeHour.SelectedValue = "-1";
        ddlPopupTimeMinutes.SelectedValue = "-1";
        txtPopupcapacity.Text = "";
        txtPopupDesc.Text = "";

        PopupTrainingCode.Value = null;
        dateLabel.Visible = false;

        btnUpdate.Visible = false;
        btnAdd.Visible = true;

        editTraining.Visible = false;
        addTraining.Visible = true;
        Label1.Visible = false;
        lblMessage2.Visible = false;      
     

        ScriptManager.RegisterStartupScript((Page)this, GetType(), "ScriptManager1", "openModal();", true);
    }

    public static DataSet GetTrainingData(string TrainingName, int? TrainingCode, string FromDate, string ToDate)
    {      
        
        Database db = DatabaseFactory.CreateDatabase(Constants.XTrainingConnectionName);
        string sqlCommand = "[MT_Select_Training]";
        DbCommand dbCommand = db.GetStoredProcCommand(sqlCommand);
        dbCommand.CommandTimeout = Constants.ConnectionTimeOut;

        db.AddInParameter(dbCommand, "@TrainingName", DbType.String, TrainingName);
        db.AddInParameter(dbCommand, "@FromDate", DbType.DateTime, FromDate);
        db.AddInParameter(dbCommand, "@ToDate", DbType.DateTime, ToDate);
        db.AddInParameter(dbCommand, "@TrainingCode", DbType.Int32, TrainingCode);
        return db.ExecuteDataSet(dbCommand); 
    }
    private static DataSet GetVenue()
    {
        Database db = DatabaseFactory.CreateDatabase(Constants.XTrainingConnectionName);
        string sqlCommand = "MT_Select_Venue";
        DbCommand dbCommand = db.GetStoredProcCommand(sqlCommand);
        dbCommand.CommandTimeout = Constants.ConnectionTimeOut;
        return db.ExecuteDataSet(dbCommand);
    }
    private static DataSet GetTrainer()
    {
        Database db = DatabaseFactory.CreateDatabase(Constants.XTrainingConnectionName);
        string sqlCommand = "MT_SelectTrainer";
        DbCommand dbCommand = db.GetStoredProcCommand(sqlCommand);
        dbCommand.CommandTimeout = Constants.ConnectionTimeOut;
        return db.ExecuteDataSet(dbCommand);
    }    
    protected void TimeValidator_ServerValidate(object source, ServerValidateEventArgs args)
    {
        if (ddlPopupTimeHour.Text != "-1" && ddlPopupTimeMinutes.Text != "-1")
            args.IsValid = true;
        else
        {
            args.IsValid = false;
        }
    } 
    public static DataSet InsertUpdateTraining(int? TrainingCode, string TrainingName, string TrainingDesc, int VenueCode, int  Capacity, string TrainingDate,int ConductedBy)
    {
        Database db = DatabaseFactory.CreateDatabase(Constants.XTrainingConnectionName);
        string sqlCommand = "MT_InsertUpdate_Training";
        DbCommand dbCommand = db.GetStoredProcCommand(sqlCommand);
        dbCommand.CommandTimeout = Constants.ConnectionTimeOut;

        db.AddInParameter(dbCommand, "@TrainingCode", DbType.Int32, TrainingCode);
        db.AddInParameter(dbCommand, "@TrainingName", DbType.String, TrainingName);
        db.AddInParameter(dbCommand, "@TrainingDescription", DbType.String, TrainingDesc);
        db.AddInParameter(dbCommand, "@VenueCode", DbType.Int32, VenueCode);
        db.AddInParameter(dbCommand, "@Capacity", DbType.Int32, Capacity);        
        db.AddInParameter(dbCommand, "@TrainingDate", DbType.String, TrainingDate);
        db.AddInParameter(dbCommand, "@ConductedBy", DbType.Int32, ConductedBy);
        db.AddInParameter(dbCommand, "@UpdatedBy", DbType.Int32, GetUserId());
        db.AddInParameter(dbCommand, "@UpdatedByIP", DbType.String, GetUserIp());
        return db.ExecuteDataSet(dbCommand);
    }

    public static DataSet DeleteTraining(int TrainingCode)
    {
        Database db = DatabaseFactory.CreateDatabase(Constants.XTrainingConnectionName);
        string sqlCommand = "MT_Delete_Training";
        DbCommand dbCommand = db.GetStoredProcCommand(sqlCommand);
        dbCommand.CommandTimeout = Constants.ConnectionTimeOut;

        db.AddInParameter(dbCommand, "@TrainingCode", DbType.Int32, TrainingCode); 
        db.AddInParameter(dbCommand, "@UpdatedBy", DbType.Int32, GetUserId());
        db.AddInParameter(dbCommand, "@UpdatedByIP", DbType.String, GetUserIp());
        return db.ExecuteDataSet(dbCommand);
    }


    private static int GetUserId() {
        int user_id = -1;
        if (HttpContext.Current.Request.Cookies["userid"] != null)
        {
            user_id = Convert.ToInt32(HttpContext.Current.Request.Cookies["userid"].Value);            
        }
        return user_id;
    }  
   private static string GetUserIp() {

       if (HttpContext.Current.Request.ServerVariables["REMOTE_ADDR"] != null)
        {
           return HttpContext.Current.Request.ServerVariables["REMOTE_ADDR"].ToString();  
        }
        return "";
    }  
    

}

------------------------------------ xrec

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using ErrorLog;


namespace XRecruitmentDocumentUploadingLibrary
{
    public class UploadingOriginate
    {
        #region "Execution"
        public static void StartExecution()
        {


            UploadingFunction objEmail = new UploadingFunction();

            try
            {
                objEmail.GetDataforPDFGeneration();
            }
            catch (Exception ex)
            {
                Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), "Inner Exception in GetDataforPDFGeneration. >>> " + ex.ToString());
                LogError.Write(LogError.AppType.Candidate, ex.Message + " GetDataforPDFGeneration " + ex.StackTrace, ex, "");
            }

            try
            {
                 objEmail.SendDocument();
            }
            catch (Exception ex)
            {
                Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), "Inner Exception in Send Document. >>> " + ex.ToString());
                LogError.Write(LogError.AppType.Candidate, ex.Message + " Send Document " + ex.StackTrace, ex, "");
            }
            #region PortalSyn

            try
            {
               objEmail.GetDataforPortalPic();
            }
            catch (Exception ex)
            {
                Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), "Inner Exception in GetDataforPortalPic. >>> " + ex.ToString());
                LogError.Write(LogError.AppType.Candidate, ex.Message + " GetDataforPortalPic " + ex.StackTrace, ex, "");
            }
            try
            {
               objEmail.SyncDesignationsWithPortal();
            }
            catch (Exception ex)
            {
                Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), "Inner Exception in SyncDesignationsWithPortal. >>> " + ex.ToString());
                LogError.Write(LogError.AppType.Candidate, ex.Message + " SyncDesignationsWithPortal " + ex.StackTrace, ex, "");
            }

            try
            {
                objEmail.SyncJobRoleAndBenefitsForSupportStaffWithPortal();
            }
            catch (Exception ex)
            {
                Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), "Inner Exception in SyncJobRoleAndBenefitsForSupportStaffWithPortal. >>> " + ex.ToString());
                LogError.Write(LogError.AppType.Candidate, ex.Message + " SyncJobRoleAndBenefitsForSupportStaffWithPortal " + ex.StackTrace, ex, "");
            }
            //objEmail.SendEmailForTentativeJoining();
            //objEmail.SendEmailForBG();
            //objEmail.GetSyncDocument();

            int hour = DateTime.Now.Hour;
            int minute = DateTime.Now.Minute;
            // int hour = 3;
            //int minute = 30;

            if (hour == 3 && minute >= 30)
            {
                if (!objEmail.CheckForTodaySyncPortalSchedul(DateTime.Now.Date))
                {
                    try
                    {
                        objEmail.SyncPortalUsersData(DateTime.Now.Date);
                    }
                    catch (Exception ex)
                    {
                        Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), "Inner Exception in SyncPortalUsersData. >>> " + ex.ToString());
                        LogError.Write(LogError.AppType.Candidate, ex.Message + " SyncPortalUsersData " + ex.StackTrace, ex, "");
                    }
                    try
                    {
                        objEmail.SyncReferralPortalIDByEmailAddress();
                    }
                    catch (Exception ex)
                    {
                        Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), "Inner Exception in SyncReferralPortalIDByEmailAddress. >>> " + ex.ToString());
                        LogError.Write(LogError.AppType.Candidate, ex.Message + " SyncReferralPortalIDByEmailAddress " + ex.StackTrace, ex, "");
                    }
                    try
                    {
                        objEmail.SyncReferralPortalIDByExtension();
                    }
                    catch (Exception ex)
                    {
                        Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), "Inner Exception in SyncReferralPortalIDByExtension. >>> " + ex.ToString());
                        LogError.Write(LogError.AppType.Candidate, ex.Message + " SyncReferralPortalIDByExtension " + ex.StackTrace, ex, "");
                    }
                    try
                    {
                        objEmail.SyncCandidatesForResignation();
                    }
                    catch (Exception ex)
                    {
                        Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), "Inner Exception in SyncCandidatesForResignation. >>> " + ex.ToString());
                        LogError.Write(LogError.AppType.Candidate, ex.Message + " SyncCandidatesForResignation " + ex.StackTrace, ex, "");
                    }
                    try
                    {
                        objEmail.UpdateJobDescriptionFromPeroformanceSystem();
                    }
                    catch (Exception ex)
                    {
                        Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), "Inner Exception in UpdateJobDescriptionFromPeroformanceSystem. >>> " + ex.ToString());
                        LogError.Write(LogError.AppType.Candidate, ex.Message + " UpdateJobDescriptionFromPeroformanceSystem " + ex.StackTrace, ex, "");
                    }
                    try
                    {
                        objEmail.SyncDepartmentWithPortal();
                    }
                    catch (Exception ex)
                    {
                        Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), "Inner Exception in SyncDepartmentWithPortal. >>> " + ex.ToString());
                        LogError.Write(LogError.AppType.Candidate, ex.Message + " SyncDepartmentWithPortal " + ex.StackTrace, ex, "");
                    }
                }
            }
            #endregion
        }


        #endregion
    }
}

--__---___---

using System;
using System.Collections.Generic;
using System.Text;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Data.SqlClient;
using System.IO;
using System.Threading;
using System.Web;
using System.Net;
using Chilkat;
using System.Text.RegularExpressions;
using ErrorLog;
using System.Net.Mail;


namespace XRecruitmentDocumentUploadingLibrary
{
    public class UploadingFunction

    {
        static Ftp2 ftpClient;
        public static string FTPUserID = ConfigurationManager.AppSettings["FTPUserID"].ToString();
        public static string FTPPassword = ConfigurationManager.AppSettings["FTPPassword"].ToString();
        public static string FTPUploadAddress = ConfigurationManager.AppSettings["FTPUploadAddress"].ToString();
        public static int candidateCode = 0;
        public static int officialLetterCode = 0;
        public int CandDoc_Code = 0;
        public int documentStatus = 0;
        string documentPath = string.Empty;
        bool conn = false;


        CrystalDecisions.CrystalReports.Engine.ReportDocument objReport = null;
        string userid = Convert.ToString(ConfigurationManager.AppSettings["rUserID"]);
        string password = Convert.ToString(ConfigurationManager.AppSettings["rPassword"]);


        public void SendDocument()
        {
            //System.Diagnostics.Debugger.Launch();
            string documentStatusName = string.Empty;
            try
            {
                string path = string.Empty;
                DataTable dt = new DataTable();
                dt = (DataTable)UploadingData.GetDocumentData();
                if (dt.Rows.Count > 0)
                {
                    if (ConnectFTP(FTPUploadAddress, FTPUserID, FTPPassword))
                    {
                        foreach (DataRow dr in dt.Rows)
                        {
                            candidateCode = int.Parse(dr["Candidate_Code"].ToString());
                            CandDoc_Code = int.Parse(dr["CandDoc_Code"].ToString());
                            officialLetterCode = int.Parse(dr["OfficialLetter_Code"].ToString());
                            documentPath = dr["DocumentPath"].ToString();
                            path = ConfigurationManager.AppSettings["LocalWebServer"].ToString();
                            path = path + dr["DocumentPath"].ToString();
                            path = path.Replace("/", "\\");
                            path = path.Replace("RecruitmentDocuments", "AxactCandidateDocuments$");
                            conn = UploadDocument(FTPUploadAddress, FTPUserID, FTPPassword, path, Path.GetDirectoryName(dr["DocumentPath"].ToString()), Path.GetFileName(path));
                            if (conn)
                                documentStatus = 1;//Success
                            else
                                documentStatus = 2;//Failure
                            UploadingData.UpdateDocumentUpladingStatus(CandDoc_Code, documentStatus);
                        }
                        ftpClient.Disconnect();
                    }

                }
            }
            catch (Exception e)
            {
                Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), documentStatusName + " >>> " + e.Message);
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, "XDocumentUploadingService :: " + e.Message, e, "0");
            }
        }

        public static bool UploadDocument(string ftpUploadAddress, string ftpUploadId, string ftpUploadPassword, string localZipPath, string uploadedZipDirectory, string uploadedZipName)
        {
            //This method uploads a file from localZipPath to ftpUploadAddress using FTP credentials provided.
            //The uploaded file is uploaded to the uploadedZipDirectory with name uploadedZipName.

            bool success;

            //Check that the ftpUploadAddress does not have a directory associated with it...
            if (ftpUploadAddress.Contains("/"))
            {
                string[] directories1 = ftpUploadAddress.Split("/".ToCharArray(), StringSplitOptions.RemoveEmptyEntries);
                for (int i = 1; i < directories1.Length; i++)//start from 1 since the first element will have the IP address
                {
                    ftpClient.ChangeRemoteDir(directories1[i]);
                }
            }

            string[] directories = ftpClient.GetTextDirListing("*.*").Split(Environment.NewLine.ToCharArray(), StringSplitOptions.RemoveEmptyEntries);
            bool makeDirectory = true;
            for (int i = 0; i < directories.Length; i++)
            {

                if (ftpClient.GetIsDirectory(i))
                {
                    string temp;
                    temp = directories[i].Substring(directories[i].IndexOf("<dir>", StringComparison.OrdinalIgnoreCase) + "<dir>".Length);
                    temp = temp.TrimStart(" ".ToCharArray());
                    if (temp.Equals(uploadedZipDirectory))
                    {
                        makeDirectory = false;
                        break;
                    }
                }
            }
            if (makeDirectory)
                ftpClient.CreateRemoteDir(uploadedZipDirectory.Replace("RecruitmentDocuments", "AxactRecruitmentDocument"));
            ftpClient.ChangeRemoteDir(uploadedZipDirectory.Replace("RecruitmentDocuments", "AxactRecruitmentDocument"));

            success = ftpClient.PutFile(localZipPath, uploadedZipName);
            if (success != true)
            {
                Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), "CandidateCode=" + candidateCode +
                    " OfficialLetteCode=" + officialLetterCode + "  FilePath = " + localZipPath + " >>> " + ftpClient.LastErrorText);
                Exception ex = new Exception(ftpClient.LastErrorText);
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, "XDocumentUploadingService :: CandidateCode=" + candidateCode +
                    " OfficialLetteCode=" + officialLetterCode + "  FilePath = " + localZipPath + " >>> " + ftpClient.LastErrorText, ex, "0");

            }

            return success;
        }

        public static bool ConnectFTP(string ftpUploadAddress, string ftpUploadId, string ftpUploadPassword)
        {
            //This method uploads a file from localZipPath to ftpUploadAddress using FTP credentials provided.
            //The uploaded file is uploaded to the uploadedZipDirectory with name uploadedZipName.

            ftpClient = new Ftp2();

            bool success;
            bool successConnection;


            // Any string unlocks the component for the 1st 30-days.
            //success = ftp.UnlockComponent("Anything for 30-day trial");
            success = ftpClient.UnlockComponent("FTP!TEAM!BEAN_0C8DDF599RDZ");
            if (success != true)
            {
                throw new Exception("Chilkat component could not be unlocked. Cannot upload file using Chilkat");
            }
            //Check that the ftpUploadAddress does not have a directory associated with it...
            if (ftpUploadAddress.Contains("/"))
                ftpClient.Hostname = ftpUploadAddress.Substring(0, ftpUploadAddress.IndexOf("/"));
            else
                ftpClient.Hostname = ftpUploadAddress;
            string ftpUserName = ftpUploadId;
            string ftpPassword = ftpUploadPassword;
            ftpClient.Username = ftpUserName;
            ftpClient.Password = ftpPassword;
            ftpClient.Passive = false;
            ftpClient.Connect();
            ftpClient.SetTypeBinary();
            if (!ftpClient.IsConnected)
            {
                //throw new Exception("Could not connect to " + ftpUploadAddress);
                successConnection = false;
                Logging.WriteToLog(Logging.GenerateDefaultLogFileName("XRecruitmentDocumentUploadingService"), " >>> " + ftpClient.LastErrorText);

                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, "XDocumentUploadingService :: " + ftpClient.LastErrorText, null, null);

            }
            else
            {
                successConnection = true;
            }
            return successConnection;
        }
        public void GetDataforPDFGeneration()
        {
            int Is_SupportStaff = 0;
            int domainCode = 0;
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);
            try
            {
                connection.Open();

                SqlCommand sqlCommand = new SqlCommand("Select_CandidateOfficialDocumentForPDFGeneration", connection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
                DataSet ds = new DataSet();
                adapter.Fill(ds);

                if (ds.Tables[0].Rows.Count > 0)
                {
                    for (int i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                    {
                        try
                        {
                            candidateCode = int.Parse(ds.Tables[0].Rows[i]["Candidate_Code"].ToString());
                            CandDoc_Code = int.Parse(ds.Tables[0].Rows[i]["CandDoc_Code"].ToString());
                            officialLetterCode = int.Parse(ds.Tables[0].Rows[i]["OfficialLetter_Code"].ToString());
                            int refNo = int.Parse(ds.Tables[0].Rows[i]["RefNo"].ToString());
                            Is_SupportStaff = int.Parse(ds.Tables[0].Rows[i]["Is_SupportStaff"].ToString());
                            domainCode = int.Parse(ds.Tables[0].Rows[i]["Domain_Code"].ToString());
                            CreatePdf(refNo.ToString(), officialLetterCode, candidateCode, Is_SupportStaff, domainCode);
                        }
                        catch (Exception ex)
                        {
                            ErrorLog.LogError.Write(LogError.AppType.RecruitmentAdmin, ex.Message + " " + ex.StackTrace, ex, "");
                        }

                    }
                }

            }
            catch (Exception ex)
            {
                //throw exp1;
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, "XDocumentUploadingService :: " + ex.StackTrace, ex, null);
            }
            finally
            {
                if (connection.State != ConnectionState.Closed)
                {
                    connection.Close();
                }
            }
        }

        protected void CreatePdf(string refNo, int reportCode, int candidateCode, int Is_SupportStaff, int domainCode)
        {
            CrystalDecisions.Shared.ExportOptions ExpOptions;
            CrystalDecisions.Shared.DiskFileDestinationOptions FileDesOption;
            CrystalDecisions.Shared.TableLogOnInfo ConInfo = new CrystalDecisions.Shared.TableLogOnInfo();
            CrystalDecisions.Shared.ParameterDiscreteValue paraValue = new CrystalDecisions.Shared.ParameterDiscreteValue();
            objReport = new CrystalDecisions.CrystalReports.Engine.ReportDocument();



            string path = string.Empty;
            switch (reportCode)
            {
                case (int)ReportCode.CandidateOfferLetter:
                    if (Is_SupportStaff == 0)
                    {
                        if (domainCode != 50 && domainCode != 60)
                            path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\CandidateOfferLetter.rpt";
                        else
                            path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\BOLCandidateOfferLetter.rpt";
                    }
                    else
                        path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\SupportStaffOfferLetter.rpt";
                    break;

                case (int)ReportCode.Appointment_FirstPage:
                    if (domainCode != 50 && domainCode != 60)
                        path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\Appointment_FirstPage.rpt";
                    else
                        path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\BOLAppointment_FirstPage.rpt";
                    break;

                case (int)ReportCode.CandidateAppointmentLetter:
                    if (Is_SupportStaff == 0)
                    {
                        if (domainCode != 50 && domainCode != 60)
                            path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\CandidateAppointmentLetter.rpt";
                        else
                            path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\BOLCandidateAppointmentLetter.rpt";
                    }
                    else
                        path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\SupportStaffAppointmentLetter.rpt";
                    break;

                case (int)ReportCode.FirstPage_OfferLetter:
                    if (domainCode != 50 && domainCode != 60)
                        path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\FirstPage_OfferLetter.rpt";
                    else
                        path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\BOLFirstPage_OfferLetter.rpt";
                    break;
                case (int)ReportCode.FirstLastPageOfferLetter:
                    if (domainCode != 50 && domainCode != 60)
                        path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\FirstLastPage_OfferLetter.rpt";
                    else
                        path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\BOLFirstLastPage_OfferLetter.rpt";
                    break;
                case (int)ReportCode.FirstLastPageAppointmentLetter:
                    if (domainCode != 50 && domainCode != 60)
                        path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\FirstLastPage_AppointmentLetter.rpt";
                    else
                        path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\BOLFirstLastPage_AppointmentLetter.rpt";
                    break;

                case (int)ReportCode.Envalope:
                    path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\PrintEnvelopA4.rpt";
                    break;
                case (int)ReportCode.RemunerationSheet:
                    path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\RemunerationSheet.rpt";
                    break;
                //case (int)ReportCode.MedicalLetter:
                //    path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\MedicalLetter_org.rpt";
                //    break;

                case (int)ReportCode.EmploymentVerificationLetter:
                    //if (domainCode != 50 && domainCode != 60)
                    //    path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\FirstLastPage_OfferLetter.rpt";
                    //else
                    path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\EmploymentVerificationLetter.rpt";
                    break;
                case (int)ReportCode.MedicalLetter:
                    if (Is_SupportStaff == 0)
                    {
                        path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\MedicalLetter_org.rpt";
                    }
                    else
                    {
                        path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\SupportStaffMedicalLetter_org.rpt";
                    }
                    break;
                case (int)ReportCode.AddressVerificationLetter:
                    //if (domainCode != 50 && domainCode != 60)
                    //    path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\FirstLastPage_OfferLetter.rpt";
                    //else
                    path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\AddressVerificationLetter.rpt";
                    break;
                
                case (int)ReportCode.DiscreoantUserAppointmentLetter:
                    path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\CandidateDiscrepantAppointmentLetter.rpt";
                    break;
            }


            objReport.Load(path);


            string strTemp ="";
            string DirPath;
            string strExportFile;
            objReport.SetDatabaseLogon(userid, password);

            objReport.SetParameterValue(0, refNo);
            //DirPath = Server.MapPath("cr");

            switch (reportCode)
            {
                case (int)ReportCode.CandidateOfferLetter:
                    strTemp = "CandidateOfferLetter.pdf";
                    officialLetterCode = 1;
                    break;
                case (int)ReportCode.Appointment_FirstPage:
                    strTemp = "Appointment_FirstPage.pdf";
                    officialLetterCode = 7;
                    break;
                case (int)ReportCode.Envalope:
                    strTemp = "Envalope.pdf";
                    officialLetterCode = 8;
                    break;
                case (int)ReportCode.CandidateAppointmentLetter:
                    strTemp = "CandidateAppointmentLetter.pdf";
                    officialLetterCode = 2;
                    break;
                case (int)ReportCode.FirstPage_OfferLetter:
                    strTemp = "FirstPage_OfferLetter.pdf";
                    officialLetterCode = 6;
                    break;
                //case (int)ReportCode.MedicalLetter:
                //    strTemp = "MedicalLetter_org.pdf";
                //    officialLetterCode = 3;
                //    break;
                case (int)ReportCode.MedicalLetter:
                    strTemp = "MedicalLetter_org.doc";
                    officialLetterCode = 3;
                    break;
                case (int)ReportCode.RemunerationSheet:
                    strTemp = "RemunerationSheet.pdf";
                    officialLetterCode = 5;
                    break;

                case (int)ReportCode.FirstLastPageOfferLetter:
                    strTemp = "FirstLastPage_OfferLetter.pdf";
                    officialLetterCode = 10;
                    break;
                case (int)ReportCode.FirstLastPageAppointmentLetter:
                    strTemp = "FirstLastPage_AppointmentLetter.pdf";
                    officialLetterCode = 11;
                    break;
                case (int)ReportCode.EmploymentVerificationLetter:
                    strTemp = "EmploymentVerificationLetter.pdf";
                    officialLetterCode = 12;
                    break;
                case (int)ReportCode.AddressVerificationLetter:
                    strTemp = "AddressVerificationLetter.pdf";
                    officialLetterCode = 13;
                    break;
                case (int)ReportCode.DiscreoantUserAppointmentLetter:
                    strTemp = "DiscrepantUserAppointmentLetter.pdf";
                    officialLetterCode = 14;
                    break;
              
            }
            strExportFile = ConfigurationManager.AppSettings["PathforPDF"].ToString();
            CreateFolder(strExportFile += refNo);
            strExportFile += "\\" + strTemp;


            SaveCandidateDocument(ConfigurationManager.AppSettings["CandidateDocumentsPath"].ToString() + "official/" + refNo + "/" + strTemp, Path.GetFileNameWithoutExtension(strTemp), officialLetterCode, candidateCode);

            FileDesOption = new CrystalDecisions.Shared.DiskFileDestinationOptions();
            FileDesOption.DiskFileName = strExportFile;
            ExpOptions = (CrystalDecisions.Shared.ExportOptions)objReport.ExportOptions;
            ExpOptions.DestinationOptions = FileDesOption;
            ExpOptions.ExportDestinationType = CrystalDecisions.Shared.ExportDestinationType.DiskFile;
            if (reportCode == (int)ReportCode.MedicalLetter)
                ExpOptions.ExportFormatType = CrystalDecisions.Shared.ExportFormatType.WordForWindows;
            else
                ExpOptions.ExportFormatType = CrystalDecisions.Shared.ExportFormatType.PortableDocFormat;
            objReport.Export(ExpOptions);
            objReport.Close();
            objReport.Dispose();

            #region Medical Letter Generation in Case of OfferLetter
            if (reportCode == (int)ReportCode.CandidateOfferLetter || reportCode == (int)ReportCode.MedicalLetter)
            {
                objReport = new CrystalDecisions.CrystalReports.Engine.ReportDocument();
                if (Is_SupportStaff == 0)
                {
                    path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\MedicalLetter_org.rpt";
                }
                else
                {
                    path = ConfigurationManager.AppSettings["PathforRPT"].ToString() + "\\CR\\SupportStaffMedicalLetter_org.rpt";
                }
                objReport.Load(path);

                objReport.SetDatabaseLogon(userid, password);

                objReport.SetParameterValue(0, refNo);

                strTemp = "MedicalLetter_org.doc";
                officialLetterCode = 3;
                strExportFile = ConfigurationManager.AppSettings["PathforPDF"].ToString();
                CreateFolder(strExportFile += refNo);
                strExportFile += "\\" + strTemp;


                SaveCandidateDocument(ConfigurationManager.AppSettings["CandidateDocumentsPath"].ToString() + "official/" + refNo + "/" + strTemp, Path.GetFileNameWithoutExtension(strTemp), officialLetterCode, candidateCode);

                FileDesOption = new CrystalDecisions.Shared.DiskFileDestinationOptions();
                FileDesOption.DiskFileName = strExportFile;
                ExpOptions = (CrystalDecisions.Shared.ExportOptions)objReport.ExportOptions;
                ExpOptions.DestinationOptions = FileDesOption;
                ExpOptions.ExportDestinationType = CrystalDecisions.Shared.ExportDestinationType.DiskFile;
                ExpOptions.ExportFormatType = CrystalDecisions.Shared.ExportFormatType.WordForWindows;
                objReport.Export(ExpOptions);
                objReport.Close();
                objReport.Dispose();

            }
            #endregion


        }
        private void SaveCandidateDocument(string documentPath, string documentName, int OfficialLetter_Code, int candidateCode)
        {
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);
            try
            {
                connection.Open();

                SqlCommand sqlCommand = new SqlCommand("Update_CandidateOfficialDocumentPDFPath", connection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.Parameters.AddWithValue("@Candidate_Code", candidateCode);
                sqlCommand.Parameters.AddWithValue("@DocumentPath", documentPath);
                sqlCommand.Parameters.AddWithValue("@OfficialLetter_Code", OfficialLetter_Code);
                sqlCommand.Parameters.AddWithValue("@UpdationIP", "Uploading service");
                sqlCommand.ExecuteNonQuery();

            }
            catch (Exception ex)
            {
                //throw exp1;
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, ex.StackTrace, ex, null);
            }
            finally
            {
                if (connection.State != ConnectionState.Closed)
                {
                    connection.Close();
                }
            }
        }
        public static void CreateFolder(string FolderPath)
        {
            string folderPath = string.Empty;

            //if (IsValidPath(FolderPath))
            folderPath = FolderPath;
            //else
            //    folderPath = System.Web.HttpContext.Current.Server.MapPath(FolderPath);
            DirectoryInfo dir = new DirectoryInfo(folderPath);
            if (!dir.Exists)
                Directory.CreateDirectory(folderPath);
        }
        public static bool IsValidPath(string path)
        {
            Regex r = new Regex(@"^(?:[a-zA-Z]\:|\\\\[\w\.]+\\[\w.]+)\\(?:[\w]+\\)*");
            return r.IsMatch(path);
        }
        enum ReportCode
        {
            CandidateOfferLetter = 1,
            CandidateAppointmentLetter = 2,
            MedicalLetter = 3,
            Appointment_FirstPage = 7,
            Envalope = 8,
            FirstPage_OfferLetter = 6,
            RemunerationSheet = 5,
            FirstLastPageOfferLetter = 10,
            FirstLastPageAppointmentLetter = 11,

            EmploymentVerificationLetter = 12,
            AddressVerificationLetter = 13,
            DiscreoantUserAppointmentLetter = 14,
        }

        public void SyncPortalUsersData(DateTime today)
        {
            DataTable dtPortal = GetPortalData();
            if (dtPortal.Rows.Count > 0)
            {
                for (int i = 0; i <= dtPortal.Rows.Count - 1; i++)
                {
                    Sync(int.Parse(dtPortal.Rows[i]["userID"].ToString()),
                        dtPortal.Rows[i]["fullName"].ToString(),
                        dtPortal.Rows[i]["deptName"].ToString(),
                        dtPortal.Rows[i]["Designation"].ToString(),
                        int.Parse(dtPortal.Rows[i]["cand_cat_code"].ToString()),
                        Convert.ToBoolean(dtPortal.Rows[i]["is_active"].ToString()),
                        dtPortal.Rows[i]["Is_ReportingAuthority"].ToString() == "0" ? false : true,
                        dtPortal.Rows[i]["EMAIL"].ToString(),
                        int.Parse(dtPortal.Rows[i]["DEPARTMENT_CODE"].ToString()),
                        dtPortal.Rows[i]["Is_PanelMember"].ToString() == "0" ? false : true,
                        dtPortal.Rows[i]["Gender"].ToString(),
                        dtPortal.Rows[i]["ph_extension"].ToString(),
                        dtPortal.Rows[i]["Is_GroupLeader"].ToString() == "0" ? false : true,
                        dtPortal.Rows[i]["Is_TeamLeader"].ToString() == "0" ? false : true,
                        int.Parse(dtPortal.Rows[i]["GL_ID"].ToString())

                        );
                }
                InsertSyncDate(today);
            }
        }

        protected void InsertSyncDate(DateTime todayDate)
        {
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);
            try
            {
                connection.Open();

                SqlCommand sqlCommand = new SqlCommand("XRec_Insert_CheckForPortalSyncForDate", connection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.Parameters.AddWithValue("@todayDate", todayDate);

                sqlCommand.ExecuteNonQuery();

            }
            catch (Exception ex)
            {
                //throw exp1;
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, ex.StackTrace, ex, null);
            }
            finally
            {
                if (connection.State != ConnectionState.Closed)
                {
                    connection.Close();
                }
            }
        }


        protected DataTable GetPortalData()
        {
            DataTable dt = new DataTable();
            string conStr = ConfigurationManager.ConnectionStrings["PortalConnection"].ToString();
            SqlDataAdapter adapter = new SqlDataAdapter("XRec_GetPortalUsers", new SqlConnection(conStr));
            adapter.SelectCommand.CommandType = CommandType.StoredProcedure;
            adapter.Fill(dt);
            return dt;
        }
        protected void Sync(int userID, string fullName, string deptName, string Designation, int cand_cat_code,
            bool is_active, bool Is_ReportingAuthority, string EMAIL, int DEPARTMENT_CODE, bool Is_PanelMember,
            string Gender, string ph_extension, bool Is_GroupLeader, bool Is_TeamLeader, int GL_ID)
        {
            SqlConnection connection = new SqlConnection(ConfigurationManager.AppSettings["RecruitmentLiveConn"].ToString());
            try
            {
                connection.Open();
                SqlCommand sqlCommand = new SqlCommand("dbo.XRec_Sync_PortalUsers", connection);
                sqlCommand.Parameters.AddWithValue("@userID", userID);
                sqlCommand.Parameters.AddWithValue("@fullName", fullName);
                sqlCommand.Parameters.AddWithValue("@deptName", deptName);
                sqlCommand.Parameters.AddWithValue("@Designation", Designation);
                sqlCommand.Parameters.AddWithValue("@cand_cat_code", cand_cat_code);
                sqlCommand.Parameters.AddWithValue("@is_active", is_active);
                sqlCommand.Parameters.AddWithValue("@Is_ReportingAuthority", Is_ReportingAuthority);
                sqlCommand.Parameters.AddWithValue("@EMAIL", EMAIL);
                sqlCommand.Parameters.AddWithValue("@DEPARTMENT_CODE", DEPARTMENT_CODE);
                sqlCommand.Parameters.AddWithValue("@Is_PanelMember", Is_PanelMember);
                sqlCommand.Parameters.AddWithValue("@Gender", Gender);
                sqlCommand.Parameters.AddWithValue("@ph_extension", ph_extension);

                sqlCommand.Parameters.AddWithValue("@Is_GroupLeader", Is_GroupLeader);
                sqlCommand.Parameters.AddWithValue("@Is_TeamLeader", Is_TeamLeader);
                sqlCommand.Parameters.AddWithValue("@GL_ID", GL_ID);

                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.ExecuteNonQuery();

            }
            catch (Exception ex)
            {

                ErrorLog.LogError.Write(LogError.AppType.RecruitmentAdmin, ex.Message + " " + ex.StackTrace, ex, "XRecDocumentUploadingService");
            }
            finally
            {
                if (connection.State != ConnectionState.Closed)
                {
                    connection.Close();
                }
            }
        }


        public bool CheckForTodaySyncPortalSchedul(DateTime today)
        {
            bool check = false;
            DataTable dtPortal = CheckTodayScheduled(today);
            if (dtPortal.Rows.Count > 0)
            {
                check = true;
            }
            return check;
        }
        protected DataTable CheckTodayScheduled(DateTime todayDate)
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.AppSettings["RecruitmentLiveConn"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XRec_Select_CheckForPortalSyncForDate", connection);

            sqlCommand.CommandType = CommandType.StoredProcedure;
            sqlCommand.Parameters.AddWithValue("@todayDate", todayDate);
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }
        public DataTable GetAllReferral()
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.AppSettings["RecruitmentLiveConn"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XRec_Select_CandidateReferral", connection);
            sqlCommand.CommandType = CommandType.StoredProcedure;
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }
        public DataTable GetAllReferralByExt()
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.AppSettings["RecruitmentLiveConn"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XRec_Select_CandidateReferralByExt", connection);
            sqlCommand.CommandType = CommandType.StoredProcedure;
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }
        public DataTable GetAllCandidatesForResignationSync()
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.AppSettings["RecruitmentLiveConn"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XREC_Select_CandidatesForResignationSync", connection);
            sqlCommand.CommandType = CommandType.StoredProcedure;
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }

        public void SyncReferralPortalIDByEmailAddress()
        {
            DataTable dt = GetAllReferral();
            DataTable dtPortID = new DataTable();
            string email = string.Empty;

            if (dt.Rows.Count > 0)
            {
                for (int i = 0; i <= dt.Rows.Count - 1; i++)
                {
                    email = dt.Rows[i]["Email_Address"].ToString();
                    dtPortID = GetReferralPortalID(email);
                    if (dtPortID.Rows.Count > 0)
                    {
                        UpdateReferralPortalID(email, dtPortID.Rows[0]["Userid"].ToString());
                    }
                }

            }

        }

        public void SyncReferralPortalIDByExtension()
        {
            DataTable dt = GetAllReferralByExt();
            DataTable dtPortID = new DataTable();
            string email = string.Empty;
            string referralExt = string.Empty;
            if (dt.Rows.Count > 0)
            {
                for (int i = 0; i <= dt.Rows.Count - 1; i++)
                {
                    email = dt.Rows[i]["Email_Address"].ToString();
                    referralExt = dt.Rows[i]["referral"].ToString();
                    dtPortID = CheckExtensionInUsers(referralExt);
                    if (dtPortID.Rows.Count > 0)
                    {
                        UpdateReferralPortalID(email, dtPortID.Rows[0]["UserID"].ToString());
                    }
                }

            }

        }

        private void UpdateReferralPortalID(string email, string portalID)
        {
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);
            try
            {
                connection.Open();

                SqlCommand sqlCommand = new SqlCommand("XRec_Update_CandidateReferralPortalID", connection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.Parameters.AddWithValue("@email", email);
                sqlCommand.Parameters.AddWithValue("@portalID", portalID);
                sqlCommand.ExecuteNonQuery();

            }
            catch (Exception ex)
            {
                //throw exp1;
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, ex.StackTrace, ex, null);
            }
            finally
            {
                if (connection.State != ConnectionState.Closed)
                {
                    connection.Close();
                }
            }
        }
        protected DataTable GetReferralPortalID(string email)
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["PortalConnection"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XRec_Select_ReferralPortalID", connection);

            sqlCommand.CommandType = CommandType.StoredProcedure;
            sqlCommand.Parameters.AddWithValue("@Email_Address", email);
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }

        protected DataTable CheckExtensionInUsers(string ext)
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XREC_Select_PortalUserIDByExtension", connection);

            sqlCommand.CommandType = CommandType.StoredProcedure;
            sqlCommand.Parameters.AddWithValue("@Ext", ext);
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }

        public void GetDataforPortalPic()
        {
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);
            try
            {
                connection.Open();

                SqlCommand sqlCommand = new SqlCommand("XREC_Select_PortalPicture", connection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
                DataSet ds = new DataSet();
                adapter.Fill(ds);
                string InitialPicPath = string.Empty;
                int refNo = 0;
                int PortalToCreate_Code = 0;
                bool isStaff = false;
                if (ds.Tables[0].Rows.Count > 0)
                {
                    for (int i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                    {
                        candidateCode = int.Parse(ds.Tables[0].Rows[i]["Candidate_Code"].ToString());
                        PortalToCreate_Code = int.Parse(ds.Tables[0].Rows[i]["PortalToCreate_Code"].ToString());
                        isStaff = Convert.ToBoolean(ds.Tables[0].Rows[i]["Is_Staff"]);
                        InitialPicPath = ConfigurationManager.AppSettings["DomainAddress"].ToString() + ds.Tables[0].Rows[i]["INITIALPICPATH"].ToString();
                        refNo = int.Parse(ds.Tables[0].Rows[i]["RefNo"].ToString());

                        //if (File.Exists(InitialPicPath))
                        //{
                            CopyFileToPortalLocation(InitialPicPath, refNo, PortalToCreate_Code, isStaff);
                        //}
                        //else {
                        //    Exception exc = new  Exception();
                        //   // exc="File doesnot exist".ToString();
                        //   // ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, "XDocumentUploadingService :: " + InitialPicPath+ " Image file doesnot exist", exc, null);
                        //}

                    }
                }

            }
            catch (Exception ex)
            {
                //throw exp1;
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, "XDocumentUploadingService :: " + ex.StackTrace, ex, null);
            }
            finally
            {
                if (connection.State != ConnectionState.Closed)
                {
                    connection.Close();
                }
            }
        }
        protected void UpdateIsPortalPicMoved(int PortalToCreate_Code, int is_picturemoved = 1)
        {
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);
            try
            {
                connection.Open();

                SqlCommand sqlCommand = new SqlCommand("XREC_Update_SyncPortalPic", connection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.Parameters.AddWithValue("@PortalToCreate_Code", PortalToCreate_Code);
                sqlCommand.Parameters.AddWithValue("@is_picturemoved", is_picturemoved);

                sqlCommand.ExecuteNonQuery();

            }
            catch (Exception ex)
            {
                //throw exp1;
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, ex.StackTrace, ex, null);
            }
            finally
            {
                if (connection.State != ConnectionState.Closed)
                {
                    connection.Close();
                }
            }
        }

        protected void CopyFileToPortalLocation(string fileToDownload, int referenceCode, int PortalToCreate_Code, bool isStaff)
        {
            using (WebClient Client = new WebClient())
            {
                try
                {

                    if (isStaff)
                    {
                        if (!File.Exists(ConfigurationManager.AppSettings["PathforPortalPicStaff"].ToString()
                    + referenceCode + Path.GetExtension(fileToDownload)))
                        {

                            Client.DownloadFile(fileToDownload, ConfigurationManager.AppSettings["PathforPortalPicStaff"].ToString() + referenceCode + Path.GetExtension(fileToDownload));
                            UpdateIsPortalPicMoved(PortalToCreate_Code);
                        }
                        else
                            UpdateIsPortalPicMoved(PortalToCreate_Code);
                    }
                    else
                    {
                        if (!File.Exists(ConfigurationManager.AppSettings["PathforPortalPic"].ToString()
                    + referenceCode + Path.GetExtension(fileToDownload)))
                        {
                            Client.DownloadFile(fileToDownload, ConfigurationManager.AppSettings["PathforPortalPic"].ToString() + referenceCode + Path.GetExtension(fileToDownload));
                            //Client.DownloadFile(fileToDownload,  @"d:\" + referenceCode + Path.GetExtension(fileToDownload));
                            //File.Copy(@"d:\" + referenceCode + Path.GetExtension(fileToDownload), ConfigurationManager.AppSettings["PathforPortalPic"].ToString() + referenceCode + Path.GetExtension(fileToDownload));
                            UpdateIsPortalPicMoved(PortalToCreate_Code);
                            
                        }
                        else
                            UpdateIsPortalPicMoved(PortalToCreate_Code);
                    }
                   

                    Client.Dispose();
                    //UpdateIsPortalPicMoved(PortalToCreate_Code);


                }
                catch (Exception ex)
                {
                    UpdateIsPortalPicMoved(PortalToCreate_Code,2);
                    //throw exp1;
                    ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, "XDocumentUploadingService :: " + ex.StackTrace, ex, null);
                }
            }
        }

        public void UpdateJobDescriptionFromPeroformanceSystem()
        {
            try
            {
                SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);

                using (var client = new PerformanceSystemAPI.AdminReportsAPISoapClient("AdminReportsAPISoap"))
                {
                    DataSet result = new DataSet();
                    result = client.GetPerformanceJobroles(-1, "aru34rpb2");
                    if (result != null)
                        if (result.Tables[0].Rows.Count > 0)
                        {
                            if (connection.State != ConnectionState.Open)
                                connection.Open();
                            foreach (DataRow dr in result.Tables[0].Rows)
                            {
                                if (!string.IsNullOrEmpty(dr["JobRole_Code"].ToString()) && !string.IsNullOrEmpty(dr["JobRole_Description"].ToString()) && !string.IsNullOrEmpty(dr["Department_Code"].ToString()))
                                {

                                    SqlCommand sqlCommand = new SqlCommand("dbo.Update_JobDescribtion_PerformnaceSystem", connection);
                                    sqlCommand.CommandType = CommandType.StoredProcedure;
                                    sqlCommand.Parameters.Add("@PMJD_COde", SqlDbType.Int).Value = dr["JobRole_Code"];
                                    sqlCommand.Parameters.Add("@JDName", SqlDbType.VarChar).Value = dr["JobRole_Description"];
                                    sqlCommand.Parameters.Add("@Department_Code", SqlDbType.Int).Value = dr["Department_Code"];
                                    sqlCommand.ExecuteNonQuery();
                                }
                            }
                            if (connection.State != ConnectionState.Closed)
                                connection.Close();
                        }
                }
            }
            catch (Exception ex)
            {
                //throw exp1;
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, "XDocumentUploadingService :: " + ex.StackTrace, ex, null);
            }
        }

        public void SyncCandidatesForResignation()
        {

            DataTable dt = GetAllCandidatesForResignationSync();
            DataTable dtPortID = new DataTable();
            string PortalUserID = string.Empty;
            string candidateCode = string.Empty;
            DateTime portalSeperationDate;
            if (dt.Rows.Count > 0)
            {
                for (int i = 0; i <= dt.Rows.Count - 1; i++)
                {
                    PortalUserID = dt.Rows[i]["PortalUserID"].ToString();
                    candidateCode = dt.Rows[i]["Candidate_Code"].ToString();
                    dtPortID = CheckPortalUserStatusForResignation(PortalUserID);
                    if (dtPortID.Rows.Count > 0)
                    {
                        portalSeperationDate = Convert.ToDateTime(dtPortID.Rows[0]["Seperation_Date"].ToString());
                        if (!Convert.ToBoolean(dtPortID.Rows[0]["Is_active"].ToString()) && dtPortID.Rows[0]["NewUserID"].ToString() == "0")
                            UpdateCandidateStatusForResignation(candidateCode, portalSeperationDate);
                    }
                }

            }

        }
        protected DataTable CheckPortalUserStatusForResignation(string portalUserID)
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["PortalConnection"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XREC_Select_PortalUserStatus", connection);

            sqlCommand.CommandType = CommandType.StoredProcedure;
            sqlCommand.Parameters.AddWithValue("@Userid", portalUserID);
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }
        private void UpdateCandidateStatusForResignation(string candidateCode, DateTime Seperation_Date)
        {
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);
            try
            {
                connection.Open();

                SqlCommand sqlCommand = new SqlCommand("XREC_Update_SyncCandidateStatusForResignation", connection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.Parameters.AddWithValue("@Candidate_Code", candidateCode);
                sqlCommand.Parameters.AddWithValue("@Updated_IP", "Sync Service");
                sqlCommand.Parameters.AddWithValue("@Seperation_Date", Seperation_Date);
                sqlCommand.ExecuteNonQuery();

            }
            catch (Exception ex)
            {
                //throw exp1;
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, ex.StackTrace, ex, null);
            }
            finally
            {
                if (connection.State != ConnectionState.Closed)
                {
                    connection.Close();
                }
            }
        }
        public void SyncDesignationsWithPortal()
        {

            DataTable dt = GetMaxDesignation();
            int maxDesignationID = 0;
            if (dt.Rows.Count > 0)
            {
                maxDesignationID = int.Parse(dt.Rows[0]["MaxDesignation"].ToString());
                DataTable dtDesignation = CheckPortalForNewlyAddedDesignation(maxDesignationID);
                int departmentid = 0;
                int DesignationID = 0;
                string title = string.Empty;
                SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);
                try
                {
                    connection.Open();
                    for (int i = 0; i <= dtDesignation.Rows.Count - 1; i++)
                    {
                        departmentid = int.Parse(dtDesignation.Rows[i]["departmentid"].ToString());
                        DesignationID = int.Parse(dtDesignation.Rows[i]["DesignationID"].ToString());
                        title = dtDesignation.Rows[i]["title"].ToString();

                        InsertNewDesigantion(departmentid, DesignationID, title, connection);
                    }
                }
                catch (Exception ex)
                {
                    //throw exp1;
                    ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, ex.StackTrace, ex, null);
                }
                finally
                {
                    if (connection.State != ConnectionState.Closed)
                    {
                        connection.Close();
                    }
                }

            }

        }

        public void SyncDepartmentWithPortal()
        {

            DataTable dt = GetMaxDepartment();
            int maxDepartmentID = 0;
            if (dt.Rows.Count > 0)
            {
                maxDepartmentID = int.Parse(dt.Rows[0]["MaxDepartmentCode"].ToString());
                DataTable dtDepartment = CheckPortalForNewlyAddedDepartment(maxDepartmentID);
                int departmentid = 0;
                string DepartmentName = string.Empty;
                int? DomainOwnerCode = 0;
                int? IsSupport = 0;
                int? HasShift = 0;
                if (dtDepartment.Rows.Count > 0)
                {
                    SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);
                    try
                    {
                        connection.Open();
                        for (int i = 0; i <= dtDepartment.Rows.Count - 1; i++)
                        {
                            if (!string.IsNullOrEmpty(dtDepartment.Rows[i]["deptID"].ToString()))
                            {
                                departmentid = int.Parse(dtDepartment.Rows[i]["deptID"].ToString());
                            }
                            if (!string.IsNullOrEmpty(dtDepartment.Rows[i]["deptName"].ToString()))
                            {
                                DepartmentName = dtDepartment.Rows[i]["deptName"].ToString();
                            }
                            if (!string.IsNullOrEmpty(dtDepartment.Rows[i]["deptHeadID"].ToString()))
                            {
                                DomainOwnerCode = Convert.ToInt32(dtDepartment.Rows[i]["deptHeadID"].ToString());
                            }
                            if (!string.IsNullOrEmpty(dtDepartment.Rows[i]["isSupportDept"].ToString()))
                            {
                                IsSupport = Convert.ToInt32(dtDepartment.Rows[i]["isSupportDept"].ToString());
                            }
                            if (!string.IsNullOrEmpty(dtDepartment.Rows[i]["has_shift"].ToString()))
                            {
                                HasShift = Convert.ToInt32(dtDepartment.Rows[i]["has_shift"].ToString());
                            }

                            InsertNewDepartment(departmentid, DepartmentName, DomainOwnerCode, IsSupport, HasShift, connection);
                        }
                    }
                    catch (Exception ex)
                    {
                        //throw exp1;
                        ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, ex.StackTrace, ex, null);
                    }
                    finally
                    {
                        if (connection.State != ConnectionState.Closed)
                        {
                            connection.Close();
                        }
                    }
                }
            }

        }
        public void SendEmailForTentativeJoining()
        {
            DataTable dt = GetTentativeJoiningEmailData();
            if (dt.Rows.Count > 0)
            {
                DataView view = new DataView(dt);
                DataTable distinctValues = view.ToTable(true, "Domain");

                SqlConnection connection = new SqlConnection(ConfigurationManager.AppSettings["RecruitmentLiveConn"].ToString());
                DataSet dataSet = new DataSet();
                string sql = "XREC_Select_EmailReceiversForTentativeJoining";
                SqlCommand cmd = new SqlCommand(sql, connection);
                cmd.CommandType = CommandType.StoredProcedure;
                SqlDataAdapter sda = new SqlDataAdapter(cmd);
                sda.Fill(dataSet);

                string toEmail = dataSet.Tables[0].Rows[0]["toEmail"].ToString();
                string SenderEmail = dataSet.Tables[0].Rows[0]["SenderEmail"].ToString();
                string bcc = dataSet.Tables[0].Rows[0]["bcc"].ToString();
                string cc = dataSet.Tables[0].Rows[0]["cc"].ToString();
                string SenderName = dataSet.Tables[0].Rows[0]["SenderName"].ToString();

                //string toEmail = "alirizvi@axact.com,atifhussain@axact.com";
                //string SenderEmail = "alirizvi@axact.com";
                //string bcc = "alirizvi@axact.com";
                //string cc = "alirizvi@axact.com";
                //string SenderName = "Recruitment";

                DateTime Date = Convert.ToDateTime(dt.Rows[0]["postedFromDate"].ToString());
                EmailFunctions objEmailFunctions = new EmailFunctions();
                objEmailFunctions.SendOrderCodesThroughEmail(connection, dt, SenderName, toEmail, SenderEmail, Date, cc, bcc, distinctValues);
                string TentativeJoiningEmailData_Code = string.Empty;

                for (int i = 0; i <= dt.Rows.Count - 1; i++)
                {
                    TentativeJoiningEmailData_Code = TentativeJoiningEmailData_Code + "," + dt.Rows[i]["TentativeJoiningEmailData_Code"].ToString();
                }
                TentativeJoiningEmailData_Code = TentativeJoiningEmailData_Code.TrimStart(',');
                UpdateTentativeJoiningEmailDataStatus(TentativeJoiningEmailData_Code, connection);
            }
        }
        public void SyncJobRoleAndBenefitsForSupportStaffWithPortal()
        {

            DataTable dt = GetMaxJobRole();
            int jobrole_code = 0;
            if (dt.Rows.Count > 0)
            {
                jobrole_code = int.Parse(dt.Rows[0]["jobrole_code"].ToString());
                DataTable dtJobRole = CheckPortalForNewlyAddedJobRoleAndBenefits(jobrole_code);
                DataTable dtJobRoleBenefits = new DataTable();
                int newjobrole_code = 0;
                int deductionTypeID = 0;
                int Count = 0;
                int DeliveryTime = 0;
                decimal Amount = 0;
                decimal Benefit_Value = 0;
                string BenefitDescription = string.Empty;

                SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);
                try
                {
                    connection.Open();
                    for (int i = 0; i <= dtJobRole.Rows.Count - 1; i++)
                    {
                        newjobrole_code = int.Parse(dtJobRole.Rows[i]["jobrole_code"].ToString());
                        dtJobRoleBenefits = GetNewlyAddedJobRoleAndBenefits(newjobrole_code);
                        if (dtJobRoleBenefits.Rows.Count > 0)
                        {
                            for (int inner = 0; inner <= dtJobRoleBenefits.Rows.Count - 1; inner++)
                            {
                                if (!string.IsNullOrEmpty(dtJobRoleBenefits.Rows[inner]["deductionTypeID"].ToString()))
                                {
                                    deductionTypeID = int.Parse(dtJobRoleBenefits.Rows[inner]["deductionTypeID"].ToString());
                                }
                                if (!string.IsNullOrEmpty(dtJobRoleBenefits.Rows[inner]["COUNT"].ToString()))
                                {
                                    Count = int.Parse(dtJobRoleBenefits.Rows[inner]["COUNT"].ToString());
                                }
                                if (!string.IsNullOrEmpty(dtJobRoleBenefits.Rows[inner]["DeliveryTime"].ToString()))
                                {
                                    DeliveryTime = int.Parse(dtJobRoleBenefits.Rows[inner]["DeliveryTime"].ToString());
                                }
                                if (!string.IsNullOrEmpty(dtJobRoleBenefits.Rows[inner]["Amount"].ToString()))
                                {
                                    Amount = Convert.ToDecimal(dtJobRoleBenefits.Rows[inner]["Amount"].ToString());
                                }
                                if (!string.IsNullOrEmpty(dtJobRoleBenefits.Rows[inner]["Benefit_Value"].ToString()))
                                {
                                    Benefit_Value = Convert.ToDecimal(dtJobRoleBenefits.Rows[inner]["Benefit_Value"].ToString());
                                }
                                if (!string.IsNullOrEmpty(dtJobRoleBenefits.Rows[inner]["BenefitDescription"].ToString()))
                                {
                                    BenefitDescription = dtJobRoleBenefits.Rows[inner]["BenefitDescription"].ToString();
                                }
                                InsertNewJobRoleBenefits(newjobrole_code, deductionTypeID, Count, DeliveryTime, Amount, Benefit_Value, BenefitDescription, connection);
                            }
                        }


                    }
                }
                catch (Exception ex)
                {
                    //throw exp1;
                    ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, ex.StackTrace, ex, null);
                }
                finally
                {
                    if (connection.State != ConnectionState.Closed)
                    {
                        connection.Close();
                    }
                }

            }

        }
        public DataTable GetMaxDesignation()
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.AppSettings["RecruitmentLiveConn"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XREC_GetMaxJobPosID", connection);
            sqlCommand.CommandType = CommandType.StoredProcedure;
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }
        public DataTable GetMaxDepartment()
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.AppSettings["RecruitmentLiveConn"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XRec_Select_MaxDepartment", connection);
            sqlCommand.CommandType = CommandType.StoredProcedure;
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }
        public DataTable GetMaxJobRole()
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.AppSettings["RecruitmentLiveConn"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XREC_Select_MaxJobRoleBenefits", connection);
            sqlCommand.CommandType = CommandType.StoredProcedure;
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }

        protected DataTable CheckPortalForNewlyAddedDesignation(int jobPosID)
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["PortalConnection"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XREC_SelectNewDesignation", connection);

            sqlCommand.CommandType = CommandType.StoredProcedure;
            sqlCommand.Parameters.AddWithValue("@jobPosID", jobPosID);
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }

        protected DataTable CheckPortalForNewlyAddedDepartment(int DepartmentID)
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["PortalConnection"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XREC_SelectNewDepartment", connection);

            sqlCommand.CommandType = CommandType.StoredProcedure;
            sqlCommand.Parameters.AddWithValue("@DepartmentCode", DepartmentID);
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }
        protected DataTable CheckPortalForNewlyAddedJobRoleAndBenefits(int jobrole_code)
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["PortalConnection"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XREC_Select_NewlyAddedJobRole", connection);

            sqlCommand.CommandType = CommandType.StoredProcedure;
            sqlCommand.Parameters.AddWithValue("@jobrole_code", jobrole_code);
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }
        protected DataTable GetNewlyAddedJobRoleAndBenefits(int jobrole_code)
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["PortalConnection"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XREC_Select_NewlyAddedJobRoleBenefits", connection);

            sqlCommand.CommandType = CommandType.StoredProcedure;
            sqlCommand.Parameters.AddWithValue("@jobrole_code", jobrole_code);
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }
        private void InsertNewDesigantion(int departmentid, int DesignationID, string title, SqlConnection sqlconn)
        {
            SqlCommand sqlCommand = new SqlCommand("XREC_InsertNewDesignation", sqlconn);
            sqlCommand.CommandType = CommandType.StoredProcedure;
            sqlCommand.Parameters.AddWithValue("@departmentid", departmentid);
            sqlCommand.Parameters.AddWithValue("@DesignationID", DesignationID);
            sqlCommand.Parameters.AddWithValue("@title", title);
            sqlCommand.ExecuteNonQuery();

        }

        private void InsertNewDepartment(int departmentid, string DepartmentName, int? DomainOwnerCode, int? IsSupport, int? HasShift, SqlConnection sqlconn)
        {
            SqlCommand sqlCommand = new SqlCommand("XREC_InsertNewDepartment", sqlconn);
            sqlCommand.CommandType = CommandType.StoredProcedure;
            sqlCommand.Parameters.AddWithValue("@DomainName", DepartmentName);
            sqlCommand.Parameters.AddWithValue("@DeptID", departmentid);
            sqlCommand.Parameters.AddWithValue("@DeptHeadID", DomainOwnerCode);
            sqlCommand.Parameters.AddWithValue("@IsShifts", HasShift);
            sqlCommand.Parameters.AddWithValue("@IsStaff", IsSupport);
            sqlCommand.ExecuteNonQuery();

        }
        private void InsertNewJobRoleBenefits(int jobRoleCode, int deductionTypeID, int count, int deliveryTime, decimal amount, decimal benefitValue, string benefitDescription, SqlConnection sqlconn)
        {
            SqlCommand sqlCommand = new SqlCommand("XREC_Insert_JobRoleBenefits", sqlconn);
            sqlCommand.CommandType = CommandType.StoredProcedure;
            sqlCommand.Parameters.AddWithValue("@newjobrole_code", jobRoleCode);
            sqlCommand.Parameters.AddWithValue("@deductionTypeID", deductionTypeID);
            sqlCommand.Parameters.AddWithValue("@Amount", amount);

            sqlCommand.Parameters.AddWithValue("@COUNT", count);
            sqlCommand.Parameters.AddWithValue("@BenefitDescription", benefitDescription);
            sqlCommand.Parameters.AddWithValue("@DeliveryTime", deliveryTime);
            sqlCommand.Parameters.AddWithValue("@Benefit_Value", benefitValue);
            sqlCommand.ExecuteNonQuery();

        }

        public void GetSyncDocument()
        {
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);
            DataTable dtDocument = new DataTable();
            try
            {
                SqlCommand sqlCommand = new SqlCommand("XREC_GetCandidateForDocumentDigitalization", connection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
                DataSet ds = new DataSet();
                adapter.Fill(ds);
                string docName = string.Empty;
                string domainName = string.Empty;
                int portalUserID = 0;
                int docCode = 0;
                int candDoc_Code = 0;
                string folderToSearch = string.Empty;
                string PortalDocument_Head = string.Empty;
                int documentIDforPortal = 0;

                if (ds.Tables[0].Rows.Count > 0)
                {
                    for (int i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                    {
                        candidateCode = int.Parse(ds.Tables[0].Rows[i]["Candidate_Code"].ToString());
                        dtDocument = GetDocumentDetails(candidateCode);

                        for (int inner = 0; inner <= dtDocument.Rows.Count - 1; inner++)
                        {
                            try
                            {
                                string docPath = ConfigurationManager.AppSettings["DomainAddress"].ToString();
                                portalUserID = int.Parse(dtDocument.Rows[inner]["PortalUserID"].ToString());
                                docCode = int.Parse(dtDocument.Rows[inner]["Document_Code"].ToString());
                                domainName = dtDocument.Rows[inner]["Domain_Name"].ToString();
                                docName = dtDocument.Rows[inner]["DocumentName"].ToString();
                                docPath = docPath + dtDocument.Rows[inner]["DocumentPath"].ToString();
                                folderToSearch = dtDocument.Rows[inner]["Portaldocument_name"].ToString();
                                documentIDforPortal = int.Parse(dtDocument.Rows[inner]["Portaldocument_Code"].ToString());
                                PortalDocument_Head = dtDocument.Rows[inner]["PortalDocument_Head"].ToString();
                                candDoc_Code = int.Parse(dtDocument.Rows[inner]["CandDoc_Code"].ToString());

                                CopyCandidateDocumentToPortalLocation(PortalDocument_Head, docName, domainName, portalUserID, docCode, docPath, folderToSearch, documentIDforPortal, candDoc_Code);
                            }
                            catch (Exception ex)
                            {
                                //throw exp1;
                                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, "XDocumentUploadingService :: " + ex.StackTrace, ex, null);
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                //throw exp1;
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, "XDocumentUploadingService :: " + ex.StackTrace, ex, null);
            }
        }

        private DataTable GetDocumentDetails(int candidateCode)
        {
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);
            DataTable dtDocument = new DataTable();
            try
            {
                SqlCommand sqlCommand = new SqlCommand("XREC_GetCandidateDocumentForDigitalization", connection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.Parameters.AddWithValue("@CandidateCode", candidateCode);
                SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
                adapter.Fill(dtDocument);
            }
            catch (Exception ex)
            {
                //throw exp1;
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, "XDocumentUploadingService :: " + ex.StackTrace, ex, null);
            }
            return dtDocument;
        }


        protected void CopyCandidateDocumentToPortalLocation(string PortalDocument_Head, string DocumentName, string Domain_Name, int portalUserID, int documentCode, string documentPath, string folderToSearch, int documentIDForPortal, int candidateDocumentCode)
        {
            using (WebClient Client = new WebClient())
            {
                try
                {
                    //string folderToSearch = string.Empty;
                    //int documentIDForPortal = 0;
                    string fileName = string.Empty;
                    string completeFilePath = string.Empty;
                    string portalCompleteFilePath = string.Empty;
                    #region CreateFolders

                    if (!Directory.Exists(ConfigurationManager.AppSettings["PathforDocuments"].ToString() + DateTime.Today.Year))
                        CreateFolder(ConfigurationManager.AppSettings["PathforDocuments"].ToString() + DateTime.Today.Year);
                    if (!Directory.Exists(ConfigurationManager.AppSettings["PathforDocuments"].ToString() + DateTime.Today.Year + "\\Human Resource"))
                        CreateFolder(ConfigurationManager.AppSettings["PathforDocuments"].ToString() + DateTime.Today.Year + "\\Human Resource");

                    if (!Directory.Exists(ConfigurationManager.AppSettings["PathforDocuments"].ToString() + DateTime.Today.Year + "\\Human Resource\\" + PortalDocument_Head))
                        CreateFolder(ConfigurationManager.AppSettings["PathforDocuments"].ToString() + DateTime.Today.Year + "\\Human Resource\\" + PortalDocument_Head);

                    #region Old Commented Code
                    /*
                    switch (DocumentName)
                    {
                        case "Matric Marksheet":
                            folderToSearch = "Matric Marksheet\\";
                            documentIDForPortal = 11;
                            break;
                        case "Matric Certificate":
                            folderToSearch = "Matric or Equivalent Certificate\\";
                            documentIDForPortal = 10;
                            break;

                        case "Inter Certificate":
                            folderToSearch = "Intermediate or High School Certificate\\";
                            documentIDForPortal = 12;
                            break;
                        case "Inter Provisional":
                            folderToSearch = "Intermediate or High School Marksheet\\";
                            documentIDForPortal = 13;
                            break;


                        case "Graduation or Equivalent Degree":
                            folderToSearch = "Graduation or Equivalent Degree\\";
                            documentIDForPortal = 14;
                            break;
                        case "Bachelor Certificate":
                            folderToSearch = "Graduation Marksheet\\";
                            documentIDForPortal = 15;
                            break;

                        case "Master Certificate":
                            folderToSearch = "Masters Marksheet\\";
                            documentIDForPortal = 17;
                            break;
                        case "Master Degree":
                            folderToSearch = "Master or Equivalent Degree\\";
                            documentIDForPortal = 16;
                            break;

                        default:
                            break;
                    } 
                    */
                    #endregion


                    if (!Directory.Exists(ConfigurationManager.AppSettings["PathforDocuments"].ToString() + DateTime.Today.Year + "\\Human Resource\\" + PortalDocument_Head + "\\" + folderToSearch))
                        CreateFolder(ConfigurationManager.AppSettings["PathforDocuments"].ToString() + DateTime.Today.Year + "\\Human Resource\\" + PortalDocument_Head + "\\" + folderToSearch);

                    if (!Directory.Exists(ConfigurationManager.AppSettings["PathforDocuments"].ToString() + DateTime.Today.Year + "\\Human Resource\\" + PortalDocument_Head + "\\" + folderToSearch + "\\" + Domain_Name))
                        CreateFolder(ConfigurationManager.AppSettings["PathforDocuments"].ToString() + DateTime.Today.Year + "\\Human Resource\\" + PortalDocument_Head + "\\" + folderToSearch + "\\" + Domain_Name);

                    if (!Directory.Exists(ConfigurationManager.AppSettings["PathforDocuments"].ToString() + DateTime.Today.Year + "\\Human Resource\\" + PortalDocument_Head + "\\" + folderToSearch + "\\" + Domain_Name + "\\" + portalUserID))
                        CreateFolder(ConfigurationManager.AppSettings["PathforDocuments"].ToString() + DateTime.Today.Year + "\\Human Resource\\" + PortalDocument_Head + "\\" + folderToSearch + "\\" + Domain_Name + "\\" + portalUserID);


                    #endregion

                    fileName = DateTime.Now.Second.ToString() + "_" + DateTime.Now.Minute.ToString() + "_" + DateTime.Now.Hour.ToString() + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Month.ToString() + "_" + DateTime.Now.Year.ToString() + Path.GetExtension(documentPath);

                    completeFilePath = ConfigurationManager.AppSettings["PathforDocuments"].ToString() + DateTime.Today.Year
                        + "\\Human Resource\\" + PortalDocument_Head + "\\" + folderToSearch + "\\" + Domain_Name + "\\" + portalUserID
                        + "\\" + fileName;

                    portalCompleteFilePath = ConfigurationManager.AppSettings["PathforDocuments"].ToString()
                        + "//Human Resource//" + PortalDocument_Head + "//" + folderToSearch + "//" + Domain_Name + "//" + portalUserID
                        + "//" + fileName;

                    if (!File.Exists(completeFilePath))
                    {
                        Client.DownloadFile(documentPath,
                            completeFilePath);

                        UpdateDocumentInPortal(documentIDForPortal, fileSize(completeFilePath),
                        Path.GetExtension(documentPath), portalCompleteFilePath.Replace(ConfigurationManager.AppSettings["PathforDocuments"].ToString(), "Employeedocuments"),
                        "1", portalUserID, fileName);

                        UpdateDocumentSentToPortal(candidateDocumentCode);
                    }



                }
                catch (Exception ex)
                {
                    //throw exp1;
                    ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, "XDocumentUploadingService :: " + ex.StackTrace, ex, null);
                }
            }
        }

        private void UpdateDocumentSentToPortal(int CandDocCode)
        {
            SqlConnection connection1 = new SqlConnection(ConfigurationManager.ConnectionStrings["RecruitmentLiveConn"].ConnectionString);

            try
            {
                if (connection1.State == ConnectionState.Closed)
                    connection1.Open();
                SqlCommand sqlCommand = new SqlCommand("XREC_Update_DocumentSentToPortal", connection1);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.Parameters.AddWithValue("@CandDoc_Code", CandDocCode);
                sqlCommand.ExecuteNonQuery();
            }
            catch (Exception ex)
            {
                //throw exp1;
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, "XDocumentUploadingService :: " + ex.StackTrace, ex, null);
            }
            finally
            {
                if (connection1.State == ConnectionState.Open)
                    connection1.Close();
            }
        }
        private string fileSize(string filePath)
        {
            long size = new FileInfo(filePath).Length / 1024;
            string KBSize = string.Format("{0} KB", size);
            return KBSize;
        }
        protected void UpdateDocumentInPortal(int Document_ID, string Doc_size, string doc_extension, string doc_path,
            string Doc_Version, int Emp_ID, string File_Name)
        {
            SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["PortalConnection"].ConnectionString);
            try
            {
                connection.Open();

                SqlCommand sqlCommand = new SqlCommand("XREC_InsertCandidateDocumentsFromRecruitment", connection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.Parameters.AddWithValue("@Document_ID", Document_ID);
                sqlCommand.Parameters.AddWithValue("@Doc_size", Doc_size);
                sqlCommand.Parameters.AddWithValue("@doc_extension", doc_extension);
                sqlCommand.Parameters.AddWithValue("@doc_path", doc_path);
                sqlCommand.Parameters.AddWithValue("@Doc_Version", Doc_Version);
                sqlCommand.Parameters.AddWithValue("@Emp_ID", Emp_ID);
                sqlCommand.Parameters.AddWithValue("@File_Name", File_Name);
                sqlCommand.Parameters.AddWithValue("@Updated_IP", "XRecruitement-SyncService");
                sqlCommand.ExecuteNonQuery();

            }
            catch (Exception ex)
            {
                //throw exp1;
                ErrorLog.LogError.Write(ErrorLog.LogError.AppType.RecruitmentAdmin, ex.StackTrace, ex, null);
            }
            finally
            {
                if (connection.State != ConnectionState.Closed)
                {
                    connection.Close();
                }
            }
        }

        public DataTable GetTentativeJoiningEmailData()
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection(ConfigurationManager.AppSettings["RecruitmentLiveConn"].ToString());
            SqlCommand sqlCommand = new SqlCommand("dbo.XREC_Select_TentativeJoiningEmailData", connection);
            sqlCommand.CommandType = CommandType.StoredProcedure;
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }

        public DataTable GetBGEmailData()
        {
            DataTable dt = new DataTable();
            SqlConnection connection = new SqlConnection("User ID=recusr;Password=F7v#xyJ1iD;DataBase=BSMT;Server=184.154.101.79");
            SqlCommand sqlCommand = new SqlCommand("dbo.BSMT_Select_BGSignUpEmail", connection);
            sqlCommand.CommandType = CommandType.StoredProcedure;
            SqlDataAdapter adapter = new SqlDataAdapter(sqlCommand);
            adapter.Fill(dt);
            return dt;

        }

        private void UpdateTentativeJoiningEmailDataStatus(string TentativeJoiningEmailData_Code, SqlConnection sqlconn)
        {
            try
            {
                sqlconn.Open();
                SqlCommand sqlCommand = new SqlCommand("XREC_Update_TentativeJoiningEmailData", sqlconn);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.Parameters.AddWithValue("@TentativeJoiningEmailData_Code", TentativeJoiningEmailData_Code);
                sqlCommand.ExecuteNonQuery();
            }
            catch (Exception ex)
            {
                //ErrorLog.LogError.Write(LogError.AppType.RecruitmentAdmin, ex.Message + " " + ex.StackTrace, ex, UserCode.ToString());
            }
            finally
            {
                sqlconn.Close();
            }

        }

        private void UpdateBGEmailDataStatus(int BGSignUp_Code)
        {
            SqlConnection connection = new SqlConnection("User ID=recusr;Password=F7v#xyJ1iD;DataBase=BSMT;Server=184.154.101.79");
            try
            {
                connection.Open();
                SqlCommand sqlCommand = new SqlCommand("BSMT_Update_BGSignUpEmailData", connection);
                sqlCommand.CommandType = CommandType.StoredProcedure;
                sqlCommand.Parameters.AddWithValue("@BGSignUp_Code", BGSignUp_Code);
                sqlCommand.ExecuteNonQuery();
            }
            catch (Exception ex)
            {
                //ErrorLog.LogError.Write(LogError.AppType.RecruitmentAdmin, ex.Message + " " + ex.StackTrace, ex, UserCode.ToString());
            }
            finally
            {
                connection.Close();
            }

        }

        public void SendEmailForBG()
        {
            DataTable dt = GetBGEmailData();
            if (dt.Rows.Count > 0)
            {
                string toEmail = string.Empty;
                string SenderEmail = string.Empty;
                string cc = string.Empty;
                string SenderName = string.Empty;
                int BGSignUp_Code = 0;
                for (int i = 0; i <= dt.Rows.Count - 1; i++)
                {
                    BGSignUp_Code = int.Parse(dt.Rows[i]["BGSignUp_Code"].ToString());
                    toEmail = dt.Rows[i]["Email"].ToString();
                    SenderEmail = "info@bgdevices.com";
                    //cc = "syedalirrizvi@yahoo.com";
                    SenderName = "BGDevices";

                    EmailFunctions objEmailFunctions = new EmailFunctions();
                    objEmailFunctions.SendBGThroughEmail(dt.Rows[i]["Full_Name"].ToString(), SenderName, toEmail, SenderEmail, cc);

                    UpdateBGEmailDataStatus(BGSignUp_Code);
                }
            }
        }

    }
    class EmailFunctions
    {
        internal void SendOrderCodesThroughEmail(SqlConnection sqlConnection, DataTable dtEmail, string SenderName, string toEmails, string SenderEmail, DateTime Date, string CC, string BCC, DataTable dtDistinctDomain)
        {
            if (dtEmail.Rows.Count > 0)
            {
                string StringDataTable = ConvertToHtmlFile(dtEmail, Date, dtDistinctDomain);

                MailMessage Mail_Message = new MailMessage();
                Mail_Message.From = new MailAddress(SenderEmail, SenderName);
                Mail_Message.To.Add(toEmails);
                Mail_Message.CC.Add(CC);
                Mail_Message.Bcc.Add(BCC);
                Mail_Message.Subject = "Tentative New Joining from " + Date.ToLongDateString();
                Mail_Message.Body = StringDataTable;
                Mail_Message.IsBodyHtml = true;
                Send_Email(Mail_Message);
                //dtEmail.Reset();
            }
        }
        internal void SendBGThroughEmail(string fullName, string SenderName, string toEmails, string SenderEmail, string CC)
        {

            string StringDataTable = ConvertToHtmlFileForBG(fullName);

            MailMessage Mail_Message = new MailMessage();
            Mail_Message.From = new MailAddress(SenderEmail, SenderName);
            Mail_Message.To.Add(toEmails);
            //Mail_Message.CC.Add(CC);                
            Mail_Message.Subject = "Thank You for your interest in BGs LED TV";
            Mail_Message.Body = StringDataTable;
            Mail_Message.IsBodyHtml = true;
            Send_EmailBG(Mail_Message);
            //dtEmail.Reset();
            //}
        }
        private static string ConvertToHtmlFile(DataTable targetTable, DateTime date, DataTable DomainTable)
        {
            string myHtmlFile = "";
            int totalSelectedRows = 0;
            if (targetTable == null)
            {
                throw new System.ArgumentNullException("targetTable");
            }
            else
            {
                //Continue. 
            }

            //Get a worker object.
            StringBuilder myBuilder = new StringBuilder();

            myBuilder.Append("<span style='font-family: Calibri; font-size: small;'>");
            myBuilder.Append("<b>Dear All,</b>");
            myBuilder.Append("<br />");
            myBuilder.Append("<br />");
            myBuilder.Append("This is to inform you that following tentative number of new Axactian may join from <b>" + date.ToLongDateString() + "</b>. Final Notice of confirmed Axactian(s) will be circulated later. ");
            myBuilder.Append("<br />");
            myBuilder.Append("<br />");
            foreach (DataRow myRow in DomainTable.Rows)
            {
                myBuilder.Append("<li>");
                DataRow[] dr = targetTable.Select("Domain='" + myRow[0].ToString() + "'");
                myBuilder.Append(myRow[0].ToString() + " : " + dr.Length);
                myBuilder.Append("</li>");
                totalSelectedRows = totalSelectedRows + dr.Length;
            }

            myBuilder.Append("<br />");
            myBuilder.Append("<br />");

            myBuilder.Append("<b>Total :" + totalSelectedRows);

            myBuilder.Append("<br />");
            myBuilder.Append("<br />");
            myBuilder.Append("<u><b>Name of New Joining on " + date.ToLongDateString() + "</b></u>");
            myBuilder.Append("<br />");
            myBuilder.Append("<br />");
            myBuilder.Append("</span>");

            myBuilder.Append("<table border='1px' cellpadding='5' cellspacing='0' ");
            myBuilder.Append("style='border: solid 1px Silver; font-size: small; font-family: Calibri;'>");

            //Add the headings row.

            myBuilder.Append("<tr align='left' valign='top'>");

            foreach (DataColumn myColumn in targetTable.Columns)
            {
                if (myColumn.ColumnName != "postedFromDate" && myColumn.ColumnName != "TentativeJoiningEmailData_Code")
                {
                    myBuilder.Append("<td align='left' valign='top' style='border: solid 1px Silver;  background-color: #000; color:#F0F8FF; text-align: center;'>");
                    myBuilder.Append(myColumn.ColumnName);
                    myBuilder.Append("</td>");
                }
            }

            myBuilder.Append("</tr>");

            //Add the data rows. 
            foreach (DataRow myRow in targetTable.Rows)
            {
                myBuilder.Append("<tr align='left' valign='top'>");

                foreach (DataColumn myColumn in targetTable.Columns)
                {
                    if (myColumn.ColumnName != "postedFromDate" && myColumn.ColumnName != "TentativeJoiningEmailData_Code")
                    {
                        myBuilder.Append("<td align='left' valign='top' style='border: solid 1px Silver;'>");
                        myBuilder.Append(myRow[myColumn.ColumnName].ToString());
                        myBuilder.Append("</td>");
                    }
                }
                myBuilder.Append("</tr>");
            }
            //Close tags. 
            myBuilder.Append("</table>"); myBuilder.Append("</body>"); myBuilder.Append("</html>");

            myBuilder.Append("<br />"); myBuilder.Append("<br />");
            myBuilder.Append("<span style='font-family: Calibri; font-size: small;'>");
            myBuilder.Append("<b>Note:</b> This is system generated email. Please contact Talent Acquisition Department in case of any query.");
            myBuilder.Append("<br />");
            myBuilder.Append("<br />");
            myBuilder.Append("Regards,");
            myBuilder.Append("<br />");
            myBuilder.Append("Recruitment Domain");
            myBuilder.Append("</span>");

            //Get the string for return. 
            myHtmlFile = myBuilder.ToString();

            return myHtmlFile;
        }
        private static string ConvertToHtmlFileForBG(string fullName)
        {
            string myHtmlFile = "";
            int totalSelectedRows = 0;


            //Get a worker object.
            StringBuilder myBuilder = new StringBuilder();

            myBuilder.Append("<span style='font-family: Calibri; font-size: small;'>");
            myBuilder.Append("<b>Dear " + fullName + ",</b>");
            myBuilder.Append("<br />");
            myBuilder.Append("<br />");
            myBuilder.Append("Thank you for signing up with BG Devices");
            myBuilder.Append("<br />");
            myBuilder.Append("<br />");

            myBuilder.Append("We appreciate your interest in BGs LED. Our representative will be in touch with you as soon as you are selected for this exclusive offer. Please note, currently BG is only available to a few national and international enterprises.");

            myBuilder.Append("<br />");
            myBuilder.Append("<br />");
            myBuilder.Append("At BG, excellence is our way of life and it reflects in everything we do. We truly believe in creating <b>smart</b> and <b>beautifully designed</b> products.");
            myBuilder.Append("<br />");
            myBuilder.Append("<br />");
            myBuilder.Append("</span>");

            myBuilder.Append("</body>"); myBuilder.Append("</html>");

            myBuilder.Append("<br />");
            myBuilder.Append("<span style='font-family: Calibri; font-size: small;'>");
            myBuilder.Append("Looking forward to serve you in the best possible way.");
            myBuilder.Append("<br />");
            myBuilder.Append("<br />");
            myBuilder.Append("Regards,");
            myBuilder.Append("<br />");
            myBuilder.Append("<b>BG</b>");
            myBuilder.Append("</span>");

            //Get the string for return. 
            myHtmlFile = myBuilder.ToString();

            return myHtmlFile;
        }

        private bool Send_Email(MailMessage Mail_Message)
        {
            SmtpClient smtp = new SmtpClient();
            System.Net.NetworkCredential nc = new System.Net.NetworkCredential();
            nc.UserName = "mail";
            nc.Password = "mail123";
            smtp.Host = "172.16.10.210";
            smtp.Credentials = nc;
            try
            {
                smtp.Send(Mail_Message);
                return true;
            }
            catch
            {
                return false;
            }

        }
        private bool Send_EmailBG(MailMessage Mail_Message)
        {
            SmtpClient smtp = new SmtpClient();
            System.Net.NetworkCredential nc = new System.Net.NetworkCredential();
            nc.UserName = "info@bgdevices.com";
            nc.Password = "3m@!l654";
            smtp.Host = "mail.bgdevices.com";
            smtp.Credentials = nc;
            try
            {
                smtp.Send(Mail_Message);
                return true;
            }
            catch
            {
                return false;
            }

        }
    }
}

---------------- UpdateTrainieepoints
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="UpdateTraineePoints.aspx.cs"
    Inherits="Admin_UpdateTraineePoints" %>

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1" runat="server">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/TrainingManagmentSystem/Area-v2.1/favicon.ico" />
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,300,100,500,700,900'
        rel='stylesheet' type='text/css' />
    <link rel="stylesheet" type="text/css" href="../assets/css/style.css" />
    <link href="../assets/css/jquery-ui-1.11.0.css" rel="stylesheet" />
    <!--[if lt IE 9]>
<script src="/TrainingManagmentSystem/Area-v2.1/assets/js/html5.js"></script>
<![endif]-->
    <style>
        .error {
            border-color: #d89a9a !important;
            border: 2px solid #d89a9a !important;
                    
        } 
    </style>
    <title>Update Trainee Points</title>
    <script src="../assets/js/jQlibs.js"></script>
    <script src="../assets/js/xlib.js"></script>
    <script>
        $(document).ready(function () {
            $("#txtjoinDateFrom").datepicker({
                onSelect: function (dateText) {
                },
                dateFormat: 'MM dd, yy'
            });

            $("#txtjoinDateTo").datepicker({
                onSelect: function (dateText) {
                },
                dateFormat: 'MM dd, yy'
            });

            function hide() {
                if ($('.lnkAppearclass').size() == 0)
                    $('#btnAppearAssessment').hide();
                else
                    $('#btnAppearAssessment').show();
            }

        });

        function toggleSelection(source) {
            var targetID = 'chk';
            var target = source.parentNode.parentNode.parentNode.parentNode;
            // Find all checkboxes
            var inputs = target.getElementsByTagName('input');

            //Check all   
            if (source.checked)
                for (var i = 0; i < inputs.length; i++) {
                    if (inputs[i].type == "checkbox") {
                        if (inputs[i].id.indexOf(targetID) >= 0) {
                            inputs[i].checked = true;
                        }
                    }
                }
                // Uncheck all   
            else
                for (var i = 0; i < inputs.length; i++) {
                    if (inputs[i].type == "checkbox") {
                        if (inputs[i].id.indexOf(targetID) >= 0) {
                            inputs[i].checked = false;
                        }
                    }

                }
        }

        function isNumberKey(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;

        }

        function validateForm(evt) {
            $('#selectChkbxError').hide();
            var isPoints, isConducteBy, isComments = false;  

            var points = $(evt).parents('tr').find('.pointtxt').val();
            var conductedBy = $(evt).parents('tr').find('.ddlConductedby').val();
            var comments = $(evt).parents('tr').find('.Commentstxt').val();

            if ( points == "" || points == "0" ) {
                $(evt).parents('tr').find('.pointtxt').addClass('error');               
                isPoints = false;
            } else {
                $(evt).parents('tr').find('.pointtxt').removeClass('error');               
                isPoints = true;
            }

            if (conductedBy == "-1") {
                $(evt).parents('tr').find('.ddlConductedby').addClass('error');
                isConducteBy = false;
            } else {
                $(evt).parents('tr').find('.ddlConductedby').removeClass('error');
                isConducteBy = true;
            }

            if (comments == "") {
                $(evt).parents('tr').find('.Commentstxt').addClass('error');
                isComments = false;
            } else {
                $(evt).parents('tr').find('.Commentstxt').removeClass('error');
                isComments = true;
            }

            if (isPoints && isConducteBy && isComments) {
                return true;
            }
            else {
                return false;
            }            

        }

        function validateAllForm(evt) {
            $('#selectChkbxError').hide();
            var overall = false;
            var overallCount = 0;

            var totalCheckedBx = $('.tr_chk').find('input:checkbox:checked').size();

            if (totalCheckedBx == 0) {
                $('#selectChkbxError').show();
                return false;
            }            

            $('.tr_chk').find('input:checkbox').each(function () {
                if (this.checked) {                    
                    var isPoints, isConducteBy, isComments = false;

                    var points = $(this).parents('tr').find('.pointtxt').val();
                    var conductedBy = $(this).parents('tr').find('.ddlConductedby').val();
                    var comments = $(this).parents('tr').find('.Commentstxt').val();

                    if (points == "" || points == "0") {
                        $(this).parents('tr').find('.pointtxt').addClass('error');
                        isPoints = false;
                    } else {
                        $(this).parents('tr').find('.pointtxt').removeClass('error');
                        isPoints = true;
                    }

                    if (conductedBy == "-1") {
                        $(this).parents('tr').find('.ddlConductedby').addClass('error');
                        isConducteBy = false;
                    } else {
                        $(this).parents('tr').find('.ddlConductedby').removeClass('error');
                        isConducteBy = true;
                    }

                    if (comments == "") {
                        $(this).parents('tr').find('.Commentstxt').addClass('error');
                        isComments = false;
                    } else {
                        $(this).parents('tr').find('.Commentstxt').removeClass('error');
                        isComments = true;
                    }

                    if (isPoints && isConducteBy && isComments) {
                        overall = true;
                        overallCount++;
                    }
                    else {
                        overall = false;
                    }

                }
            });

            if (overallCount == totalCheckedBx) {
                return true;
            }          
            else {
                return false;
            }
        }
    </script>
    <style>
        input[type="text"], input[type="password"], input[type="email"] {
            background: none repeat scroll 0 0 #fff;
            border: 1px solid #fff;
            border-radius: 3px;
            font-size: 13px;
            font-weight: 300;
            line-height: 15px;
            padding: 0px 0px;
            transition: all 200ms linear 0s;
        }
    </style>
    <style>
        .topnav {
            overflow: hidden;
            background-color: #333;
            margin-top: 12px;
            margin-left: 12px;
            margin-right: 12px;
        }

            .topnav a {
                float: left;
                display: block;
                color: #f2f2f2;
                text-align: center;
                padding: 14px 16px;
                text-decoration: none;
                font-size: 17px;
            }

                .topnav a:hover {
                    background-color: #ddd;
                    color: black;
                }

                .topnav a.active {
                    background-color: #097cc9;
                    color: white;
                }
                 .tr_chks {
        position: absolute;
    top: 147px;
    margin-left: -411px;
        }
    </style>
</head>
<body>

    <form id="form1" runat="server">
        <asp:ScriptManager ID="ScriptManager1" runat="server">
        </asp:ScriptManager>
        <div class="mainwrap">
            <header>
                <section class="clear">
                    <%-- <a href="javascript:" class="logo lfl">
                        <img src="../assets/images/logo.png" alt="home" width="165" height="30"></a>
                    <div class="lftbar rfl">
                    </div>--%>
                    <div class="topnav">                      
                        <a href="http://xent2:200/xtraining/Admin/TrainingReport.aspx" style="font-size: 14px;">Training Report</a>
                        <a class="active" href="http://xent2:200/xtraining/Admin/UpdateTraineePoints.aspx" style="font-size: 14px;">Update Trainee Points</a>
                        <a href="../Admin/PrintingReport.aspx" " style="font-size: 14px;">Certificate Report</a>
                         <a href="../Admin/StaffAssessmentLogin.aspx" " style="font-size: 14px;">Staff Assessment</a>
                        <a href="http://myaxactweb:200/xhrms/x_hrmsmisc/BA/BM.aspx?bm=3" target="_blank" style="font-size: 14px;">Benefits Delivery</a>
                    </div>
                </section>
            </header>
            <%--   <div class="lftmenu anim">
                <ul>
                    <li><a href="../TraineeArea/Home.aspx"><i data-position="1 20"></i><i data-position="33 20"></i>Home</a></li>
                    <li><a href="../TraineeArea/TrainingSummary.aspx"><i data-position="1 50"></i><i
                        data-position="33 50"></i>Training Summary <span class="alert" id="spnCount" runat="server">11</span></a></li>
                    <li><a href="../TraineeArea/HomeSoftSkills.aspx"><i data-position="1 20"></i><i data-position="33 20"></i>Home</a></li>
                    <li><a href="../TraineeArea/TrainingSummarySoftSkill.aspx"><i data-position="1 50"></i><i
                        data-position="33 50"></i>Training Summary <span class="alert" id="spnCountSoftSkill" runat="server">11</span></a></li>
                </ul>
            </div>--%>
            <div class="innnerwrap">
                <br />
                <br />
                <br />
                <h2 align="center">Points Updation Screen
                </h2>
                <br />
                <div align="center">
                    <table style="border-collapse: collapse" cellspacing="3" cellpadding="3" width="60%"
                        align="center" border="1">
                        <tr style="height: 30px">
                            <th colspan="4">Search Filters
                            </th>
                        </tr>
                            <asp:CheckBox ID="chkbox_joining" class="tr_chks" runat="server" checked="true"/>
                        <tr style="height: 40px">

                            <td align="center">Joining Date From:
                            </td>
                            <td align="left" style="padding-left: 30px;">
                                <asp:TextBox ID="txtjoinDateFrom" Height="23px" Width="240px" runat="server" CssClass="calender"></asp:TextBox>
                            </td>
                            <td align="center">Joining Date To:
                            </td>
                            <td align="left" style="padding-left: 30px;">
                                <asp:TextBox ID="txtjoinDateTo" Height="23px" Width="240px" runat="server" CssClass="calender"></asp:TextBox>
                            </td>
                        </tr>
                        <tr style="height: 40px">
                            <td align="center">Department:
                            </td>
                            <td align="left" style="padding-left: 30px;">
                                <asp:DropDownList ID="ddlDepartment" runat="server" Width="240px" Height="25px" EnableViewState="true">
                                </asp:DropDownList>
                            </td>
                            <td align="center">Trainee:
                            </td>
                            <td align="left" style="padding-left: 30px;">
                                <asp:TextBox ID="txtbxTrainee" Height="23px" Width="240px" runat="server"></asp:TextBox>
                            </td>
                        </tr>
                        <tr style="height: 40px">
                            <td align="center">Location:
                            </td>
                            <td align="left" style="padding-left: 30px;">
                                <asp:DropDownList ID="ddlLoc" runat="server" Width="244px" Height="25px" EnableViewState="true">
                                    <asp:ListItem Value="-1" Text="--All--" Selected="True"></asp:ListItem>
                                    <asp:ListItem Value="1" Text="Karachi"></asp:ListItem>
                                    <asp:ListItem Value="1482" Text="Islamabad"></asp:ListItem>
                                    <asp:ListItem Value="1486" Text="Lahore"></asp:ListItem>
                                </asp:DropDownList>
                            </td> 
                           <%-- <td colspan="2"></td>--%>
                            <td align="center">User Type:
                            </td>
                            <td align="left" style="padding-left: 30px;">
                                <asp:DropDownList ID="ddlUserType" runat="server" Width="244px" Height="25px" EnableViewState="true">                                    
                                    <asp:ListItem Value="0" Text="Officer" Selected="True"></asp:ListItem>
                                    <asp:ListItem Value="1" Text="Staff"></asp:ListItem>                                    
                                </asp:DropDownList>                              
                            </td>
                        </tr>
                        <tr style="height: 40px">
                            <td align="center" colspan="4">
                                <asp:Button ID="btn_search" runat="server" OnClick="btn_search_Click" Text="Search"
                                    Width="102px" />
                                &nbsp;&nbsp;&nbsp;
                            <asp:Button ID="btnExcel" runat="server" Text="Export" OnClick="btnExcel_Click" Visible="false" />
                            </td>
                        </tr>
                    </table>
                </div>
                <br />
                <article>
                    <asp:UpdatePanel ID="UpdatePane23" runat="server">
                        <ContentTemplate>
                            <div style="text-align: center">
                                <asp:Label ID="lblMsg" runat="server" Text="No Data Found" ForeColor="Red" Visible="false"></asp:Label>
                            </div>
                            <table width="95%" border="0" cellspacing="1" cellpadding="5" class="feedback-tb">
                                <tr>
                                    <td align="center">
                                        <asp:UpdateProgress ID="UpdateProgress1" runat="server">
                                            <ProgressTemplate>
                                                <img src="../assets/images/loader.gif" alt="" align="middle" />
                                            </ProgressTemplate>
                                        </asp:UpdateProgress>

                                    </td>
                                </tr>
                                <tr>
                                    <td align="center" class="auto-style5">
                                        <asp:Label ID="lbl_result" runat="server" ForeColor="Red" Visible="false"></asp:Label>
                                        <div id="trPagingControls" runat="server" style="display: none" align="center">
                                            <asp:LinkButton ID="lnkbtnFirstPage" runat="server" Font-Bold="True" Font-Underline="False"
                                                ToolTip="First Page" OnClick="lnkbtnFirstPage_Click" Visible="False"><</asp:LinkButton>
                                            &nbsp; &nbsp;<asp:LinkButton ID="lnkbtnPrevPage" runat="server" Font-Bold="True"
                                                Font-Underline="False" ToolTip="Previous Page" OnClick="lnkbtnPrevPage_Click"
                                                Visible="False"><<</asp:LinkButton>&nbsp; &nbsp;&nbsp; &nbsp;<asp:Label ID="lblPageIndex"
                                                    runat="server" Text="Label" Visible="False"></asp:Label>&nbsp; &nbsp;<asp:LinkButton
                                                        ID="lnkbtnNextPage" runat="server" Font-Bold="True" Font-Underline="False" ToolTip="Next Page"
                                                        OnClick="lnkbtnNextPage_Click" Visible="False">>></asp:LinkButton>&nbsp;
                            &nbsp;<asp:LinkButton ID="lnkbtnLastPage" runat="server" Font-Bold="True" Font-Underline="False"
                                ToolTip="Last Page" OnClick="lnkbtnLastPage_Click" Visible="False">></asp:LinkButton>&nbsp;
                            &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;
                                        </div>
                                    </td>
                                </tr>
                            </table>

                            <asp:Repeater ID="rptUsers" runat="server" OnItemDataBound="rptUsers_ItemDataBound" OnItemCommand="rptUsers_ItemCommand">
                                <HeaderTemplate>
                                    <table width="95%" border="0" cellspacing="1" cellpadding="5" style="background-color: #808080; border-collapse: separate" class="feedback-tb">
                                        <tr style="background-color: white">
                                            <th>
                                                <input type="checkbox" id="CheckAll" runat="server" onclick="toggleSelection(this)" /></th>
                                            <th>Name
                                            </th>
                                            <%-- <th>Department Name
                                            </th>--%>
                                            <th>Training Name
                                            </th>
                                            <th>Status
                                            </th>
                                            <th>Oreintation Marks 
                                            </th>
                                            <th>Trainer
                                            </th>

                                            <th>Comments
                                            </th>

                                            <%--<th>Day 2
                                            </th>
                                            <th>RA
                                            </th>--%>
                                            <%--<th>Location </th>--%>
                                            <th>Action
                                            </th>
                                        </tr>
                                </HeaderTemplate>
                                <ItemTemplate>
                                    <tr style="background-color: white">
                                        <td align="center">
                                            <asp:CheckBox ID="chk" class="tr_chk" runat="server" />
                                        </td>
                                        <td align="center"><b><%# Eval("FullName")%> </b>
                                            <br />
                                            <asp:HiddenField ID="hdnUserTrainingCode" runat="server" Value='<%# Eval("UserTraining_Code")%>' />
                                            <asp:HiddenField ID="hdnUserPortalID" runat="server" Value='<%# Eval("UserPortal_ID")%>' />

                                            <%# Eval("DeptName")%>
                                            <br />
                                            <%# Eval("Location")%> 
                                        </td>
                                        <td align="center"><%# Eval("Training_Title")%>
                                            <br />Joining Date: <%# Eval("joiningDate")%>  

                                        </td>

                                        <td align="center"><%# Eval("Status")%>
                                        </td>
                                        <td align="center" style="padding-top: 6px;">
                                            <asp:TextBox ID="txtDay1Points" class="pointtxt" runat="server" Width="40px" Height="30px" MaxLength="2" onkeypress="return isNumberKey(event);" Text='<%# Eval("Day1Points")%>'></asp:TextBox>
                                            / <%# Eval("Day1MaxPoints")%>
                                        </td>
                                        <td align="center">
                                            <asp:DropDownList ID="ddlOrientationConductedBy" class="ddlConductedby" runat="server" Width="150px" Font-Size="11px"
                                                Font-Names="Verdana">
                                            </asp:DropDownList>
                                        </td>
                                        <td align="center" style="padding-top: 6px;">
                                            <asp:TextBox ID="txtComments" runat="server" Width="175px" Text='<%# DataBinder.Eval(Container.DataItem ,"Comments") %>'
                                                TextMode="MultiLine" Font-Size="11px" Font-Names="Verdana" Height="50px" class="Commentstxt"></asp:TextBox>
                                        </td>
    

                                        <%--<td align="center">
                                            <asp:TextBox ID="txtDay2Points" runat="server" Width="40px" Height="30px" Text='<%# Eval("Day2Points")%>'></asp:TextBox>
                                            / <%# Eval("Day2MaxPoints")%>
                                        </td>
                                        <td align="center">
                                            <asp:TextBox ID="txtRAPoints" runat="server" Width="40px" Height="30px" Text='<%# Eval("RAPoints")%>'></asp:TextBox>
                                            / <%# Eval("RAMaxPoints")%>
                                        </td>--%>
                                        <%--<td align="center">
                                            <%# Eval("Location")%>
                                        </td>--%>
                                        <td align="center">
                                            <asp:LinkButton ID="lnkUpdate" runat="server" CssClass="lnkUpdateclass" Text="Assign Points" ValidationGroup="valida" CommandArgument='<%# Eval("UserTraining_Code")%>' CommandName="Assign" OnClientClick="return validateForm(this);"> </asp:LinkButton>
                                            
                                            <asp:LinkButton ID="lnkAppear" runat="server" CssClass="lnkAppearclass" Text="| Activate Assessment" CommandArgument='<%# Eval("UserTraining_Code")%>' CommandName="Appear" OnClientClick="return validateForm(this);"></asp:LinkButton>

                                        </td>
                                    </tr>
                                </ItemTemplate>
                                <FooterTemplate>
                                    </table>
                                </FooterTemplate>
                            </asp:Repeater>
                            <br />

                            <div style="float: right; padding-right: 60px;">
                                <span id="selectChkbxError" style="color:red;display:none;padding-right: 19px; font-size: 13px;">*Please select User</span>
                                <asp:Button ID="btnAssignMain" CssClass="asingmnt" runat="server" Visible="false" Text="Assign Points" OnClick="btnAssignMain_Click" OnClientClick="return validateAllForm(this);" />
                                <asp:Button ID="btnAppearAssessment" CssClass="asingmnt" runat="server" Visible="false" Text="Activate Assessment" OnClick="btnAppearAssessment_Click" OnClientClick="return validateAllForm(this);"  />
                            </div>
                        </ContentTemplate>
                        <Triggers>
                            <asp:AsyncPostBackTrigger ControlID="btn_search" />
                        </Triggers>
                    </asp:UpdatePanel>

                    <br />


                </article>
                <br />
                <br />
                <br />
                <br />
            </div>
        </div>
        <footer>
            <p>Copyright   <br />
                <br />
            </div>
        </div>
        <footer>
            <p>Copyright  <span><span><%= DateTime.Now.Year.ToString() %> </span></span>, Axact, All Rights Reserved.</p>
        </footer>
    </form>
</body>
</html>


using System;
using System.Collections.Generic;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Data;
using System.Data.SqlClient;
using System.Collections.Specialized;
using System.Configuration;
using System.Web.UI.HtmlControls;
using System.Collections;
using System.Threading;
using XTrainingLibrary;
using Microsoft.Practices.EnterpriseLibrary.Data;
using System.Data.Common;
using System.IO;

public partial class Admin_UpdateTraineePoints : System.Web.UI.Page
{
    #region Variable
    System.Web.UI.WebControls.PagedDataSource objPDS = new System.Web.UI.WebControls.PagedDataSource();
    static string SortDirection = "DESC";
    System.Data.DataSet ds;
    int index = 0;
    static DataView objDV = new DataView();
    int PageSize = 25;
    SecureQueryString objSQS = new SecureQueryString();
    #endregion
    #region Property
    private int PageNo
    {
        get
        {
            if (ViewState["PageNo"] != null)
                return Convert.ToInt32(ViewState["PageNo"]);
            else
                return 0;
        }
        set
        {
            ViewState["PageNo"] = value;
        }
    }
    #endregion
    protected void Page_Load(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            txtjoinDateFrom.Text = DateTime.Now.AddDays(-30).ToString("MMM dd, yyyy");
            txtjoinDateTo.Text = DateTime.Now.ToString("MMM dd, yyyy");
            BindOGData();

            //txtjoinDateFrom.Text = DateTime.Now.AddDays(-126).ToString("MMM dd, yyyy");
            //txtjoinDateTo.Text = DateTime.Now.AddDays(-96).ToString("MMM dd, yyyy");//DateTime.Now.ToString("MMM dd, yyyy");
            //ddlDepartment.SelectedValue = "44";


        }
    }
    private void BindData()
    {
        try
        {
            PageNo = 0;
            System.Data.DataSet ds = GetUserForPoints(ddlDepartment.SelectedValue, txtbxTrainee.Text.Trim(), txtjoinDateFrom.Text, txtjoinDateTo.Text, ddlLoc.SelectedValue, chkbox_joining.Checked, Convert.ToBoolean(Convert.ToInt32(ddlUserType.SelectedValue)));
            if (ds != null)
            {
                if (ds.Tables.Count > 0)
                {
                    if (ds.Tables[0].Rows.Count > 0)
                    {
                        ViewState["dsPoints"] = ds;
                        trPagingControls.Attributes.Add("style", "display:block");
                        lblMsg.Text = "";
                        lblMsg.Visible = false;
                        BindDataRepeater(rptUsers, ds, ref objDV);
                        btnAssignMain.Visible = true;
                        btnAppearAssessment.Visible = true;
                    }
                    else
                    {
                        ViewState["dsPoints"] = null;
                        trPagingControls.Attributes.Add("style", "display:none");
                        rptUsers.Visible = false;
                        lblMsg.Text = "Result not Found";
                        lblMsg.Visible = true;
                        btnAssignMain.Visible = false;
                        btnAppearAssessment.Visible = false;
                    }
                }
                else
                {
                    trPagingControls.Attributes.Add("style", "display:none");
                    trPagingControls.Visible = false;
                    rptUsers.Visible = false;
                    lblMsg.Visible = true;
                    lblMsg.Text = "Result not Found";
                    btnAssignMain.Visible = false;
                    btnAppearAssessment.Visible = false;

                }
            }
            else
            {
                trPagingControls.Attributes.Add("style", "display:none");
                trPagingControls.Visible = false;
                rptUsers.Visible = false;
                lblMsg.Visible = true;
                lblMsg.Text = "Result not Found";
                btnAssignMain.Visible = false;
                btnAppearAssessment.Visible = false;
            }
        }
        catch (Exception ex)
        {
            trPagingControls.Attributes.Add("style", "display:none");
            trPagingControls.Visible = false;
            rptUsers.Visible = false;
            lblMsg.Visible = true;
            lblMsg.Text = "Result not Found";
            btnAssignMain.Visible = false;
            btnAppearAssessment.Visible = false;
            LogError.Write(LogError.AppType.TrainingWebsite, ex.Message + " " + ex.StackTrace, ex, "0");

        }
    }
    private void BindDataRepeater(Repeater rpt, DataSet dds, ref DataView dv)
    {
        if (dds != null && dds.Tables[0].Rows.Count > 0)
        {
            dv = dds.Tables[0].DefaultView;
            rpt.Visible = true;
            rpt.DataSource = ApplyPaging(dv, PageNo);
            rpt.DataBind();
        }
        else
        {
            rpt.Visible = false;
        }
    }
    private void BindTrainers(DropDownList ddlTrainer, string TrainerUserID)
    {
        Database db = DatabaseFactory.CreateDatabase(Constants.XTrainingConnectionName);
        string sqlCommand = "[USP_TRN_Select_Trainer]";
        DbCommand dbCommand = db.GetStoredProcCommand(sqlCommand);
        dbCommand.CommandTimeout = Constants.ConnectionTimeOut;
        ds = db.ExecuteDataSet(dbCommand);


        // SqlQuery = "TR_Select_BATrainers";
        //ds = (DataSet)objDB.ExecuteQuery(SqlQuery, ReturnType.DataSetType);

        if (ds.Tables.Count > 0)
        {
            ddlTrainer.DataSource = ds.Tables[0];
            ddlTrainer.DataValueField = "Trainer_Code";
            ddlTrainer.DataTextField = "Trainer_Name";
            ddlTrainer.DataBind();
        }

        ddlTrainer.Items.Add(new ListItem("N/A", "-1"));
        ddlTrainer.SelectedValue = TrainerUserID;
    }

    protected void rptUsers_ItemDataBound(object sender, RepeaterItemEventArgs e)
    {
        if (e.Item.ItemType == ListItemType.Item || e.Item.ItemType == ListItemType.AlternatingItem)
        {
            DropDownList ddlOrientationConductedBy = (DropDownList)e.Item.FindControl("ddlOrientationConductedBy");
            BindTrainers(ddlOrientationConductedBy, Convert.ToString(DataBinder.Eval(e.Item.DataItem, "OrientationConductedBy")));

          

            LinkButton lnkAppear = (LinkButton)e.Item.FindControl("lnkAppear");
            LinkButton lnkUpdate = (LinkButton)e.Item.FindControl("lnkUpdate");         

            if (DataBinder.Eval(e.Item.DataItem, "Day1Points").ToString() == "0" || DataBinder.Eval(e.Item.DataItem, "Day1Points").ToString() == "" || DataBinder.Eval(e.Item.DataItem, "OrientationConductedBy").ToString() == "-1" || DataBinder.Eval(e.Item.DataItem, "Comments").ToString() == "")
            {
                lnkAppear.Visible = false;
               
            }
            else
            {

                lnkAppear.Visible = true;
               
            }


            if (DataBinder.Eval(e.Item.DataItem, "Is_AppearAssessmentShow").ToString() == "0")
            {
                lnkAppear.Enabled = false;
                lnkAppear.CommandName = "";
            }
            else
            {
                lnkAppear.Enabled = true;
                lnkAppear.CommandName = "Appear";
            }

            //if (AssessmentCount == 0)
            //{
            //    btnAppearAssessment.Visible = false;
            //}
            //else {
            //    btnAppearAssessment.Visible = true;
            //}

        }
    }
    protected void rptUsers_ItemCommand(object source, RepeaterCommandEventArgs e)
    {
        if (e.CommandName == "Assign")
        {
            string UserTrainingCode = e.CommandArgument.ToString();
            TextBox txtDay1Points = (TextBox)e.Item.FindControl("txtDay1Points");
            DropDownList ddlOrientationConductedBy = (DropDownList)e.Item.FindControl("ddlOrientationConductedBy");
            TextBox txtComments = (TextBox)e.Item.FindControl("txtComments");
            //TextBox txtDay2Points = (TextBox)e.Item.FindControl("txtDay2Points");
           // TextBox txtRAPoints = (TextBox)e.Item.FindControl("txtRAPoints");
            HiddenField hdnUserPortalID = (HiddenField)e.Item.FindControl("hdnUserPortalID");

            //UpdateUserPoints(UserTrainingCode, txtDay1Points.Text, txtDay2Points.Text, txtRAPoints.Text, Request.UserHostAddress.ToString(), hdnUserPortalID.Value);         
            UpdateUserPoints(UserTrainingCode, txtDay1Points.Text, txtComments.Text, Convert.ToInt32(ddlOrientationConductedBy.SelectedValue), Request.UserHostAddress.ToString(), hdnUserPortalID.Value);
            BindData();
        }
        if (e.CommandName == "Appear")
        {
            DataSet ds = new DataSet(); 
            string UserTrainingCode = e.CommandArgument.ToString();
            HiddenField hdnUserPortalID = (HiddenField)e.Item.FindControl("hdnUserPortalID");
            ds = UpdateUserAssessmentAppearTime(UserTrainingCode, Request.UserHostAddress.ToString(), hdnUserPortalID.Value);
            if (ds !=null && ds.Tables[0].Rows.Count>0)
                if (ds.Tables[0].Rows[0]["Result"].ToString()=="1")
            SendEmail(hdnUserPortalID.Value, Request.UserHostAddress.ToString());
            BindData();
        }
    }
    protected void btnAssignMain_Click(object sender, EventArgs e)
    {
        try
        {

            foreach (RepeaterItem rit in rptUsers.Items)
            {
                CheckBox chk = (CheckBox)rit.FindControl("chk");
                if (chk.Checked)
                {
                    HiddenField hdnUserTrainingCode = (HiddenField)rit.FindControl("hdnUserTrainingCode");
                    TextBox txtDay1Points = (TextBox)rit.FindControl("txtDay1Points");
                    DropDownList ddlOrientationConductedBy = (DropDownList)rit.FindControl("ddlOrientationConductedBy");
                    //TextBox txtDay2Points = (TextBox)rit.FindControl("txtDay2Points");
                    //TextBox txtRAPoints = (TextBox)rit.FindControl("txtRAPoints");
                    HiddenField hdnUserPortalID = (HiddenField)rit.FindControl("hdnUserPortalID");
                    TextBox txtComments = (TextBox)rit.FindControl("txtComments");

                   // UpdateUserPoints(hdnUserTrainingCode.Value, txtDay1Points.Text, txtDay2Points.Text, txtRAPoints.Text, Request.UserHostAddress.ToString(), hdnUserPortalID.Value);                 
                    UpdateUserPoints(hdnUserTrainingCode.Value, txtDay1Points.Text, txtComments.Text, Convert.ToInt32(ddlOrientationConductedBy.SelectedValue), Request.UserHostAddress.ToString(), hdnUserPortalID.Value);
                }
            }
        }
        catch (Exception ex)
        {
            LogError.Write(LogError.AppType.Admin, ex.Message + " " + ex.StackTrace, ex, "0");
        }

        BindData();
    }
    protected void btnAppearAssessment_Click(object sender, EventArgs e)
    {
        try
        {
            DataSet ds = new DataSet(); 
            string userlist = string.Empty;
            foreach (RepeaterItem rit in rptUsers.Items)
            {
                CheckBox chk = (CheckBox)rit.FindControl("chk");
                if (chk.Checked)
                {
                    LinkButton lnkAppear = (LinkButton)rit.FindControl("lnkAppear");
                    HiddenField hdnUserTrainingCode = (HiddenField)rit.FindControl("hdnUserTrainingCode");
                    HiddenField hdnUserPortalID = (HiddenField)rit.FindControl("hdnUserPortalID");

                    if (lnkAppear.Enabled)
                    {
                       ds= UpdateUserAssessmentAppearTime(hdnUserTrainingCode.Value, Request.UserHostAddress.ToString(), hdnUserPortalID.Value);
                        if (ds != null && ds.Tables[0].Rows.Count > 0)
                            if (ds.Tables[0].Rows[0]["Result"].ToString() == "1")
                        userlist = userlist + hdnUserPortalID.Value + ",";
                    }
                }              
            }
            if (userlist != string.Empty)
            {
                userlist = userlist.Substring(0, userlist.Length - 1);
                SendEmail(userlist, Request.UserHostAddress.ToString());
            }

        }
        catch (Exception ex)
        {
            LogError.Write(LogError.AppType.Admin, ex.Message + " " + ex.StackTrace, ex, "0");
        }

        BindData();
    }
    protected void btnExcel_Click(object sender, EventArgs e)
    {

        DataSet dsNew = (DataSet)ViewState["dsPoints"];
        if (dsNew != null)
        {
            if (dsNew.Tables.Count > 0)
            {
                if (dsNew.Tables[0].Rows.Count > 0)
                {
                    ExportDataSetToExcel(dsNew, "Users Points Data");
                }
            }
            else
            {
                rptUsers.Visible = false;
                lblMsg.Text = "Result not Found";
                lblMsg.Visible = true;
            }

        }
        else
        {
            rptUsers.Visible = false;
            lblMsg.Text = "Result not Found";
            lblMsg.Visible = true;
        }
    }
    public static void ExportDataSetToExcel(DataSet ds, string SheetName)
    {
        HttpResponse response = HttpContext.Current.Response;

        // first let's clean up the response.object
        response.Clear();
        response.Charset = "";

        // set the response mime type for excel
        response.ContentType = "application/vnd.ms-excel";
        response.AddHeader("Content-Disposition", "attachment;filename=\"" + SheetName + "\"");

        // create a string writer
        using (StringWriter sw = new StringWriter())
        {
            using (HtmlTextWriter htw = new HtmlTextWriter(sw))
            {
                #region Datatable work

                DataTable dtPrint = new DataTable();

                DataColumn dcPrint;

                dcPrint = new DataColumn();
                dcPrint.DataType = Type.GetType("System.String");
                dcPrint.ColumnName = "id";
                dtPrint.Columns.Add(dcPrint);

                dcPrint = new DataColumn();
                dcPrint.DataType = Type.GetType("System.String");
                dcPrint.ColumnName = "Name";
                dtPrint.Columns.Add(dcPrint);

                dcPrint = new DataColumn();
                dcPrint.DataType = Type.GetType("System.String");
                dcPrint.ColumnName = "Department";
                dtPrint.Columns.Add(dcPrint);

                dcPrint = new DataColumn();
                dcPrint.DataType = Type.GetType("System.String");
                dcPrint.ColumnName = "Training";
                dtPrint.Columns.Add(dcPrint);

                //dcPrint = new DataColumn();
                //dcPrint.DataType = Type.GetType("System.String");
                //dcPrint.ColumnName = "JoiningDate";
                //dtPrint.Columns.Add(dcPrint);
                int sno = 0;
                foreach (DataRow dr in ds.Tables[0].Rows)
                {
                    DataRow row;
                    row = dtPrint.NewRow();
                    sno = sno + 1;
                    row["id"] = sno.ToString();
                    row["Name"] = dr["FullName"].ToString();
                    row["Department"] = dr["DeptName"].ToString();
                    row["Training"] = dr["Training_Title"].ToString();
                    dtPrint.Rows.Add(row);
                }

                #endregion


                DataGrid dg = new DataGrid();
                dg.DataSource = dtPrint;
                dg.DataBind();
                dg.RenderControl(htw);
                response.Write(sw.ToString());
                response.End();
            }
        }
    }
    public System.Web.UI.WebControls.PagedDataSource ApplyPaging(System.Data.DataView DV, int PageNo)
    {

        objPDS.DataSource = DV;
        objPDS.AllowPaging = true;
        //objPDS.PageSize = Convert.ToInt32(System.Configuration.ConfigurationSettings.AppSettings["PageSize"]); 
        objPDS.PageSize = PageSize;
        objPDS.CurrentPageIndex = PageNo;
        ViewState["PageCount"] = objPDS.PageCount.ToString();
        if (objPDS.PageCount > 1)
        {
            trPagingControls.Attributes.Add("style", "display:block");
            lblPageIndex.Visible = true;
            lblPageIndex.Text = "Page : " + (objPDS.CurrentPageIndex + 1).ToString() + " of " + objPDS.PageCount.ToString();
            if (objPDS.CurrentPageIndex == 0)
            {
                lnkbtnFirstPage.Visible = false;
                lnkbtnLastPage.Visible = true;
                lnkbtnNextPage.Visible = true;
                lnkbtnPrevPage.Visible = false;
            }
            else
                if (objPDS.CurrentPageIndex == (objPDS.PageCount - 1))
                {
                    lnkbtnFirstPage.Visible = true;
                    lnkbtnLastPage.Visible = false;
                    lnkbtnNextPage.Visible = false;
                    lnkbtnPrevPage.Visible = true;
                }
                else
                {
                    lnkbtnFirstPage.Visible = true;
                    lnkbtnLastPage.Visible = true;
                    lnkbtnNextPage.Visible = true;
                    lnkbtnPrevPage.Visible = true;
                }
        }
        else
        {
            //trLegends.Attributes.Add("style", "display:none");
            trPagingControls.Attributes.Add("style", "display:none");
        }
        return objPDS;
    }
    protected void lnkbtnFirstPage_Click(object sender, EventArgs e)
    {
        PageNo = 0;
        rptUsers.DataSource = ApplyPaging(objDV, PageNo);
        rptUsers.DataBind();
    }
    protected void lnkbtnPrevPage_Click(object sender, EventArgs e)
    {

        PageNo--;
        rptUsers.DataSource = ApplyPaging(objDV, PageNo);
        rptUsers.DataBind();
    }
    protected void lnkbtnNextPage_Click(object sender, EventArgs e)
    {

        PageNo++;
        rptUsers.DataSource = ApplyPaging(objDV, PageNo);
        rptUsers.DataBind();
    }
    protected void lnkbtnLastPage_Click(object sender, EventArgs e)
    {

        PageNo =
        Convert.ToInt32(ViewState["PageCount"]) - 1;
        rptUsers.DataSource = ApplyPaging(objDV, PageNo);
        rptUsers.DataBind();
    }
    private static DataSet GetDepartment()
    {
        Database db = DatabaseFactory.CreateDatabase(Constants.XTrainingConnectionName);
        string sqlCommand = "[USP_TRN_Select_OGDepartment]";
        DbCommand dbCommand = db.GetStoredProcCommand(sqlCommand);
        dbCommand.CommandTimeout = Constants.ConnectionTimeOut;
        return db.ExecuteDataSet(dbCommand);
    }
    private void BindOGData()
    {
        DataSet GetDepartments = GetDepartment();
        ddlDepartment.DataSource = GetDepartments.Tables[0];
        ddlDepartment.DataTextField = "deptName";
        ddlDepartment.DataValueField = "deptID";
        ddlDepartment.DataBind();
        ddlDepartment.Items.Insert(0, new ListItem("--All--", "-1"));

    }
    public static DataSet GetUserForPoints(string DepartmentCode, string TraineeName, string FromDate, string ToDate, string LocationCode, bool IsjoiningDate,bool userType)
    {
        Database db = DatabaseFactory.CreateDatabase(Constants.XTrainingConnectionName);
        string sqlCommand = "[USP_TRN_Select_UserActiveTrainingPoints]";
        DbCommand dbCommand = db.GetStoredProcCommand(sqlCommand);
        dbCommand.CommandTimeout = Constants.ConnectionTimeOut;

        db.AddInParameter(dbCommand, "@DepartmentCode", DbType.Int32, DepartmentCode);
        db.AddInParameter(dbCommand, "@TraineeName", DbType.String, TraineeName);
        db.AddInParameter(dbCommand, "@DateFrom", DbType.DateTime, FromDate);
        db.AddInParameter(dbCommand, "@Dateto", DbType.DateTime, ToDate);
        db.AddInParameter(dbCommand, "@LocationCode", DbType.Int32, LocationCode);
        db.AddInParameter(dbCommand, "@IsjoiningDate", DbType.Boolean, IsjoiningDate);
        db.AddInParameter(dbCommand, "@IsSupportStaff", DbType.Boolean, userType);
        

        return db.ExecuteDataSet(dbCommand);

    }
    //public static DataSet UpdateUserPoints(string UserTrainingCode, string Day1Points, string Day2Points, string RAPoints, string IP, string UserportalID)
    //{
    //    Database db = DatabaseFactory.CreateDatabase(Constants.XTrainingConnectionName);
    //    string sqlCommand = "[USP_TRN_Update_UserPoints]";
    //    DbCommand dbCommand = db.GetStoredProcCommand(sqlCommand);
    //    dbCommand.CommandTimeout = Constants.ConnectionTimeOut;

    //    db.AddInParameter(dbCommand, "@UserTrainingCode", DbType.Int32, UserTrainingCode);
    //    db.AddInParameter(dbCommand, "@Day1Points", DbType.Int32, Day1Points);
    //    db.AddInParameter(dbCommand, "@Day2Points", DbType.Int32, Day2Points);
    //    db.AddInParameter(dbCommand, "@RAPoints", DbType.Int32, RAPoints);
    //    db.AddInParameter(dbCommand, "@IP", DbType.String, IP);
    //    db.AddInParameter(dbCommand, "@UserPortalID", DbType.Int32, UserportalID);
    //    return db.ExecuteDataSet(dbCommand);

    //}
    public static DataSet UpdateUserPoints(string UserTrainingCode, string Day1Points,string Comments,int ConductedBy, string IP, string UserportalID)
    {
        Database db = DatabaseFactory.CreateDatabase(Constants.XTrainingConnectionName);
        string sqlCommand = "[USP_TRN_Update_UserPoints]";
        DbCommand dbCommand = db.GetStoredProcCommand(sqlCommand);
        dbCommand.CommandTimeout = Constants.ConnectionTimeOut;

        db.AddInParameter(dbCommand, "@UserTrainingCode", DbType.Int32, UserTrainingCode);
        db.AddInParameter(dbCommand, "@Day1Points", DbType.Int32, Day1Points);
        db.AddInParameter(dbCommand, "@Comments", DbType.String, Comments);
        db.AddInParameter(dbCommand, "@ConductedBy", DbType.Int32, ConductedBy);
       // db.AddInParameter(dbCommand, "@Day2Points", DbType.Int32, Day2Points);
       // db.AddInParameter(dbCommand, "@RAPoints", DbType.Int32, RAPoints);
        db.AddInParameter(dbCommand, "@IP", DbType.String, IP);
        db.AddInParameter(dbCommand, "@UserPortalID", DbType.Int32, UserportalID);
        return db.ExecuteDataSet(dbCommand);

    }
    public static DataSet UpdateUserAssessmentAppearTime(string UserTrainingCode, string IP, string UserPortalID)
    {

        Database db = DatabaseFactory.CreateDatabase(Constants.XTrainingConnectionName);
        string sqlCommand = "[USP_TRN_Update_UserAssessmentAppearTime]";
        DbCommand dbCommand = db.GetStoredProcCommand(sqlCommand);
        dbCommand.CommandTimeout = Constants.ConnectionTimeOut;

        db.AddInParameter(dbCommand, "@UserTrainingCode", DbType.Int32, UserTrainingCode);
        db.AddInParameter(dbCommand, "@IP", DbType.String, IP);
        db.AddInParameter(dbCommand, "@UserPortalID", DbType.Int32, UserPortalID);
        return db.ExecuteDataSet(dbCommand);

    }
    protected void btn_search_Click(object sender, EventArgs e)
    {
        BindData();
    }
    public static DataSet SendEmail(string UserPortalIdCsv, string IP)
    {
        Database db = DatabaseFactory.CreateDatabase(Constants.XTrainingConnectionName);
        string sqlCommand = "[USP_TRN_SendEmailToUser]";
        DbCommand dbCommand = db.GetStoredProcCommand(sqlCommand);
        dbCommand.CommandTimeout = Constants.ConnectionTimeOut;

        db.AddInParameter(dbCommand, "@UserIdCsv", DbType.String, UserPortalIdCsv);
        db.AddInParameter(dbCommand, "@IP", DbType.String, IP);
        return db.ExecuteDataSet(dbCommand);

    }
}


-----------------------TeaReport

<%@ Page Language="C#" AutoEventWireup="true"
    Inherits="Reports_TeaOrderReport" MasterPageFile="~/xFood.master" CodeFile="TeaOrderReport.aspx.cs" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" runat="Server">
    <link title="win2k-cold-1" media="all" href="../Includes/calendar/calendar-win2k-cold-1.css"
        type="text/css" rel="stylesheet" />
    <!-- main calendar program -->
    <script language="JavaScript" type="text/JavaScript">

        function MM_openBrWindow(theURL, winName, features) {
            window.open(theURL, winName, features);
        }
        function openWindow(theURL) {
            //alert(theURL);
            window.open(theURL, 'XFOOD', 'toolbar=0,width=600,height=500');
        }

    </script>

    <style>
        .container {
            /*width: 80%;*/
        }
    </style>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="Main" runat="Server">
    <div class="container">
        <div style="padding: 25px 60px;">
            <span style="font-size: 24pt"><span style="font-family: Arial"></span></span>
            <table>
                <tr>
                    <td style="width: 791px">
                        <span style="font-size: 24pt; font-family: Arial">Tea Order Report &nbsp;</span>&nbsp;
                    </td>
                </tr>
                <tr>
                    <td style="width: 791px">Here you can view all Tea orders
                    </td>
                </tr>
                <tr>
                    <td style="width: 791px; text-align: center;">
                        <table width="70%">
                            <tr>
                                <td style="width: 100px; text-align: left">Date
                                </td>
                                <td align="left">
                                    <asp:TextBox ClientIDMode="Static" ID="txtFrom" runat="server" CssClass="fv11" Width="150px"></asp:TextBox><img
                                        id="cal" height="24" src="../Includes/calendar/calendar.gif" style="cursor: pointer"
                                        title="Date selector" width="24" />
                                    <script type="text/javascript">
                                        Calendar.setup({
                                            inputField: "txtFrom",      // id of the input field
                                            ifFormat: "M dd, y",       // format of the input field
                                            //ifFormat       :    "y-M-dd",       // format of the input field
                                            //ifFormat       :    "M-dd-y",       // format of the input field
                                            button: "cal",   // trigger for the calendar (button ID)
                                            singleClick: true            // double-click mode
                                        });
                                    </script>
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 100px; text-align: left">Location
                                </td>
                                <td align="left">
                                    <asp:DropDownList ClientIDMode="Static" ID="ddlLocation" runat="server" CssClass="fv11" Width="155px" OnSelectedIndexChanged="ddlLocation_SelectedIndexChanged" AutoPostBack="true">
                                        <asp:ListItem Value="1">Karachi</asp:ListItem>
                                        <asp:ListItem Value="1482">Islamabad</asp:ListItem>
                                        <asp:ListItem Value="1486">Lahore</asp:ListItem>
                                    </asp:DropDownList>
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 100px; text-align: left">Floor Name
                                </td>
                                <td align="left">
                                    <asp:DropDownList ClientIDMode="Static" ID="ddlFloor" runat="server" CssClass="fv11" Width="155px">
                                        <asp:ListItem Value="-1">--select--</asp:ListItem>
                                    </asp:DropDownList>
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 100px; text-align: left">Tea Timing
                                </td>
                                <td align="left">
                                    <asp:DropDownList ClientIDMode="Static" ID="ddlTeaTiming" runat="server" CssClass="fv11" Width="155px">
                                        <asp:ListItem Value="-1">--select--</asp:ListItem>
                                    </asp:DropDownList>
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 100px; text-align: left">Tea Type User
                                </td>
                                <td align="left">
                                    <asp:DropDownList ClientIDMode="Static" ID="ddlTeaUserType" runat="server" CssClass="fv11" Width="155px">
                                        <asp:ListItem Value="-1">--select--</asp:ListItem>
                                        <asp:ListItem Value="Regularly">Regular</asp:ListItem>
                                        <asp:ListItem Value="Occasionally">Occasionally</asp:ListItem>
                                        <asp:ListItem Value="I dont drink tea">Donot Drink</asp:ListItem>
                                        <asp:ListItem Value="No Record Found">No Record Found</asp:ListItem>
                                    </asp:DropDownList>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2" style="height: 26px" align="center">
                                    <asp:Button ID="btnView" runat="server" Text="View" OnClick="btnView_Click" CssClass="btn"
                                        Width="56px" />
                                    <asp:Button ID="btnViewSummary" runat="server" Text="View Summary" OnClick="btnViewSummary_Click" CssClass="btn"
                                        Width="110px" />
                                    <asp:Button ID="btnExportExcel" runat="server" Text="Export" OnClientClick="return Validation();"
                                        OnClick="btnExportExcel_Click" CssClass="btn" Width="61px" />
                                    <asp:Button ID="btnPrint" runat="server" Text="Print" OnClientClick="javascript:window.print();"
                                        CssClass="btn" />
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td style="width: 791px; text-align: right">
                        <asp:Label ID="lblMsg" runat="server"></asp:Label>
                    </td>
                </tr>
                <tr id="trDetails" visible="false" runat="server">
                    <td style="width: 791px; text-align: center">
                         <table width="100%" border="0" cellspacing="0" cellpadding="6" class="bd">
                                <tr height="50px">
                                    <td width="5%" align="center" class="bdb">
                                            <strong>Serving Time:  </strong><br>
                                            <asp:Label ID="lblServingTime" runat="server"> </asp:Label>
                                     </td>                                   
                                    <td width="5%" align="center" class="bdb">
                                            <strong> Order Start Time: </strong><br>
                                            <asp:Label ID="lblOrderStartTime" runat="server"> </asp:Label>
                                     </td>                                   
                                    <td width="5%" align="center" class="bdb">
                                            <strong> Order End Time:  </strong><br>
                                            <asp:Label ID="lblOrderEndTime" runat="server"> </asp:Label>
                                     </td>                                   
                                </tr>
                         </table>
                    </td>
                </tr>
                <tr runat="server" id="trView" visible ="false">                    
                    <td style="width: 791px; text-align: center">
                        <asp:Repeater ID="rptFloor" runat="server" OnItemDataBound="rptFloor_ItemDataBound">
                            <HeaderTemplate>
                                <table width="100%" border="0" cellspacing="0" cellpadding="6" class="bd">
                                    <tr style="background-color: Orange; color: white" height="50px">
                                        <td width="5%" align="center" class="bdr bdb">
                                            <strong>S.No</strong>
                                        </td>
                                        <td width="5%" align="center" class="bdr bdb">
                                            <strong>UserId</strong>
                                        </td>
                                        <td width="30%" align="center" class="bdr bdb">
                                            <strong>Employee</strong>
                                        </td>
                                        <td width="15%" align="center" class="bdr bdb">
                                            <strong>Seat No</strong>
                                        </td>
                                        <td width="15%" align="center" class="bdr bdb">
                                            <strong>Order Time</strong>
                                        </td>
                                        <td width="15%" align="center" class="bdr bdb">
                                            <strong>Type</strong>
                                        </td>
                                        <td width="15%" align="center" class="bdr bdb">
                                            <strong>Shift Timing</strong>
                                        </td>
                                    </tr>
                            </HeaderTemplate>
                            <ItemTemplate>
                                <tr class="bgY2" height="30px">
                                    <td align="Center" colspan="9">
                                        <b>
                                            <%#Eval("FLOOR_NAME") %>
                                        </b>
                                    </td>
                                </tr>

                                <asp:Repeater ID="rptOrders" runat="server" OnItemDataBound="rptOrders_ItemDataBound">
                                    <ItemTemplate>
                                        <tr>
                                            <td class="bdr">
                                                <asp:Label ID="lblSNO" runat="server"></asp:Label>
                                            </td>
                                            <td align="center" class="bdr bdb">
                                                <%#Eval("UserId")%>
                                            </td>
                                            <td align="center" class="bdr bdb">
                                                <span id="spnImage" runat="server"></span>
                                                <%#Eval("FullName")%>
                                                <br />
                                                  <%#Eval("deptName")%>
                                            </td>
                                            <td align="center" class="bdr bdb">
                                                <%#Eval("Seat_No")%>
                                            </td>
                                            <td align="center" class="bdr bdb">
                                                <%#Eval("OrderPlacedTiming")%>
                                            </td>
                                            <td align="center" class="bdr bdb">
                                                <%#Eval("TeaUserType")%> 
                                            </td>
                                            <td align="center" class="bdr bdb">

                                                <%#Eval("ShiftStartTime", "{0:HH:mm}") %>-<%#Eval("ShiftEndTime", "{0:HH:mm}") %>

                                            </td>
                                        </tr>
                                    </ItemTemplate>
                                    <FooterTemplate>
                                        <tr class="totsub bold">
                                            <td colspan="6" align="right"><%#Eval("FLOOR_NAME") %> Total:
                                            </td>
                                            <td>
                                                <%#stTot%>
                                            </td>
                                        </tr>
                                    </FooterTemplate>
                                </asp:Repeater>

                            </ItemTemplate>
                        </asp:Repeater>
                    </td>
                </tr>
                <tr runat="server" id="trViewSummary" visible ="false">
                    <td style="width: 791px; text-align: center">
                        <asp:Repeater ID="rptFloorSummary" runat="server" OnItemDataBound="rptFloorSummary_ItemDataBound">
                            <HeaderTemplate>
                                <table width="100%" border="0" cellspacing="0" cellpadding="6" class="bd">
                                   <tr style="background-color: Orange; color: white" height="50px">
                                   <%-- <tr>--%>
                                       <td align="center" class="bdr bdb">
                                            <strong>S.No</strong>
                                        </td>
                                        <td align="center" class="bdr bdb">
                                            <strong>Floor Name</strong>
                                        </td>  
                                        <td align="center" class="bdr bdb">
                                            <%--<strong>Count</strong>--%>
                                            <strong><asp:Label Text="" ID="lblTeaTiming" runat="server" /></strong>
                                        </td>                                          
                                    </tr>
                            </HeaderTemplate>
                            <ItemTemplate>
                              <%--  <tr class="bgY2" height="30px">--%>
                                  <tr height="30px">
                                       <td align="Center" class="bdr bdb">
                                         <%#Container.ItemIndex+1 %>                                       
                                    </td>
                                    <%-- <asp:Label ID="lblSumrySNo" runat="server"></asp:Label>--%>
                                    <td align="Center" class="bdr bdb">                                       
                                            <%#Eval("FLOOR_NAME") %>                                        
                                    </td>
                                    <td align="Center" class="bdr bdb">
                                        <b>
                                           <%#Eval("count") %>
                                        </b>
                                    </td>
                                </tr>
                            </ItemTemplate>
                              <FooterTemplate>
                                        <tr class="totsub bold">
                                            <td colspan="2" align="right"> Total:
                                            </td>     
                                            <td  align="center"><%#stTotSummary%>
                                            </td>                                       
                                        </tr>
                             </FooterTemplate>
                        </asp:Repeater>
                    </td>
                </tr>
            </table>
            &nbsp;<br />
            <br />
            <br />
            <br />
        </div>
    </div>
</asp:Content>


using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using System.IO;


public partial class Reports_TeaOrderReport : System.Web.UI.Page
{
    DataSet objDSExcel;
    DBAccess objDB;
    string strSql = string.Empty;
    protected int stQty = 0;
    protected double stTot = 0;
    protected double stTotSummary = 0;
    string pictureName = string.Empty, path = string.Empty, Domain = "";

    protected void Page_Load(object sender, EventArgs e)
    {
        try
        {
            lblMsg.Text = "";
            if (!IsPostBack)
            {
                txtFrom.Text = System.DateTime.Now.ToString("MMM dd, yyyy");

                BindFloorType();
                BindTeaTiming();
                //GetHours();
                //GetMinutes();
                //BindData(txtFrom.Text.ToString(), -1, -1, ddlTeaUserType.SelectedValue);
            }
        }
        catch (Exception ex)
        {
            lblMsg.Text = ex.Message.ToString();
        }
    }

    protected void rptFloor_ItemDataBound(object sender, RepeaterItemEventArgs e)
    {
        if (e.Item.ItemType == ListItemType.Item || e.Item.ItemType == ListItemType.AlternatingItem)
        {
            //DataRowView drv = (DataRowView)e.Item.DataItem;
            //Repeater rptDates = (Repeater)e.Item.FindControl("rptDates");

            //rptDates.DataSource = drv.CreateChildView("FloorAndDates");
            //rptDates.DataBind();
            //Label lblDate = (Label)e.Item.FindControl("lblDate");
            //lblDate.Text = Convert.ToDateTime(DataBinder.Eval(e.Item.DataItem, "order_date").ToString()).ToString("dd, MMM yyyy");

            DataRowView drv = (DataRowView)e.Item.DataItem;
            
            Repeater rptOrders = (Repeater)e.Item.FindControl("rptOrders");            
            rptOrders.DataSource = drv.CreateChildView("FloorAndOrders");
            rptOrders.DataBind();
           
        }
    }

    protected void rptFloorSummary_ItemDataBound(object sender, RepeaterItemEventArgs e)
    {
        if (e.Item.ItemType == ListItemType.Header)
        {
            Label lblTeaTiming = (Label)e.Item.FindControl("lblTeaTiming");
            lblTeaTiming.Text = ddlTeaTiming.SelectedItem.Text + " - " + "Count";      
        }
        if (e.Item.ItemType == ListItemType.Item || e.Item.ItemType == ListItemType.AlternatingItem)
        {  
            DataRowView drv = (DataRowView)e.Item.DataItem;
           // Label lblSummaryCount = (Label)e.Item.FindControl("lblSummaryCount");
           // lblSummaryCount.Text = drv.CreateChildView("FloorAndOrders").Count.ToString();
            int tempTot = Convert.ToInt32(DataBinder.Eval(e.Item.DataItem, "count"));         
            stTotSummary += tempTot;
        }
        if (e.Item.ItemType == ListItemType.Footer)
        {            
            stTotSummary = 0;
        }
    }

    //protected void rptDates_ItemDataBound(object sender, RepeaterItemEventArgs e)
    //{
    //    if (e.Item.ItemType == ListItemType.Item || e.Item.ItemType == ListItemType.AlternatingItem)
    //    {
    //        Label lblDate = (Label)e.Item.FindControl("lblDate");
    //        lblDate.Text = Convert.ToDateTime(DataBinder.Eval(e.Item.DataItem, "order_date").ToString()).ToString("dd, MMM yyyy");

    //        DataRowView drv = (DataRowView)e.Item.DataItem;
    //        Repeater rptOrders = (Repeater)e.Item.FindControl("rptOrders");

    //        rptOrders.DataSource = drv.CreateChildView("OrderDateAndOrders");
    //        rptOrders.DataBind();
    //    }
    //}

    protected void rptOrders_ItemDataBound(object sender, RepeaterItemEventArgs e)
    {
        if (e.Item.ItemType == ListItemType.Item || e.Item.ItemType == ListItemType.AlternatingItem)
        {
            Label lblSNO = (Label)e.Item.FindControl("lblSNO");
            lblSNO.Text = (e.Item.ItemIndex + 1).ToString();
            //int tempQty = Convert.ToInt32(DataBinder.Eval(e.Item.DataItem, "qty").ToString());
            //double tempTot = Convert.ToDouble(DataBinder.Eval(e.Item.DataItem, "tot").ToString());


            HtmlGenericControl spnImage = (HtmlGenericControl)e.Item.FindControl("spnImage");



            pictureName = DataBinder.Eval(e.Item.DataItem, "cand_cat_code").ToString() + ".jpg";
            //if (DataBinder.Eval(e.Item.DataItem, "Is_SupportUser").ToString().ToLower() == "false")
            //{
            path = Domain + "/images/members/user/" + pictureName;
            spnImage.InnerHtml = "<DIV><a href=\"" + path + "\" class=\"highslide\"   onclick=\"return hs.expand(this)\">" +
             "<img src=\"" + path + "\" alt=\"Portal Picture\"  title=\"Click to enlarge\" width=\"37\" height=\"41\" /></a></DIV>";
            //}
            //else
            //{
            //path = Domain + "/images/members/support/" + pictureName;
            //spnImage.InnerHtml = "<DIV><a href=\"" + path + "\" class=\"highslide\"   onclick=\"return hs.expand(this)\">" +
            //   "<img src=\"" + path + "\" alt=\"Portal Picture\"  title=\"Click to enlarge\" width=\"37\" height=\"41\" /></a></DIV>";
            //}



            int tempTot = 1;
            //stQty += tempQty;
            stTot += tempTot;
        }

        if (e.Item.ItemType == ListItemType.Footer)
        {
            //stQty = 0;
            stTot = 0;
        }
    }
       
    protected void btnView_Click(object sender, EventArgs e)
    {
        try
        {
            trView.Visible = true;
            trViewSummary.Visible = false;
            trDetails.Visible = true;  
            BindData(txtFrom.Text, Convert.ToInt16(ddlLocation.SelectedValue), Convert.ToInt16(ddlFloor.SelectedValue), Convert.ToInt16(ddlTeaTiming.SelectedValue), ddlTeaUserType.SelectedValue);
        }
        catch (Exception ex)
        {
            lblMsg.Text = ex.Message.ToString();
        }
    }
    protected void btnViewSummary_Click(object sender, EventArgs e)
    {
        try
        {
            trView.Visible = false;
            trViewSummary.Visible = true;
            trDetails.Visible = true;           
            BindDataSummary(txtFrom.Text, Convert.ToInt16(ddlLocation.SelectedValue), Convert.ToInt16(ddlFloor.SelectedValue), Convert.ToInt16(ddlTeaTiming.SelectedValue), ddlTeaUserType.SelectedValue);
        }
        catch (Exception ex)
        {
            lblMsg.Text = ex.Message.ToString();
        }
    }
    

    protected void btnExportExcel_Click(object sender, EventArgs e)
    {
        try
        {
            //string fdate = Request["txtFrom"].ToString();
            //string tdate = Request["txtTo"].ToString();

            objDSExcel = BindDataForExcel(txtFrom.Text, ddlFloor.SelectedValue.ToString());

            if (objDSExcel != null && objDSExcel.Tables.Count > 0 && objDSExcel.Tables[0].Rows.Count > 0)
            {
                ExportToExcel(objDSExcel, "KioskOrdersByProduct");
            }
            else
            {
                ScriptManager.RegisterStartupScript(this, this.GetType(), "FoodOrderSummaryExport", "alert('No record found to export');", true);
            }

        }
        catch (Exception ex)
        {
            lblMsg.Text = ex.Message;
        }
    }

    private DataSet getData(string Date, int LocationId, int floorID, int TeaTimingId, string TeaUserType, bool IsSummary)
    {
        DBAccess objDB = new DBAccess();
        DataSet dsOrdersDetail = new DataSet();
        strSql = "EXEC Food_Select_TeaUserReport_bcktest @Date ='" + Date + "'" +
                         ",@DealOrderTimingId =" + TeaTimingId +
                         ",@FloorId =" + floorID +
                         ",@TeaUserType ='" + TeaUserType + "'" +
                         ",@LocationId =" + LocationId +
                         ",@IsSummary =" + IsSummary;
        // Response.Write(strSql);
        dsOrdersDetail = (DataSet)objDB.ExecuteQuery(strSql, ReturnType.DataSetType);
        return dsOrdersDetail;
    }
    private void BindData(string Date, int LocationId, int floorID, int TeaTimingId, string TeaUserType)
    {
        try
        {
            DataSet dsOrdersDetail = new DataSet();
            DataTable dtFloor = new DataTable();
            DataTable dtOrders = new DataTable();
            //DataTable dtDates = new DataTable();

            DataSet objDS = new DataSet();
            DBAccess objDB = new DBAccess();

            dsOrdersDetail = getData(Date, LocationId, floorID, TeaTimingId, TeaUserType,false);

            dtFloor = dsOrdersDetail.Tables[0].Copy();
            dtOrders = dsOrdersDetail.Tables[1].Copy();
            //dtDates = dsOrdersDetail.Tables[2].Copy();

            objDS.Tables.Add(dtFloor);
            objDS.Tables.Add(dtOrders);
            //objDS.Tables.Add(dtDates);

            DataRelation dr = new DataRelation("FloorAndOrders", dtFloor.Columns["floor_id"], dtOrders.Columns["floor_id"], true);
            dr.Nested = true;
            objDS.Relations.Add(dr);


            //DataColumn[] dcDates = new DataColumn[2];
            //dcDates[0] = dtDates.Columns["order_date"];
            //dcDates[1] = dtDates.Columns["floor_id"];

            //DataColumn[] dcOrders = new DataColumn[2];
            //dcOrders[0] = dtOrders.Columns["order_date"];
            //dcOrders[1] = dtOrders.Columns["floor_id"];


            ////DataRelation dr1 = new DataRelation("OrderDateAndOrders", dtDates.Columns["order_date"], dtOrders.Columns["order_date"], true);
            //DataRelation dr1 = new DataRelation("OrderDateAndOrders", dcDates, dcOrders, true);

            //dr1.Nested = true;
            //objDS.Relations.Add(dr1);
            rptFloor.DataSource = objDS;
            rptFloor.DataBind();

            txtFrom.Text = Date;
            lblServingTime.Text = Convert.ToDateTime(dsOrdersDetail.Tables[2].Rows[0]["ServingTime"]).ToString("MMM dd, yyyy hh:mm:ss tt");
            lblOrderStartTime.Text = Convert.ToDateTime(dsOrdersDetail.Tables[2].Rows[0]["OrderStartTime"]).ToString("MMM dd, yyyy hh:mm:ss tt");
            lblOrderEndTime.Text = Convert.ToDateTime(dsOrdersDetail.Tables[2].Rows[0]["OrderEndTime"]).ToString("MMM dd, yyyy hh:mm:ss tt");
        }

        catch (Exception ex)
        {
            lblMsg.Text = ex.Message;
        }
    }

    private void BindDataSummary(string Date, int LocationId, int floorID, int TeaTimingId, string TeaUserType)
    {
        try
        {
            DataSet dsOrdersDetail = new DataSet();
            DataTable dtFloor = new DataTable();
            DBAccess objDB = new DBAccess();

            dsOrdersDetail = getData(Date, LocationId, floorID, TeaTimingId, TeaUserType,true);

            dtFloor = dsOrdersDetail.Tables[0];
            rptFloorSummary.DataSource = dtFloor;
            rptFloorSummary.DataBind();
            txtFrom.Text = Date;

            lblServingTime.Text = Convert.ToDateTime(dsOrdersDetail.Tables[1].Rows[0]["ServingTime"]).ToString("MMM dd, yyyy hh:mm:ss tt");
            lblOrderStartTime.Text = Convert.ToDateTime(dsOrdersDetail.Tables[1].Rows[0]["OrderStartTime"]).ToString("MMM dd, yyyy hh:mm:ss tt");
            lblOrderEndTime.Text = Convert.ToDateTime(dsOrdersDetail.Tables[1].Rows[0]["OrderEndTime"]).ToString("MMM dd, yyyy hh:mm:ss tt");
        }
        catch (Exception ex)
        {
            lblMsg.Text = ex.Message;
        }
    }


    private void BindFloorType()
    {
        int LocationId = -1;
        switch (ddlLocation.SelectedValue)
        {
            case "1":
                LocationId = 2;
                break;
            case "1482":
                LocationId = 3;
                break;
            case "1486":
                LocationId = 4;
                break;
            default:
                LocationId = -1;
                break;
        }

        DBAccess objDB = new DBAccess();
        strSql = "EXEC XFD_Select_KioskFloor @LocationId=" + LocationId;

        DataSet dsFloor = (DataSet)objDB.ExecuteQuery(strSql, ReturnType.DataSetType);
        ddlFloor.DataSource = dsFloor;
        ddlFloor.DataValueField = "floor_ID";
        ddlFloor.DataTextField = "Description";
        ddlFloor.DataBind();
        ddlFloor.Items.Insert(0, new ListItem("--All--", "-1"));

    }
    private void BindTeaTiming()
    {
        DBAccess objDB = new DBAccess();
        strSql = "EXEC XFD_Select_TeaTiming";

        DataSet dsFloor = (DataSet)objDB.ExecuteQuery(strSql, ReturnType.DataSetType);
        ddlTeaTiming.DataSource = dsFloor;
        ddlTeaTiming.DataValueField = "DealOrderTimingId";
        ddlTeaTiming.DataTextField = "Name";
        ddlTeaTiming.DataBind();
        //ddlTeaTiming.Items.Insert(0, new ListItem("--All--", "-1"));

    }

    private DataSet BindDataForExcel(string FromDate, string floorID)
    {
        objDSExcel = new DataSet();
        try
        {
            objDB = new DBAccess();

            //strSql = "EXEC [Food_Select_KioskOrderByProductsExcel] " +
            //                  "@FromDate ='" + FromDate + "'" +
            //                  ",@ToDate ='" + ToDate + "', @FloorID=" + floorID + "";

            objDSExcel = (DataSet)objDB.ExecuteQuery(strSql, ReturnType.DataSetType);
        }
        catch (Exception ex)
        {
            lblMsg.Text = ex.Message;
        }

        return objDSExcel;
    }

    public void ExportToExcel(DataSet ds, string fname)
    {
        GridView gr = new GridView();
        gr.RowDataBound += new GridViewRowEventHandler(this.gr_RowDataBound);
        gr.DataSource = ds.Tables[0];
        gr.DataBind();
        ExportGridToExcel(gr, fname);
    }

    void gr_RowDataBound(Object sender, GridViewRowEventArgs e)
    {
        if (e.Row.RowType == DataControlRowType.Header)
        {
            e.Row.BackColor = System.Drawing.Color.Gray;
        }

        if (e.Row.RowType == DataControlRowType.DataRow)
        {
            // Display the company name in italics.
            //  e.Row.Cells[1].Width = Unit.Parse("60px");
            e.Row.Cells[0].Width = Unit.Parse("250px");
            e.Row.Cells[1].Width = Unit.Parse("300px");
            e.Row.Cells[2].Width = Unit.Parse("75px");
            e.Row.Cells[3].Width = Unit.Parse("75px");
            e.Row.Cells[4].Width = Unit.Parse("100px");


            if (e.Row.Cells[0].Text == null || e.Row.Cells[0].Text == "&nbsp;")
            {
                e.Row.Style[HtmlTextWriterStyle.FontWeight] = "bold";
                e.Row.Cells[3].Font.Bold = true;
                e.Row.Cells[3].Font.Size = FontUnit.Small;
            }
            else
            {
                e.Row.Font.Size = FontUnit.XSmall;
            }
        }
    }

    public static void ExportGridToExcel(GridView grdGridView, string fileName)
    {
        HttpContext.Current.Response.Clear();
        HttpContext.Current.Response.AddHeader("content-disposition", string.Format("attachment;filename={0}.xls", fileName));
        HttpContext.Current.Response.Charset = "";
        HttpContext.Current.Response.ContentType = "application/vnd.xls";

        StringWriter stringWrite = new StringWriter();
        HtmlTextWriter htmlWrite = new HtmlTextWriter(stringWrite);
        grdGridView.RenderControl(htmlWrite);
        HttpContext.Current.Response.Write(stringWrite.ToString());
        HttpContext.Current.Response.End();
    }

    //public void GetMinutes()
    //{
    //    for (int count = 0; count < 60; count++)
    //    {
    //        ddlMinutesFrom.Items.Insert(count, new ListItem(count.ToString("00"), count.ToString()));
    //        ddlMinutesTo.Items.Insert(count, new ListItem(count.ToString("00"), count.ToString()));
    //    }
    //    ddlMinutesFrom.SelectedValue = "00";
    //    ddlMinutesTo.SelectedValue = "59";
    //}

    //public void GetHours()
    //{
    //    for (int count = 0; count < 24; count++)
    //    {
    //        ddlHoursFrom.Items.Insert(count, new ListItem(count.ToString("00"), count.ToString()));
    //        ddlHoursTo.Items.Insert(count, new ListItem(count.ToString("00"), count.ToString()));
    //    }

    //    ddlHoursFrom.SelectedValue = "00";
    //    ddlHoursTo.SelectedValue = "23";
    //}
    protected void ddlLocation_SelectedIndexChanged(object sender, EventArgs e)
    {
        BindFloorType();
    }
}





